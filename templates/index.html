<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alshaya Enterprises Co-Estimate - AI-Powered BOQ Solutions</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a365d;
            --primary-dark: #0f1e3d;
            --secondary: #d4af37;
            --accent: #f4d03f;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --royal-blue: #1a365d;
            --gold: #d4af37;
            --white: #ffffff;
        }

        html {
            background: var(--primary-dark);
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-dark);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            margin: 0;
            padding: 0;
        }

        /* Ensure animated background is visible everywhere */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
            z-index: 0;
        }

        /* Animated Background */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background: var(--primary-dark);
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            animation: float 25s infinite ease-in-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.3;
            }

            25% {
                transform: translate(100px, -100px) rotate(90deg);
                opacity: 0.6;
            }

            50% {
                transform: translate(-80px, -200px) rotate(180deg);
                opacity: 0.4;
            }

            75% {
                transform: translate(-150px, -80px) rotate(270deg);
                opacity: 0.7;
            }
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
            position: relative;
            z-index: 10;
            background: transparent;
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        /* Header */
        header {
            text-align: center;
            color: #1a365d;
            padding: 60px 20px;
            animation: fadeInDown 1s ease;
            background: var(--primary-dark);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 4em;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            letter-spacing: -2px;
        }

        .logo-emoji {
            font-size: 1.2em;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .subtitle {
            font-size: 1.5em;
            font-weight: 300;
            opacity: 0.95;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.1em;
            opacity: 0.85;
            font-weight: 400;
        }

        /* Main Cards Grid */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 35px;
            padding: 40px 20px;
            perspective: 1500px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            padding: 45px 35px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 20px rgba(26, 54, 93, 0.08);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            transform-style: preserve-3d;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: none;
            transform: rotate(0deg);
        }

        .feature-card:hover::before {
            opacity: 0;
            transform: rotate(0deg);
        }

        .feature-card:hover {
            transform: none;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        }

        .card-icon {
            font-size: 5em;
            margin-bottom: 25px;
            display: block;
            transition: none;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
        }

        .feature-card:hover .card-icon {
            transform: none;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
        }

        .card-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--accent);
            color: #0f1419;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-title {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 18px;
            color: #1a365d;
        }

        .card-description {
            font-size: 1.05em;
            color: #64748b;
            line-height: 1.7;
            margin-bottom: 25px;
        }

        .card-features {
            list-style: none;
            margin-top: 25px;
        }

        .card-features li {
            padding: 10px 0;
            color: #475569;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            transition: none;
        }

        .card-features li:hover {
            transform: none;
            color: #475569;
        }

        .card-features li::before {
            content: 'âœ“';
            color: var(--success);
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 12px;
            display: inline-block;
            width: 25px;
            height: 25px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
        }

        .card-cta {
            margin-top: auto;
            padding: 14px 28px;
            background: #d4af37;
            color: #0f1419;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: none;
            width: 100%;
            position: relative;
            overflow: hidden;
            display: block;
            text-align: center;
            box-sizing: border-box;
        }

        .card-cta::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0);
            transition: none;
        }

        .card-cta:hover::before {
            left: -100%;
        }

        .card-cta:hover {
            transform: none;
            box-shadow: none;
        }

        /* Expanded Card View */
        .feature-card.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            border-radius: 0;
            padding: 0;
            transform: none;
            animation: expandCard 0.7s cubic-bezier(0.175, 0.885, 0.32, 1);
            overflow-y: auto;
        }

        @keyframes expandCard {
            from {
                transform: scale(0.2);
                opacity: 0.3;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Workflow Container */
        .workflow-container {
            display: none;
            min-height: 100vh;
            background: #d4af37;
        }

        .workflow-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .workflow-header {
            background: #d4af37;
            padding: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .workflow-title {
            font-size: 2.5em;
            font-weight: 800;
            color: #0f1419;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: #0f1419;
            font-size: 1.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: none;
            backdrop-filter: blur(10px);
        }

        .close-btn:hover {
            transform: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .workflow-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        /* Step Section */
        .step-section {
            background: rgba(26, 54, 93, 0.95);
            border-radius: 25px;
            padding: 50px;
            margin-bottom: 40px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.08);
            transition: none;
            border: 3px solid transparent;
        }

        .step-section:hover {
            border-color: transparent;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.08);
            transform: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 35px;
        }

        .step-number {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #d4af37;
            color: #0f1419;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: 800;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .step-title {
            font-size: 2em;
            font-weight: 700;
            color: #1a365d;
        }

        /* Upload Area */
        .upload-zone {
            border: 4px dashed #d1d5db;
            border-radius: 20px;
            padding: 100px 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #d4af37;
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.08) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
            border-radius: 50%;
        }

        .upload-zone:hover::before {
            width: 600px;
            height: 600px;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(26, 54, 93, 0.95);
            transform: scale(1.03);
            box-shadow: 0 20px 50px rgba(99, 102, 241, 0.2);
        }

        .upload-zone.drag-over {
            border-color: var(--secondary);
            background: #d4af37;
            transform: scale(1.05);
            box-shadow: 0 25px 60px rgba(139, 92, 246, 0.3);
        }

        .upload-icon {
            font-size: 6em;
            margin-bottom: 30px;
            display: inline-block;
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .upload-zone:hover .upload-icon {
            transform: translateY(-15px) scale(1.15);
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.15));
        }

        .upload-text {
            font-size: 1.8em;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .upload-subtext {
            font-size: 1.1em;
            color: #64748b;
            position: relative;
            z-index: 1;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 30px;
            padding: 25px;
            background: #d4af37;
            border-radius: 15px;
            border-left: 6px solid var(--success);
            animation: slideUp 0.5s ease;
            display: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 700;
            font-size: 1.2em;
            color: #065f46;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 220px;
            padding: 20px 40px;
            font-size: 1.15em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            color: #000000;
            background: #d4af37;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: none;
        }

        .btn:hover::before {
            width: 0;
            height: 0;
        }

        /* Unified button color scheme: yellow background, black text */
        .btn-primary,
        .btn-secondary,
        .btn-success,
        .btn-warning,
        .btn-danger,
        .btn-info {
            background: #d4af37;
            color: #000000;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-success:hover,
        .btn-warning:hover,
        .btn-danger:hover,
        .btn-info:hover {
            background: #d4af37;
            transform: none;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Loading Animation */
        .loading-overlay {
            display: none;
            text-align: center;
            padding: 80px 40px;
            background: #d4af37;
            border-radius: 20px;
            margin: 40px 0;
        }

        .loading-overlay.show {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .spinner-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 40px;
        }

        .spinner {
            border: 8px solid #f3f4f6;
            border-top: 8px solid var(--primary);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1.4em;
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 1em;
            color: #64748b;
        }

        /* Results Section */
        .results-section {
            background: rgba(26, 54, 93, 0.95);
            border-radius: 25px;
            padding: 50px;
            margin-top: 40px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.08);
            display: none;
        }

        .results-section.show {
            display: block;
            animation: slideUp 0.6s ease;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 3px solid #f3f4f6;
        }

        .results-title {
            font-size: 2.2em;
            font-weight: 800;
            color: #1a365d;
        }

        .preview-container {
            background: #f9fafb;
            border-radius: 15px;
            padding: 30px;
            max-height: 700px;
            overflow-y: auto;
        }

        .export-section {
            margin-top: 40px;
            padding: 30px;
            background: #d4af37;
            border-radius: 15px;
            border-left: 6px solid var(--warning);
        }

        .export-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #78350f;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 15px 30px;
            background: rgba(26, 54, 93, 0.95);
            color: #1a365d;
            border: 2px solid #d97706;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .export-btn:hover {
            background: #d97706;
            color: #0f1419;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.3);
        }

        /* Error Display */
        .error-message {
            background: #d4af37;
            color: #991b1b;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            border-left: 6px solid var(--danger);
            display: none;
            animation: shake 0.6s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-10px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(10px);
            }
        }

        .error-message.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.8em;
            }

            .cards-container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .feature-card {
                padding: 30px 20px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                margin: 0;
            }

            .workflow-content {
                padding: 40px 20px;
            }

            .step-section {
                padding: 30px 20px;
            }

            .upload-zone {
                padding: 60px 25px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                min-width: 100%;
            }

            /* Hero Section Mobile Styles - Simplified */
            .hero-section {
                min-height: auto;
                padding: 0;
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            .hero-split-container {
                grid-template-columns: 1fr;
                grid-template-areas: "text";
                padding: clamp(30px, 6vw, 40px) clamp(15px, 4vw, 15px) clamp(20px, 4vw, 20px);
                gap: clamp(20px, 4vw, 20px);
            }

            /* Ensure desktop carousel is hidden on mobile */
            .hero-split-container .hero-carousel-desktop {
                display: none;
            }

            .hero-content {
                width: 100%;
                max-width: 100%;
            }

            .hero-cards-container {
                padding: 0 clamp(15px, 4vw, 15px) clamp(20px, 4vw, 20px);
            }

            .hero-header {
                margin-bottom: 30px;
                text-align: center;
            }

            .company-logo {
                justify-content: center;
            }

            .company-logo .logo-main {
                max-width: 280px;
            }

            .hero-app-name {
                font-size: 2em;
                text-align: center;
                margin-bottom: 15px;
            }

            .hero-platform-desc {
                font-size: 1em;
                text-align: center;
                margin: 0 auto 20px;
                line-height: 1.5;
            }

            .hero-ai-badge {
                margin: 0 auto 25px;
            }

            .hero-cards-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
                padding: 0 5px;
                width: 100%;
                max-width: 100%;
            }

            .hero-cards-grid .hero-card {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 auto 15px auto !important;
                display: block !important;
                float: none !important;
            }

            .hero-card {
                padding: 25px 18px !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                margin: 0 0 15px 0 !important;
                display: block !important;
                float: none !important;
                flex: none !important;
                clear: both !important;
                grid-column: 1 / -1 !important;
                grid-row: auto !important;
            }

            /* Force all cards to stack in single column */
            .hero-cards-grid>* {
                grid-column: 1 !important;
            }

            .hero-card-icon {
                width: 60px;
                height: 60px;
                margin-bottom: 20px;
            }

            .hero-card-title {
                font-size: 1.4em;
            }

            .hero-card-desc {
                font-size: 0.95em;
            }

            .hero-card-arrow {
                width: 40px;
                height: 40px;
                bottom: 25px;
                right: 25px;
                font-size: 1.2em;
            }

            .hero-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 25px;
                padding: 30px 15px;
            }

            .stat-number {
                font-size: 2.2em;
            }

            .stat-number.infinity {
                font-size: 8em;
                line-height: 0.8;
            }

            .stat-label {
                font-size: 0.95em;
            }

            .floating-shape {
                display: none;
            }

            /* Workflow Section Mobile Styles */
            .workflow-section {
                padding: 60px 15px 40px;
            }

            .workflow-title h2 {
                font-size: 2.2em;
            }

            .workflow-subtitle {
                font-size: 1.05em;
                margin-bottom: 40px;
            }

            .workflow-steps {
                gap: 25px;
                margin-top: 40px;
            }

            .workflow-step {
                padding: 30px 20px;
                flex-direction: column;
                text-align: center;
            }

            .workflow-step-icon {
                width: 70px;
                height: 70px;
                margin-bottom: 20px;
            }

            .workflow-step-title {
                font-size: 1.3em;
            }

            .workflow-step-desc {
                font-size: 0.95em;
            }
        }

        /* Extra Small Mobile Devices (below 480px) */
        @media (max-width: 480px) {
            .hero-section {
                grid-template-areas:
                    "content"
                    "cards"
                    "carousel";
            }

            .hero-split-container {
                padding: 25px 10px 15px;
                gap: 15px;
            }

            .hero-carousel-mobile {
                height: 220px;
                min-height: 180px;
                border-radius: 15px;
                padding: 0 10px 20px;
            }

            .hero-cards-container {
                padding: 0 10px 15px;
            }

            .hero-cards-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 0;
                margin-bottom: 15px;
                width: 100%;
                max-width: 100%;
            }

            .hero-cards-grid .hero-card {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 auto !important;
                grid-column: 1 !important;
            }

            .hero-card {
                padding: 20px 15px !important;
                grid-column: 1 !important;
                width: 100% !important;
            }

            /* Force all cards to be in single column - additional safety */
            .hero-cards-grid .hero-card:nth-child(1),
            .hero-cards-grid .hero-card:nth-child(2),
            .hero-cards-grid .hero-card:nth-child(3),
            .hero-cards-grid .hero-card:nth-child(4) {
                grid-column: 1 !important;
                grid-row: auto !important;
                width: 100% !important;
                float: none !important;
                display: block !important;
            }

            .hero-card-title {
                font-size: 1.15em;
            }

            .hero-card-desc {
                font-size: 0.85em;
            }

            .hero-app-name {
                font-size: 1.7em;
            }

            .hero-platform-desc {
                font-size: 0.95em;
            }

            .cards-container {
                padding: 15px 10px;
                gap: 15px;
            }

            .feature-card {
                padding: 25px 15px;
            }

            .card-title {
                font-size: 1.3em;
            }

            .card-description {
                font-size: 0.9em;
            }

            h1 {
                font-size: 2.2em;
            }
        }

        /* Ensure no horizontal overflow on mobile */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            .container {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            .hero-split-container {
                overflow-x: hidden;
            }

            * {
                max-width: 100%;
            }

            img,
            video,
            iframe {
                max-width: 100%;
                height: auto;
            }
        }

        /* Main App Navigation Bar */
        .app-nav-bar {
            background: rgba(26, 54, 93, 0.85);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.4s ease;
        }

        .app-nav-bar.scrolled {
            padding: 8px 20px;
            background: rgba(26, 54, 93, 0.95);
        }

        .app-nav-bar:hover {
            opacity: 1 !important;
        }

        .nav-home-btn {
            background: #d4af37;
            color: #000000;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .app-nav-bar.scrolled .nav-home-btn {
            padding: 8px 20px;
            font-size: 0.85em;
        }

        .nav-home-btn:hover {
            background: #e8c55a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .app-logo {
            max-width: 250px;
            height: auto;
            filter: drop-shadow(0 2px 8px rgba(255, 255, 255, 0.2));
            transition: all 0.4s ease;
        }

        .app-nav-bar.scrolled .app-logo {
            max-width: 150px;
        }

        /* Main App Upload Area Styles */
        .main-app-container {
            background: transparent;
            min-height: 100vh;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: transparent;
            min-height: 100vh;
            position: relative;
            z-index: 10;
        }

        .card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0) 60%);
            transition: none;
        }

        .card:hover::before {
            left: -100%;
        }

        .card:hover {
            transform: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .card h2 {
            font-size: 1.8em;
            color: #1a365d;
            margin-bottom: 25px;
            font-weight: 700;
        }

        .upload-area {
            border: 3px dashed #5b7a9e;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1);
            background: linear-gradient(135deg, #e8eef5 0%, #d4dce8 100%);
            position: relative;
            overflow: hidden;
        }

        /* Hero Section Styles - Dynamic Responsive Grid */
        .hero-section {
            min-height: auto;
            display: grid;
            grid-template-areas:
                "content"
                "cards"
                "carousel";
            background: transparent;
            position: relative;
            z-index: 10;
            grid-template-rows: auto auto auto;
            grid-template-columns: 1fr;
            padding: 0;
            position: relative;
            background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 50%, #1a365d 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            z-index: 10;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        /* Hero Split Container - Dynamic Responsive Layout */
        .hero-split-container {
            grid-area: content;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-areas: "text" "carousel";
            gap: clamp(20px, 4vw, 60px);
            padding: clamp(30px, 6vw, 100px) clamp(15px, 4vw, 40px);
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
        }

        /* Desktop: Side by side layout */
        @media (min-width: 769px) {
            .hero-split-container {
                grid-template-columns: 1fr 1.5fr;
                grid-template-areas: "text carousel";
                align-items: center;
            }

            .hero-section {
                grid-template-areas:
                    "content"
                    "cards"
                    "carousel";
            }
        }

        /* Large desktop: More spacing */
        @media (min-width: 1200px) {
            .hero-split-container {
                gap: clamp(40px, 5vw, 80px);
            }
        }

        /* Floating Decorative Elements */
        .floating-shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.15);
            animation: float 20s infinite ease-in-out;
            z-index: 1;
            filter: blur(40px);
        }

        .floating-shape:nth-child(1) {
            width: 400px;
            height: 400px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .floating-shape:nth-child(2) {
            width: 300px;
            height: 300px;
            bottom: 20%;
            right: 10%;
            animation-delay: 5s;
        }

        .floating-shape:nth-child(3) {
            width: 250px;
            height: 250px;
            top: 50%;
            left: 15%;
            animation-delay: 10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.4;
            }

            33% {
                transform: translate(30px, -30px) scale(1.1);
                opacity: 0.6;
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
                opacity: 0.5;
            }
        }

        /* Hero Content - Responsive */
        .hero-content {
            grid-area: text;
            width: 100%;
            max-width: 100%;
            padding: 0;
            position: relative;
            z-index: 2;
        }

        @media (min-width: 769px) {
            .hero-content {
                max-width: 100%;
            }
        }

        .hero-cards-container {
            grid-area: cards;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 clamp(15px, 4vw, 40px) clamp(30px, 5vw, 60px);
            position: relative;
            z-index: 2;
        }

        /* Hero Image Carousel - Responsive */
        .hero-image-carousel {
            position: relative;
            overflow: hidden;
            border-radius: clamp(15px, 3vw, 20px);
            box-shadow: 0 clamp(10px, 2vw, 20px) clamp(30px, 5vw, 60px) rgba(0, 0, 0, 0.3);
            z-index: 1;
            width: 100%;
        }

        /* Desktop carousel - inside split container */
        .hero-carousel-desktop {
            grid-area: carousel;
            height: clamp(400px, 50vh, 600px);
            max-height: 80vh;
            display: none;
        }

        /* Mobile carousel - separate grid area */
        .hero-carousel-mobile {
            grid-area: carousel;
            height: clamp(220px, 40vh, 300px);
            display: block;
            margin: 0 auto;
            width: calc(100% - clamp(20px, 5vw, 30px));
            padding: 0 clamp(10px, 3vw, 15px);
        }

        /* Desktop: Show desktop carousel, hide mobile */
        @media (min-width: 769px) {
            .hero-carousel-desktop {
                display: block;
                min-width: 0;
            }

            .hero-carousel-mobile {
                display: none;
            }
        }

        /* Mobile: Hide desktop carousel */
        @media (max-width: 768px) {
            .hero-split-container .hero-carousel-desktop {
                display: none !important;
            }

            .hero-section {
                grid-template-areas:
                    "content"
                    "cards"
                    "carousel";
            }
        }

        .hero-image-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 20px;
        }

        .hero-image-slide.active {
            opacity: 1;
            z-index: 1;
        }

        /* Workflow Section */
        .workflow-section {
            padding: 100px 40px 60px;
            background: var(--primary-dark);
            position: relative;
            z-index: 10;
        }

        .workflow-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .workflow-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .workflow-title h2 {
            font-size: 3em;
            font-weight: 800;
            color: #1a365d;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .workflow-subtitle {
            font-size: 1.2em;
            color: #64748b;
            max-width: 800px;
            margin: 0 auto 60px;
            line-height: 1.6;
        }

        .workflow-steps {
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative;
            margin-top: 60px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .workflow-step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px 50px;
            display: flex;
            align-items: center;
            gap: 30px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
            text-align: left;
        }

        .workflow-step:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(26, 54, 93, 0.15);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .workflow-step-content {
            flex: 1;
        }

        .workflow-step-icon {
            width: 80px;
            height: 80px;
            min-width: 80px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }

        .workflow-step:hover .workflow-step-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.4);
        }

        .workflow-step-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 2.5;
        }

        .workflow-step-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 12px;
        }

        .workflow-step-desc {
            font-size: 1em;
            color: #64748b;
            line-height: 1.7;
            margin: 0;
        }

        .workflow-step-number {
            font-size: 0.9em;
            font-weight: 600;
            color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
            padding: 6px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 15px;
        }

        .workflow-connector {
            position: absolute;
            left: 50%;
            bottom: -15px;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background: linear-gradient(180deg, #e2e8f0 0%, transparent 100%);
            z-index: 0;
        }

        .workflow-step:last-child .workflow-connector {
            display: none;
        }

        @media (max-width: 768px) {
            .workflow-connector {
                display: none;
            }

            .workflow-step {
                flex-direction: column;
                text-align: center;
                padding: 30px 25px;
            }

            .workflow-step-icon {
                margin-bottom: 20px;
            }
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            width: 100%;
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-header {
            text-align: left;
            margin-bottom: 50px;
            position: relative;
        }

        .company-logo {
            margin-bottom: 30px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .company-logo .logo-main {
            max-width: 450px;
            height: auto;
            filter: drop-shadow(0 4px 20px rgba(212, 175, 55, 0.3));
            transition: transform 0.3s ease;
        }

        .company-logo .logo-main:hover {
            transform: scale(1.05);
        }

        .hero-app-name {
            font-size: 3.5em;
            font-weight: 800;
            margin-bottom: 20px;
            letter-spacing: -1px;
            line-height: 1.2;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .hero-app-name .transform-text {
            color: #3b82f6;
        }

        .hero-app-name .workflow-text {
            color: #ec4899;
        }

        .hero-platform-desc {
            font-size: 1.2em;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.7;
            max-width: 600px;
            margin: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .hero-ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .hero-ai-badge svg {
            width: 16px;
            height: 16px;
            stroke: white;
            stroke-width: 2.5;
        }

        .hero-title {
            font-size: 2.8em;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            line-height: 1.2;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
        }

        .hero-subtitle {
            font-size: 1.2em;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 10px;
        }

        .hero-description {
            font-size: 1em;
            color: #64748b;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Hero Cards Grid - Dynamic Responsive Design */
        .hero-cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: clamp(15px, 3vw, 30px);
            margin-bottom: clamp(30px, 5vw, 60px);
            max-width: 100%;
            animation: fadeInUp 1.2s ease-out 0.2s both;
            padding: 0 clamp(10px, 2vw, 20px);
        }

        /* Tablet: 2 columns */
        @media (min-width: 600px) {
            .hero-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Desktop: 4 columns */
        @media (min-width: 992px) {
            .hero-cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Large Desktop: Better spacing */
        @media (min-width: 1400px) {
            .hero-cards-grid {
                gap: 40px;
            }
        }

        .hero-card {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: clamp(16px, 3vw, 24px);
            padding: clamp(25px, 4vw, 45px) clamp(18px, 3vw, 35px);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            width: 100%;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .hero-card:hover::before {
            left: 100%;
        }

        .hero-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .hero-card-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 28px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(26, 54, 93, 0.3);
        }

        .hero-card:hover .hero-card-icon {
            transform: rotate(5deg) scale(1.1);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.4);
        }

        .hero-card-icon svg {
            width: 36px;
            height: 36px;
            stroke: #d4af37;
            stroke-width: 2.5;
            transition: all 0.3s ease;
        }

        .hero-card:hover .hero-card-icon svg {
            stroke: #f4d03f;
            transform: scale(1.1);
        }

        .hero-card-title {
            font-size: 1.6em;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 16px;
            transition: color 0.3s ease;
        }

        .hero-card:hover .hero-card-title {
            color: #2d4a7c;
        }

        .hero-card-desc {
            font-size: 1.05em;
            color: #64748b;
            line-height: 1.7;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .hero-card:hover .hero-card-desc {
            color: #475569;
        }

        /* Floating Decorative Elements */
        .floating-shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.1);
            animation: floatShape 20s infinite ease-in-out;
            pointer-events: none;
            z-index: 0;
        }

        .floating-shape:nth-child(1) {
            width: 200px;
            height: 200px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .floating-shape:nth-child(2) {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 10%;
            animation-delay: 5s;
        }

        .floating-shape:nth-child(3) {
            width: 100px;
            height: 100px;
            bottom: 20%;
            left: 15%;
            animation-delay: 10s;
        }

        @keyframes floatShape {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.3;
            }

            33% {
                transform: translate(30px, -30px) rotate(120deg);
                opacity: 0.5;
            }

            66% {
                transform: translate(-20px, 20px) rotate(240deg);
                opacity: 0.4;
            }
        }

        /* Stats/Features Section */
        .hero-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            padding: 40px 20px;
            background: rgba(26, 54, 93, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-item {
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-number {
            font-size: 3em;
            font-weight: 800;
            color: #d4af37;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .stat-number.infinity {
            font-size: 12em;
            line-height: 0.8;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            font-weight: 500;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .hero-card-arrow {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            color: #1a365d;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .hero-card:hover .hero-card-arrow {
            transform: translateX(5px) scale(1.1);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
            background: linear-gradient(135deg, #f4d03f 0%, #d4af37 100%);
        }

        @keyframes badgePulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px 10px rgba(212, 175, 55, 0);
            }
        }

        .badge-icon {
            font-size: 1.3em;
            animation: badgeIconSpin 4s linear infinite;
        }

        @keyframes badgeIconSpin {

            0%,
            90% {
                transform: rotate(0deg);
            }

            95%,
            100% {
                transform: rotate(360deg);
            }
        }

        .badge-text {
            font-weight: 700;
            font-size: 0.95em;
            background: #d4af37;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        }

        /* Hero Layout Structure - FORCED VERTICAL STACK */
        #heroSection {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            position: relative;
            overflow: hidden;
            padding-top: 40px;
        }

        .hero-split-container {
            display: flex !important;
            flex-direction: column !important;
            /* Vertical stack on all screens */
            align-items: center !important;
            justify-content: center !important;
            gap: 40px !important;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 40px !important;
            width: 100% !important;
            position: relative;
            z-index: 2;
            text-align: center !important;
        }

        .hero-content {
            width: 100% !important;
            max-width: 800px !important;
            z-index: 2;
            order: 1 !important;
            /* Logo/Title First */
        }

        /* Show Desktop Carousel on ALL screens, resized */
        .hero-image-carousel.hero-carousel-desktop {
            display: block !important;
            width: 100% !important;
            max-width: 1000px !important;
            height: 400px !important;
            position: relative;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(212, 175, 55, 0.2);
            order: 2 !important;
            /* Carousel Second */
            margin: 0 auto !important;
        }

        /* Hide Mobile Carousel completely to avoid duplication/layout issues */
        .hero-carousel-mobile {
            display: none !important;
        }

        .hero-image-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .hero-image-slide.active {
            opacity: 1;
        }

        /* Hero Cards Grid */
        .hero-cards-container {
            padding: 0 20px 80px !important;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            width: 100% !important;
            order: 3 !important;
            /* Cards Third */
        }

        .hero-cards-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
            gap: 30px !important;
            width: 100% !important;
        }

        .hero-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 300px;
        }

        .hero-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: #d4af37;
        }

        .hero-card-icon {
            width: 50px;
            height: 50px;
            background: #1a365d;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: #d4af37;
            margin-left: auto;
            margin-right: auto;
            /* Center icon */
        }

        .hero-card-icon svg {
            width: 24px;
            height: 24px;
        }

        .hero-card-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 10px;
            text-align: center;
        }

        .hero-card-desc {
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 20px;
            flex-grow: 1;
            text-align: center;
        }

        .hero-card-arrow {
            margin: 0 auto;
            /* Center arrow */
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .hero-image-carousel.hero-carousel-desktop {
                height: 300px !important;
            }

            .hero-cards-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5em;
            }

            .hero-image-carousel.hero-carousel-desktop {
                height: 250px !important;
            }

            .hero-cards-grid {
                grid-template-columns: 1fr !important;
            }

            .hero-split-container {
                padding: 0 10px 30px !important;
            }
        }

        .hero-title {
            font-size: 4em;
            font-weight: 900;
            margin-bottom: 20px;
            background: #d4af37;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            animation: titleFadeIn 1s ease-out;
        }

        @keyframes titleFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-subtitle {
            font-size: 2em;
            font-weight: 700;
            color: #f4d03f;
            margin-bottom: 25px;
            animation: subtitleFadeIn 1s ease-out 0.2s both;
        }

        @keyframes subtitleFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-description {
            font-size: 1.2em;
            color: #64748b;
            line-height: 1.8;
            max-width: 900px;
            margin: 0 auto 50px;
            animation: descFadeIn 1s ease-out 0.4s both;
        }

        @keyframes descFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .hero-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
            animation: featuresFadeIn 1s ease-out 0.6s both;
        }

        @keyframes featuresFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-feature-item {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 30px;
            background: rgba(26, 54, 93, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: left;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hero-feature-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .feature-icon {
            font-size: 3em;
            flex-shrink: 0;
        }

        .feature-text strong {
            display: block;
            font-size: 1.3em;
            color: #d4af37;
            margin-bottom: 8px;
        }

        .feature-text p {
            color: #64748b;
            font-size: 1em;
            line-height: 1.6;
            margin: 0;
        }

        .hero-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .hero-image-card {
            aspect-ratio: 16/9;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: #d4af37;
            border: 2px solid rgba(212, 175, 55, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: imageCardFadeIn 1s ease-out both;
        }

        @keyframes imageCardFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .hero-image-card:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 25px 70px rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: #d4af37;
            color: white;
        }

        .placeholder-icon {
            font-size: 4em;
            margin-bottom: 15px;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
        }

        .image-placeholder p {
            font-size: 1.2em;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        .hero-cta {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 20px 50px;
            font-size: 1.3em;
            font-weight: 700;
            background: #d4af37;
            color: #0f1419;
            border: none;
            border-radius: 60px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.4);
            position: relative;
            overflow: hidden;
            animation: ctaFadeIn 1s ease-out 0.8s both;
        }

        @keyframes ctaFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-cta::before {
            content: '';
            position: absolute;
            inset: 0;
            background: #d4af37;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .hero-cta:hover::before {
            opacity: 1;
        }

        .hero-cta:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.5);
        }

        .hero-cta:active {
            transform: translateY(-2px) scale(1.02);
        }

        .cta-icon,
        .cta-text,
        .cta-arrow {
            position: relative;
            z-index: 1;
        }

        .cta-arrow {
            transition: transform 0.4s ease;
            font-size: 1.2em;
        }

        .hero-cta:hover .cta-arrow {
            transform: translateX(8px);
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 80px;
            margin-top: 60px;
            animation: statsFadeIn 1s ease-out 1s both;
            flex-wrap: wrap;
        }

        @keyframes statsFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-number {
            font-size: 3.5em;
            font-weight: 900;
            background: #d4af37;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-number.infinity {
            font-size: 14em;
            line-height: 0.8;
        }

        .stat-label {
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #4a6fa5 0%, #2e5984 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .upload-area:hover::before {
            opacity: 0.15;
        }

        .upload-area:hover {
            border-color: #3d5a80;
            transform: scale(1.02);
            box-shadow: 0 15px 50px rgba(61, 90, 128, 0.25);
        }

        .upload-area.dragover {
            border-color: #2e5984;
            background: linear-gradient(135deg, #c5d5ea 0%, #a8bdd8 100%);
            transform: scale(1.05);
            box-shadow: 0 20px 60px rgba(46, 89, 132, 0.35);
        }
        
        .upload-area.uploading {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .upload-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .upload-text {
            font-size: 1.6em;
            font-weight: 700;
            color: #2e5984;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #64748b;
            font-size: 1.05em;
            font-weight: 500;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: linear-gradient(90deg, rgba(26, 54, 93, 0.3) 0%, rgba(26, 54, 93, 0.5) 100%);
            border-radius: 20px;
            margin-top: 25px;
            overflow: hidden;
            display: none;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3), 0 4px 20px rgba(212, 175, 55, 0.2);
            border: 2px solid rgba(212, 175, 55, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37 0%, #f4d03f 50%, #d4af37 100%);
            background-size: 200% 100%;
            border-radius: 18px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0f1419;
            font-size: 0.9em;
            font-weight: 700;
            position: relative;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8), inset 0 2px 10px rgba(255, 255, 255, 0.3);
            animation: progressShimmer 2s linear infinite, progressPulse 1.5s ease-in-out infinite;
        }

        @keyframes progressShimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @keyframes progressPulse {

            0%,
            100% {
                box-shadow: 0 0 30px rgba(212, 175, 55, 0.8), inset 0 2px 10px rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 50px rgba(212, 175, 55, 1), inset 0 2px 10px rgba(255, 255, 255, 0.5);
            }
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, transparent 100%);
            border-radius: 18px 18px 0 0;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.6) 50%, transparent 100%);
            animation: progressSweep 1.5s ease-in-out infinite;
        }

        @keyframes progressSweep {
            0% {
                right: 100%;
            }

            100% {
                right: -40px;
            }
        }

        .progress-text {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .progress-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(15, 20, 25, 0.3);
            border-top-color: #0f1419;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .file-list {
            min-height: 100px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .file-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 247, 250, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            animation: fileItemFadeIn 0.5s ease-out;
        }

        @keyframes fileItemFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #d4af37 0%, #f4d03f 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .file-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(212, 175, 55, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .file-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(212, 175, 55, 0.25);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .file-item:hover::before {
            width: 10px;
        }

        .file-item:hover::after {
            opacity: 1;
        }

        .file-info {
            flex: 1;
            padding-right: 0;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.2);
            min-width: 0;
        }

        .file-name {
            font-weight: 800;
            font-size: 1.4em;
            color: #1a365d;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            line-height: 1.4;
            min-height: 40px;
        }

        .file-name::before {
            content: 'ðŸ“„';
            font-size: 1.5em;
            animation: iconFloat 3s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes iconFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .file-name-text {
            flex: 1;
            word-break: break-word;
            color: #1a365d;
            font-size: 1em;
            font-weight: 800;
            min-height: 24px;
            display: inline-block;
            background: rgba(212, 175, 55, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .file-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .file-size {
            font-size: 0.85em;
            color: #64748b;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-size::before {
            content: 'ðŸ’¾';
            font-size: 1.1em;
        }

        .file-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.1) 0%, rgba(100, 116, 139, 0.2) 100%);
            color: #64748b;
            border: 1px solid rgba(100, 116, 139, 0.2);
            transition: all 0.3s ease;
        }

        .file-status.status-uploaded {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.2) 100%);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .file-status.status-extracted {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .file-status.status-processing {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.2) 100%);
            color: #92400e;
            border-color: rgba(245, 158, 11, 0.3);
            animation: statusPulse 2s ease-in-out infinite;
            font-weight: 700;
        }

        @keyframes statusPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
            }
        }

        .file-status::before {
            content: 'âš¡';
            font-size: 1.1em;
        }

        .file-status.status-uploaded::before {
            content: 'ðŸ“¤';
        }

        .file-status.status-extracted::before {
            content: 'âœ…';
        }

        .file-status.status-processing::before {
            content: 'âš™ï¸';
            animation: spin 2s linear infinite;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
            padding-top: 5px;
        }

        .action-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: #0f1419;
            background: #d4af37;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            min-width: 200px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 48px;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .action-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .action-btn>* {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: #d4af37;
        }

        .btn-success {
            background: #d4af37;
        }

        .btn-info {
            background: #d4af37;
        }

        .btn-danger {
            background: #d4af37;
        }

        .btn-warning {
            background: #d4af37;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: #0f1419;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            min-width: 180px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #d4af37;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn>* {
            position: relative;
            z-index: 1;
        }

        .costing-card {
            background: #d4af37;
            border-radius: 16px;
            padding: 30px;
        }

        .factor-control {
            margin-bottom: 25px;
        }

        .factor-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #475569;
        }

        .factor-value {
            color: #1a365d;
            font-size: 1.2em;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 10px;
            background: #d4af37;
            outline: none;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .costing-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .costing-actions .btn-primary {
            background: #1a365d;
            color: #ffffff;
            border: 2px solid #1a365d;
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .costing-actions .btn-primary:hover {
            background: #2d5a8e;
            border-color: #2d5a8e;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 54, 93, 0.4);
        }

        .costing-actions .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(26, 54, 93, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: rgba(26, 54, 93, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1);
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2.5em;
            color: #ffffff;
            background: rgba(239, 68, 68, 0.9);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10001;
            line-height: 1;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .modal-close:hover {
            transform: rotate(90deg) scale(1.1);
            background: rgba(239, 68, 68, 1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* Value Engineering Modal Styles */
        .ve-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            overflow-y: auto;
            backdrop-filter: blur(8px);
        }

        .ve-modal-content {
            background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
            border-radius: 20px;
            max-width: 1400px;
            margin: 40px auto;
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1);
        }

        .ve-modal-header {
            padding: 30px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ve-modal-header h2 {
            color: #ffffff;
            font-size: 1.8em;
            margin: 0;
        }

        .ve-modal-close {
            font-size: 2.5em;
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s ease;
            background: none;
            border: none;
        }

        .ve-modal-close:hover {
            transform: rotate(90deg) scale(1.2);
            color: #ef4444;
        }

        .ve-modal-body {
            padding: 30px;
        }

        .ve-modal-footer {
            padding: 20px 30px;
            border-top: 2px solid rgba(212, 175, 55, 0.3);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Budget Tier Tabs */
        .ve-tier-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .ve-tier-tab {
            flex: 1;
            min-width: 200px;
            padding: 18px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            color: #ffffff;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ve-tier-tab:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            transform: translateY(-2px);
        }

        .ve-tier-tab.active {
            background: #d4af37;
            border-color: #d4af37;
            color: #1a365d;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
        }

        /* Summary Card */
        .ve-summary-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .ve-summary-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ve-summary-label {
            font-size: 0.9em;
            color: #64748b;
            font-weight: 500;
        }

        .ve-summary-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #1a365d;
        }

        .ve-new-total {
            color: #d4af37;
        }

        .ve-savings {
            color: #10b981 !important;
        }

        .ve-increase {
            color: #ef4444 !important;
        }

        /* Items List */
        .ve-items-list {
            overflow-x: auto;
        }

        .ve-table-wrapper {
            width: 100%;
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .ve-comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .ve-comparison-table thead {
            background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .ve-comparison-table th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 3px solid #d4af37;
            white-space: nowrap;
        }

        .ve-comparison-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s ease;
        }

        .ve-comparison-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .ve-comparison-table td {
            padding: 12px 10px;
            vertical-align: top;
            color: #1a365d;
        }

        .ve-col-no {
            width: 40px;
            text-align: center;
        }

        .ve-col-image {
            width: 80px;
        }

        .ve-col-original {
            min-width: 250px;
            max-width: 350px;
        }

        .ve-col-qty {
            width: 60px;
            text-align: center;
        }

        .ve-col-unit {
            width: 60px;
        }

        .ve-col-rate {
            width: 100px;
            text-align: right;
        }

        .ve-col-total {
            width: 120px;
            text-align: right;
        }

        .ve-col-alternative {
            min-width: 280px;
            max-width: 350px;
        }

        .ve-col-alt-image {
            width: 80px;
        }

        .ve-col-alt-rate {
            width: 100px;
            text-align: right;
        }

        .ve-col-alt-total {
            width: 120px;
            text-align: right;
        }

        .ve-col-difference {
            width: 130px;
            text-align: right;
        }

        .ve-cell-no {
            text-align: center;
            font-weight: 700;
            color: #64748b;
        }

        .ve-cell-image,
        .ve-cell-alt-image {
            text-align: center;
        }

        .ve-original-image-placeholder,
        .ve-alt-image-empty {
            width: 60px;
            height: 60px;
            background: rgba(26, 54, 93, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto;
        }

        .ve-alt-image-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            position: relative;
        }

        .ve-product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .ve-alt-image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 2em;
            font-weight: 700;
        }

        .ve-item-desc-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ve-category-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: fit-content;
        }

        .ve-desc-text {
            font-size: 0.95em;
            line-height: 1.4;
            color: #1a365d;
        }

        .ve-cell-qty,
        .ve-cell-unit {
            text-align: center;
            font-weight: 500;
        }

        .ve-cell-rate,
        .ve-cell-total,
        .ve-cell-alt-rate,
        .ve-cell-alt-total {
            text-align: right;
            font-weight: 600;
        }

        .ve-original-total {
            color: #d4af37;
            font-weight: 700;
        }

        .ve-inline-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
            color: #1a365d;
            background: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ve-inline-select:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .ve-inline-specs {
            margin-top: 12px;
            padding: 12px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 8px;
            border-left: 3px solid #d4af37;
        }

        .ve-specs-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ve-specs-content strong {
            color: #1a365d;
            font-size: 0.95em;
        }

        .ve-country-tag {
            display: inline-block;
            background: rgba(26, 54, 93, 0.1);
            color: #1a365d;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            width: fit-content;
        }

        .ve-specs-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ve-specs-list li {
            font-size: 0.85em;
            color: #64748b;
        }

        .ve-meta-info {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            color: #64748b;
        }

        .ve-meta-info a {
            color: #d4af37;
            text-decoration: none;
            font-weight: 600;
        }

        .ve-meta-info a:hover {
            text-decoration: underline;
        }

        .ve-diff-value {
            display: inline-flex;
            flex-direction: column;
            align-items: flex-end;
            font-weight: 700;
        }

        .ve-diff-value small {
            font-size: 0.85em;
            font-weight: 500;
            opacity: 0.8;
        }

        .ve-loading {
            text-align: center;
            padding: 40px;
            color: #ffffff;
            font-size: 1.2em;
        }

        .ve-empty {
            text-align: center;
            padding: 40px;
            color: #ffffff;
            font-size: 1.1em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .ve-modal-content {
                margin: 20px;
                border-radius: 16px;
            }

            .ve-tier-tabs {
                flex-direction: column;
            }

            .ve-tier-tab {
                min-width: 100%;
            }

            .ve-summary-card {
                grid-template-columns: 1fr;
            }

            .ve-comparison-table {
                font-size: 0.8em;
            }

            .ve-comparison-table th,
            .ve-comparison-table td {
                padding: 8px 6px;
            }

            .ve-col-original {
                min-width: 180px;
            }

            .ve-col-alternative {
                min-width: 200px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #d4af37;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Upload notification banner */
        .upload-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.98) 0%, rgba(45, 74, 124, 0.98) 100%);
            backdrop-filter: blur(20px);
            color: white;
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(212, 175, 55, 0.3);
            z-index: 10000;
            display: none;
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid #d4af37;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .upload-notification.show {
            display: block;
        }

        .upload-notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .upload-notification-icon {
            font-size: 2em;
            animation: iconBounce 0.6s ease;
        }

        @keyframes iconBounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        .upload-notification-text {
            flex: 1;
        }

        .upload-notification-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .upload-notification-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .extraction-preview {
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            box-shadow:
                inset 0 2px 8px rgba(0, 0, 0, 0.3),
                0 4px 20px rgba(212, 175, 55, 0.15);
            border: 2px solid rgba(212, 175, 55, 0.2);
            display: none;
            margin: 20px 0;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(212, 175, 55, 0.1),
                    transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg,
                    #d4af37 0%,
                    #f4d03f 50%,
                    #d4af37 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 20px;
            position: relative;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 0 20px rgba(212, 175, 55, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            border-radius: 14px 14px 0 0;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .progress-text {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #0f172a;
            font-weight: 700;
            font-size: 0.95em;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .progress-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(15, 23, 41, 0.2);
            border-top-color: #0f172a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Progress status text below bar */
        .progress-status {
            margin-top: 12px;
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.05);
            border-radius: 8px;
            border-left: 4px solid #d4af37;
            font-size: 0.9em;
            color: #475569;
            line-height: 1.6;
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        .progress-status.show {
            display: block;
        }

        .progress-status strong {
            color: #1a365d;
            font-weight: 700;
        }

        /* Pulsing effect for active progress */
        .progress-bar.active .progress-fill {
            animation: gradientShift 3s ease infinite, pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow:
                    0 0 20px rgba(212, 175, 55, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow:
                    0 0 30px rgba(212, 175, 55, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }
        }

        /* Success state */
        .progress-fill.success {
            background: linear-gradient(135deg,
                    #10b981 0%,
                    #34d399 50%,
                    #10b981 100%);
            box-shadow:
                0 0 20px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Error state */
        .progress-fill.error {
            background: linear-gradient(135deg,
                    #ef4444 0%,
                    #f87171 50%,
                    #ef4444 100%);
            box-shadow:
                0 0 20px rgba(239, 68, 68, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Warning state */
        .progress-fill.warning {
            background: linear-gradient(135deg,
                    #f59e0b 0%,
                    #fbbf24 50%,
                    #f59e0b 100%);
            box-shadow:
                0 0 20px rgba(245, 158, 11, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Smooth transition styles for navigation */
        #mainAppContainer {
            transition: opacity 0.8s ease-in, transform 0.8s ease-in;
        }

        #mainHeader {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }

        #mainHeader h1,
        #mainHeader .subtitle,
        #mainHeader .tagline {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .hero-header-section {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        .hero-header-section * {
            display: none !important;
            visibility: hidden !important;
        }

        #cardsContainer {
            transition: opacity 0.8s ease-in, transform 0.8s ease-in;
        }

        .hero-section {
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        /* Smooth card appearance */
        .card {
            transition: opacity 0.8s ease-in, transform 0.8s ease-in;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Prevent flash of unstyled content during transitions */
        body.transitioning {
            overflow: hidden;
        }

        /* Image modal styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-modal-img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
        }

        .image-modal-caption {
            margin-top: 15px;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Thumbnail hover effect */
        .table-thumbnail:hover {
            opacity: 0.8;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
    </style>
    
    <!-- Progress Popup Functions - Must be defined before table_manager.js loads -->
    <script>
        /**
         * Show progress popup with percentage
         */
        function showProgressPopup(message) {
            // Remove existing popup if any
            const existing = document.getElementById('progress-popup');
            if (existing) existing.remove();
            
            const popup = document.createElement('div');
            popup.id = 'progress-popup';
            popup.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 30px 40px; border-radius: 16px; 
                            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; min-width: 350px;">
                    <div style="text-align: center;">
                        <div style="margin-bottom: 15px;">
                            <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto; border: 4px solid #f3f3f3; 
                                                        border-top: 4px solid #d4af37; border-radius: 50%; 
                                                        animation: spin 1s linear infinite;"></div>
                        </div>
                        <div style="font-size: 18px; font-weight: 700; color: #1a365d; margin-bottom: 20px;" id="progress-message">${message}</div>
                        <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                            <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #d4af37, #f0c75e); 
                                                          transition: width 0.3s ease; border-radius: 4px;"></div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: #d4af37;" id="progress-percentage">0%</div>
                    </div>
                </div>
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.5); z-index: 9999;"></div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(popup);
            return popup;
        }

        /**
         * Update progress popup
         */
        function updateProgressPopup(percentage, message) {
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressMessage = document.getElementById('progress-message');
            
            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressPercentage) progressPercentage.textContent = `${Math.round(percentage)}%`;
            if (message && progressMessage) progressMessage.textContent = message;
        }

        /**
         * Close progress popup
         */
        function closeProgressPopup() {
            const popup = document.getElementById('progress-popup');
            if (popup) popup.remove();
        }
    </script>
    
    <script src="/static/js/table_manager.js?v={{ now }}"></script>
    <script>
        // Check for workflow from landing page or showHero flag
        window.addEventListener('DOMContentLoaded', function () {
            // Check if we should show hero section (from landing page "Get Started")
            const urlParams = new URLSearchParams(window.location.search);
            const showHero = urlParams.get('showHero') === 'true';

            if (showHero) {
                // Show hero section (main app home page with carousel, title, cards)
                const heroSection = document.getElementById('heroSection');
                const mainAppContainer = document.getElementById('mainAppContainer');
                if (heroSection) {
                    heroSection.style.display = 'flex';
                }
                if (mainAppContainer) {
                    mainAppContainer.style.display = 'none';
                }
                // Initialize carousel if needed
                setTimeout(() => {
                    if (typeof initHeroImageCarousel === 'function') {
                        initHeroImageCarousel();
                    }
                }, 100);
                return;
            }

            // Check for workflow from landing page card click
            const workflowType = sessionStorage.getItem('workflowType');
            if (workflowType) {
                sessionStorage.removeItem('workflowType');
                // Wait a bit for page to fully load, then trigger workflow with smooth transition
                setTimeout(() => {
                    showMainApp(workflowType, true);
                }, 400);
            }
        });

        // Define Multi-Budget functions IMMEDIATELY (before DOMContentLoaded)
        // This ensures they're available when event listeners try to use them
        (function () {
            // Initialize variables if not already defined
            if (typeof window.currentBudgetTier === 'undefined') {
                window.currentBudgetTier = 'budgetary';
            }

            // Define switchBudgetTab immediately
            if (!window.switchBudgetTab) {
                window.switchBudgetTab = function (tier) {
                    window.currentBudgetTier = tier;
                    // Update tab buttons
                    document.querySelectorAll('.budget-tab').forEach(btn => {
                        if (btn.dataset.tier === tier) {
                            btn.classList.add('active');
                            btn.style.background = '#1a365d';
                            btn.style.color = '#d4af37';
                            btn.style.borderBottom = '3px solid #d4af37';
                        } else {
                            btn.classList.remove('active');
                            btn.style.background = '#2d4a6b';
                            btn.style.color = '#e0e0e0';
                            btn.style.borderBottom = '3px solid transparent';
                        }
                    });
                    // Show/hide table containers
                    const budgetaryContainer = document.getElementById('budgetaryTableContainer');
                    const midRangeContainer = document.getElementById('mid_rangeTableContainer');
                    const highEndContainer = document.getElementById('high_endTableContainer');
                    if (budgetaryContainer) budgetaryContainer.style.display = tier === 'budgetary' ? 'block' : 'none';
                    if (midRangeContainer) midRangeContainer.style.display = tier === 'mid_range' ? 'block' : 'none';
                    if (highEndContainer) highEndContainer.style.display = tier === 'high_end' ? 'block' : 'none';
                    // Update dropdowns
                    if (typeof window.updateBrandDropdownsForTier === 'function') {
                        window.updateBrandDropdownsForTier(tier);
                    }
                };
            }

            // Define stub functions that will be replaced by full implementations later
            // This ensures they exist when event listeners try to call them
            if (!window.generateFromBOQ) {
                window.generateFromBOQ = async function () {
                    console.warn('generateFromBOQ: Full implementation loading...');
                    // Will be replaced by full implementation in later script tag
                };
            }

            if (!window.createNewBOQ) {
                window.createNewBOQ = function () {
                    console.warn('createNewBOQ: Full implementation loading...');
                    // Will be replaced by full implementation in later script tag
                };
            }

            if (!window.openAddBrandModal) {
                window.openAddBrandModal = async function () {
                    console.warn('openAddBrandModal: Full implementation loading...');
                    // Will be replaced by full implementation in later script tag
                };
            }
        })();

        // Multi-Budget Offers Button Event Listeners - Using Event Delegation
        // This works even when the card is hidden initially
        document.addEventListener('DOMContentLoaded', function () {
            // Use event delegation on document body to catch all clicks
            document.body.addEventListener('click', function (e) {
                const target = e.target;

                // Generate from BOQ button
                if (target.id === 'generateFromBOQBtn' || target.closest('#generateFromBOQBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ Generate from BOQ button clicked');
                    if (typeof window.generateFromBOQ === 'function') {
                        window.generateFromBOQ();
                    } else {
                        console.error('generateFromBOQ not found');
                        alert('Function not loaded. Please refresh the page.');
                    }
                    return;
                }

                // Create New BOQ button
                if (target.id === 'createNewBOQBtn' || target.closest('#createNewBOQBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ Create New BOQ button clicked');
                    if (typeof window.createNewBOQ === 'function') {
                        window.createNewBOQ();
                    } else {
                        console.error('createNewBOQ not found');
                        alert('Function not loaded. Please refresh the page.');
                    }
                    return;
                }

                // Add Brand button
                if (target.id === 'openAddBrandModalBtn' || target.closest('#openAddBrandModalBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ Add Brand button clicked');
                    if (typeof window.openAddBrandModal === 'function') {
                        window.openAddBrandModal();
                    } else {
                        console.error('openAddBrandModal not found');
                        alert('Function not loaded. Please refresh the page.');
                    }
                    return;
                }

                // Budget Tier tabs
                if (target.id === 'budgetaryTab' || target.closest('#budgetaryTab')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ Budgetary tab clicked');
                    if (typeof window.switchBudgetTab === 'function') {
                        window.switchBudgetTab('budgetary');
                    } else {
                        console.error('switchBudgetTab not found');
                    }
                    return;
                }

                if (target.id === 'midRangeTab' || target.closest('#midRangeTab')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ Mid-Range tab clicked');
                    if (typeof window.switchBudgetTab === 'function') {
                        window.switchBudgetTab('mid_range');
                    } else {
                        console.error('switchBudgetTab not found');
                    }
                    return;
                }

                if (target.id === 'highEndTab' || target.closest('#highEndTab')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ High-End tab clicked');
                    if (typeof window.switchBudgetTab === 'function') {
                        window.switchBudgetTab('high_end');
                    } else {
                        console.error('switchBudgetTab not found');
                    }
                    return;
                }
            });
        });

        // Initialize Multi-Budget buttons (backup function)
        function initializeMultiBudgetButtons() {
            // This is a backup - event delegation above should handle everything
            // But we can also directly attach listeners here if needed
            const generateBtn = document.getElementById('generateFromBOQBtn');
            const createBtn = document.getElementById('createNewBOQBtn');
            const addBrandBtn = document.getElementById('openAddBrandModalBtn');
            const budgetaryTab = document.getElementById('budgetaryTab');
            const midRangeTab = document.getElementById('midRangeTab');
            const highEndTab = document.getElementById('highEndTab');

            // Only attach if not already attached (check for existing listeners)
            if (generateBtn && !generateBtn.hasAttribute('data-listener-attached')) {
                generateBtn.setAttribute('data-listener-attached', 'true');
                generateBtn.addEventListener('click', function () {
                    if (typeof window.generateFromBOQ === 'function') {
                        window.generateFromBOQ();
                    }
                });
            }

            if (createBtn && !createBtn.hasAttribute('data-listener-attached')) {
                createBtn.setAttribute('data-listener-attached', 'true');
                createBtn.addEventListener('click', function () {
                    if (typeof window.createNewBOQ === 'function') {
                        window.createNewBOQ();
                    }
                });
            }

            if (addBrandBtn && !addBrandBtn.hasAttribute('data-listener-attached')) {
                addBrandBtn.setAttribute('data-listener-attached', 'true');
                addBrandBtn.addEventListener('click', function () {
                    if (typeof window.openAddBrandModal === 'function') {
                        window.openAddBrandModal();
                    }
                });
            }

            if (budgetaryTab && !budgetaryTab.hasAttribute('data-listener-attached')) {
                budgetaryTab.setAttribute('data-listener-attached', 'true');
                budgetaryTab.addEventListener('click', function () {
                    if (typeof window.switchBudgetTab === 'function') {
                        window.switchBudgetTab('budgetary');
                    }
                });
            }

            if (midRangeTab && !midRangeTab.hasAttribute('data-listener-attached')) {
                midRangeTab.setAttribute('data-listener-attached', 'true');
                midRangeTab.addEventListener('click', function () {
                    if (typeof window.switchBudgetTab === 'function') {
                        window.switchBudgetTab('mid_range');
                    }
                });
            }

            if (highEndTab && !highEndTab.hasAttribute('data-listener-attached')) {
                highEndTab.setAttribute('data-listener-attached', 'true');
                highEndTab.addEventListener('click', function () {
                    if (typeof window.switchBudgetTab === 'function') {
                        window.switchBudgetTab('high_end');
                    }
                });
            }
        }

        // Make initializeMultiBudgetButtons globally accessible
        window.initializeMultiBudgetButtons = initializeMultiBudgetButtons;

        // Main Application Navigation - Smoothly scrolls to upload area
        function showMainApp(workflowType, fromLanding = false) {
            const heroSection = document.getElementById('heroSection');
            const mainAppContainer = document.getElementById('mainAppContainer');

            // Show main app container if hidden
            if (mainAppContainer) {
                mainAppContainer.style.display = 'block';
            }

            // Store current workflow type
            window.currentWorkflowType = workflowType;

            // Hide all workflow-specific cards initially
            if (typeof hideAllWorkflowCards === 'function') {
                hideAllWorkflowCards();
            }

            // Show relevant cards based on workflow type
            if (typeof showWorkflowSpecificCards === 'function') {
                showWorkflowSpecificCards(workflowType);
            }

            // Find the upload area - it's the first card in main-content
            const mainContent = document.querySelector('.main-content');
            const uploadSection = mainContent ? mainContent.querySelector('.card:first-child') : null;
            const uploadArea = document.getElementById('uploadArea');

            let targetCard = null;

            // Determine which workflow-specific card to show
            if (workflowType === 'quote-pricelist') {
                targetCard = uploadSection;
            } else if (workflowType === 'multi-budget') {
                targetCard = document.getElementById('multiBudgetCard');
            } else if (workflowType === 'presentation') {
                targetCard = document.getElementById('presentationCard');
            } else if (workflowType === 'mas') {
                targetCard = document.getElementById('masCard');
            }

            // Show upload section (always visible)
            if (uploadSection) {
                uploadSection.style.display = 'block';
            }

            // Show workflow-specific card if it exists and is different from upload section
            if (targetCard && targetCard !== uploadSection) {
                targetCard.style.display = 'block';
            }

            // Smooth scroll to upload area (vertically down)
            setTimeout(() => {
                if (uploadSection) {
                    const uploadPosition = uploadSection.getBoundingClientRect().top + window.pageYOffset;
                    smoothScrollTo(uploadPosition - 100, 1200); // Smooth, slower scroll with offset
                }
            }, 300);
        }

        // Navigate to specific workflow with smooth scroll - goes directly to upload area
        function navigateToWorkflow(workflowType, fromLanding = false) {
            // Store current workflow type
            window.currentWorkflowType = workflowType;

            // Hide all workflow-specific cards initially
            if (typeof hideAllWorkflowCards === 'function') {
                hideAllWorkflowCards();
            }

            // Show relevant cards based on workflow type
            if (typeof showWorkflowSpecificCards === 'function') {
                showWorkflowSpecificCards(workflowType);
            }

            // Find the upload area - it's the first card in main-content
            const mainContent = document.querySelector('.main-content');
            const uploadSection = mainContent ? mainContent.querySelector('.card:first-child') : null;
            const uploadArea = document.getElementById('uploadArea');

            let targetCard = null;

            // Determine which workflow-specific card to show
            if (workflowType === 'quote-pricelist') {
                // Quote workflow uses the upload section
                targetCard = uploadSection;
            } else if (workflowType === 'multi-budget') {
                targetCard = document.getElementById('multiBudgetCard');
            } else if (workflowType === 'presentation') {
                targetCard = document.getElementById('presentationCard');
            } else if (workflowType === 'mas') {
                targetCard = document.getElementById('masCard');
            }

            // Show upload section (always visible)
            if (uploadSection) {
                uploadSection.style.display = 'block';
                uploadSection.style.opacity = '0';
                uploadSection.style.transition = 'opacity 0.8s ease-in, transform 0.8s ease-in';
                uploadSection.style.transform = 'translateY(20px)';
            }

            // Show workflow-specific card if it exists and is different from upload section
            if (targetCard && targetCard !== uploadSection) {
                targetCard.style.display = 'block';
                targetCard.style.opacity = '0';
                targetCard.style.transition = 'opacity 0.8s ease-in, transform 0.8s ease-in';
                targetCard.style.transform = 'translateY(20px)';
            }

            // Fade in and scroll to upload area smoothly
            setTimeout(() => {
                if (uploadSection) {
                    uploadSection.style.opacity = '1';
                    uploadSection.style.transform = 'translateY(0)';
                }

                if (targetCard && targetCard !== uploadSection) {
                    targetCard.style.opacity = '1';
                    targetCard.style.transform = 'translateY(0)';
                }

                // Smooth scroll to upload area (primary target)
                setTimeout(() => {
                    if (uploadSection) {
                        const uploadPosition = uploadSection.getBoundingClientRect().top + window.pageYOffset;
                        smoothScrollTo(uploadPosition - 100, 1200); // Smooth, slower scroll with offset
                    }
                }, 400);
            }, 200);
        }

        // Custom smooth scroll function with configurable speed
        function smoothScrollTo(targetPosition, duration = 1000) {
            const startPosition = window.pageYOffset;
            const distance = targetPosition - startPosition;
            let startTime = null;

            function animation(currentTime) {
                if (startTime === null) startTime = currentTime;
                const timeElapsed = currentTime - startTime;
                const progress = Math.min(timeElapsed / duration, 1);

                // Easing function for smooth deceleration
                const ease = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;

                window.scrollTo(0, startPosition + distance * ease);

                if (timeElapsed < duration) {
                    requestAnimationFrame(animation);
                }
            }

            requestAnimationFrame(animation);
        }
    </script>
</head>

<body>
    <!-- Animated Background -->
    <div class="bg-particles" id="bgParticles"></div>

    <div class="container">
        <!-- Hero Introduction Section - Shows only cards, no header/carousel -->
        <section id="heroSection" class="hero-section"
            style="display: flex; flex-direction: column; align-items: center; padding-top: 20px;">
            <!-- Floating Decorative Elements -->
            <div class="floating-shape"></div>
            <div class="floating-shape"></div>
            <div class="floating-shape"></div>

            <!-- 1. Header Section (Logo + Title) -->
            <div class="hero-header-section"
                style="text-align: center; margin-bottom: 40px; padding: 0 20px; width: 100%; max-width: 800px; z-index: 2;">

                <div class="hero-ai-badge" style="margin: 0 auto 20px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                    </svg>
                    Powered by Advanced AI
                </div>
                <h2 class="hero-app-name" style="margin-bottom: 20px;">
                    <span class="transform-text">Transform Your</span><br>
                    <span class="workflow-text">BOQ Workflow</span>
                </h2>
                <p class="hero-platform-desc" style="max-width: 800px; margin: 0 auto;">Revolutionize your WorkFlow with
                    AI-powered automation. Generate professional quotes, Alternative Offers, presentations, and Material
                    approval sheets M.A.S in secondsâ€”not hours.</p>
            </div>

            <!-- 2. Logo Section (Above Carousel) -->
            <div class="hero-logo-section"
                style="width: 100%; max-width: 1000px; margin: 0 auto 40px; padding: 0 20px; z-index: 2; text-align: center;">
                <img src="{{ url_for('static', filename='images/al-shaya-logo-white@2x.png') }}"
                    alt="AlShaya Enterprises"
                    style="max-width: 300px; height: auto; display: block; margin: 0 auto 20px;">
                <h1
                    style="font-size: 3em; font-weight: 800; color: #ffffff; margin: 0; text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); letter-spacing: -1px;">
                    Transform Your Workflow
                </h1>
            </div>

            <!-- 3. Carousel Section -->
            <div class="hero-carousel-section"
                style="width: 100%; max-width: 1000px; margin: 0 auto 60px; padding: 0 20px; z-index: 2;">
                <div class="hero-image-carousel"
                    style="height: 400px; border-radius: 30px; overflow: hidden; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 2px solid rgba(212, 175, 55, 0.2);">
                    <div class="hero-image-slide active"
                        style="background-image: url('https://images.unsplash.com/photo-1497366216548-37526070297c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
                    </div>
                    <div class="hero-image-slide"
                        style="background-image: url('https://images.unsplash.com/photo-1497366754035-f200968a6e72?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
                    </div>
                    <div class="hero-image-slide"
                        style="background-image: url('https://images.unsplash.com/photo-1524758631624-e2822e304c36?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
                    </div>
                    <div class="hero-image-slide"
                        style="background-image: url('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
                    </div>
                    <div class="hero-image-slide"
                        style="background-image: url('https://images.unsplash.com/photo-1497215842964-222b430dc094?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
                    </div>
                </div>
            </div>

            <!-- 4. Cards Section -->
            <div class="hero-cards-section"
                style="width: 100%; max-width: 1400px; margin: 0 auto; padding: 40px 20px 80px; z-index: 2;">

                <!-- Stats Section (Moved Above Cards) - Hidden -->
                <div class="hero-stats" style="display: none; margin-bottom: 60px;">
                    <div class="stat-item">
                        <div class="stat-number">AI</div>
                        <div class="stat-label">Powered Processing</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number infinity">âˆž</div>
                        <div class="stat-label">Scalable Solutions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">100%</div>
                        <div class="stat-label">Automated Workflow</div>
                    </div>
                </div>

                <div class="hero-cards-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 35px;">
                    <!-- Card 1: Quote with Price List -->
                    <div class="feature-card" data-card="quote-pricelist" onclick="showMainApp('quote-pricelist')">
                        <span class="card-badge">Popular</span>
                        <span class="card-icon"></span>
                        <h2 class="card-title">Quote with Price List</h2>
                        <p class="card-description">
                            Upload your BOQ with price list to generate professional quotations instantly with accurate
                            pricing
                            and margins.
                        </p>
                        <ul class="card-features">
                            <li>Upload BOQ + Price List</li>
                            <li>Auto-extract quantities & prices</li>
                            <li>Apply margins & factors</li>
                            <li>Generate PDF/Excel quotes</li>
                        </ul>
                        <button class="card-cta">
                            Start Quoting â†’
                        </button>
                    </div>

                    <!-- Card 2: Multi-Budget Offers -->
                    <div class="feature-card" data-card="multi-budget" onclick="showMainApp('multi-budget')">
                        <span class="card-badge">AI-Powered</span>
                        <span class="card-icon"></span>
                        <h2 class="card-title">Multi-Budget Offers</h2>
                        <p class="card-description">
                            Upload BOQ only (no prices) and let AI generate three budget tiers: Budgetary, Mid-Range,
                            and
                            High-End options.
                        </p>
                        <ul class="card-features">
                            <li>Upload BOQ without prices</li>
                            <li>AI-generated price estimates</li>
                            <li>3 budget tier options</li>
                            <li>Comparative analysis</li>
                        </ul>
                        <button class="card-cta">
                            Generate Options â†’
                        </button>
                    </div>

                    <!-- Card 3: Presentation Generator -->
                    <div class="feature-card" data-card="presentation" onclick="showMainApp('presentation')">
                        <span class="card-badge">Visual</span>
                        <span class="card-icon"></span>
                        <h2 class="card-title">Presentation Generator</h2>
                        <p class="card-description">
                            Create stunning visual presentations from your BOQ with images and pricing in professional
                            PowerPoint format.
                        </p>
                        <ul class="card-features">
                            <li>Upload BOQ with images</li>
                            <li>Auto-generate slides</li>
                            <li>Professional templates</li>
                            <li>Export to PPTX/PDF</li>
                        </ul>
                        <button class="card-cta">
                            Create Presentation â†’
                        </button>
                    </div>

                    <!-- Card 4: MAS Generator -->
                    <div class="feature-card" data-card="mas" onclick="showMainApp('mas')">
                        <span class="card-badge">Essential</span>
                        <span class="card-icon"></span>
                        <h2 class="card-title">MAS Generator</h2>
                        <p class="card-description">
                            Generate Material Approval Sheets automatically from your BOQ for streamlined approval
                            workflows.
                        </p>
                        <ul class="card-features">
                            <li>Upload BOQ data</li>
                            <li>Extract material specs</li>
                            <li>Generate approval sheets</li>
                            <li>Export in multiple formats</li>
                        </ul>
                        <button class="card-cta">
                            Generate MAS â†’
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Workflow Section -->
        <section class="workflow-section">
            <div class="workflow-container">
                <div class="workflow-title">
                    <h2>Automated Workflow</h2>
                    <p class="workflow-subtitle">Our AI-powered system streamlines your entire BOQ management process,
                        from upload to final delivery</p>
                </div>

                <div class="workflow-steps">
                    <!-- Step 1: Upload BOQ -->
                    <div class="workflow-step">
                        <div class="workflow-connector"></div>
                        <div class="workflow-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>
                        <div class="workflow-step-content">
                            <h3 class="workflow-step-title">Upload BOQ</h3>
                            <p class="workflow-step-desc">Simply drag and drop your Bill of Quantities file</p>
                            <div class="workflow-step-number">Step 1</div>
                        </div>
                    </div>

                    <!-- Step 2: AI Processing -->
                    <div class="workflow-step">
                        <div class="workflow-connector"></div>
                        <div class="workflow-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                <path d="M2 17l10 5 10-5"></path>
                                <path d="M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                        <div class="workflow-step-content">
                            <h3 class="workflow-step-title">AI Processing</h3>
                            <p class="workflow-step-desc">Our AI analyzes and structures your data instantly</p>
                            <div class="workflow-step-number">Step 2</div>
                        </div>
                    </div>

                    <!-- Step 3: Generate Output -->
                    <div class="workflow-step">
                        <div class="workflow-connector"></div>
                        <div class="workflow-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                            </svg>
                        </div>
                        <div class="workflow-step-content">
                            <h3 class="workflow-step-title">Generate Output</h3>
                            <p class="workflow-step-desc">Get professional quotes, presentations, or MAS documents</p>
                            <div class="workflow-step-number">Step 3</div>
                        </div>
                    </div>

                    <!-- Step 4: Export & Share -->
                    <div class="workflow-step">
                        <div class="workflow-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </div>
                        <div class="workflow-step-content">
                            <h3 class="workflow-step-title">Export & Share</h3>
                            <p class="workflow-step-desc">Download in PDF, Excel, or PowerPoint format</p>
                            <div class="workflow-step-number">Step 4</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Header - Removed -->

        <!-- Main Cards Grid -->
        <div class="cards-container" id="cardsContainer" style="display: none;">
            <!-- Card 1: Quote with Price List -->
            <div class="feature-card" data-card="quote-pricelist">
                <span class="card-badge">Popular</span>
                <span class="card-icon">ðŸ’°</span>
                <h2 class="card-title">Quote with Price List</h2>
                <p class="card-description">
                    Upload your BOQ with price list to generate professional quotations instantly with accurate pricing
                    and margins.
                </p>
                <ul class="card-features">
                    <li>Upload BOQ + Price List</li>
                    <li>Auto-extract quantities & prices</li>
                    <li>Apply margins & factors</li>
                    <li>Generate PDF/Excel quotes</li>
                </ul>
                <button class="card-cta" onclick="showMainApp('quote-pricelist')">
                    Start Quoting â†’
                </button>
            </div>

            <!-- Card 2: Multi-Budget Offers -->
            <div class="feature-card" data-card="multi-budget">
                <span class="card-badge">AI-Powered</span>
                <span class="card-icon">ðŸŽ¯</span>
                <h2 class="card-title">Multi-Budget Offers</h2>
                <p class="card-description">
                    Upload BOQ only (no prices) and let AI generate three budget tiers: Budgetary, Mid-Range, and
                    High-End options.
                </p>
                <ul class="card-features">
                    <li>Upload BOQ without prices</li>
                    <li>AI-generated price estimates</li>
                    <li>3 budget tier options</li>
                    <li>Comparative analysis</li>
                </ul>
                <button class="card-cta" onclick="showMainApp('multi-budget')">
                    Generate Options â†’
                </button>
            </div>

            <!-- Card 3: Presentation Generator -->
            <div class="feature-card" data-card="presentation">
                <span class="card-badge">Visual</span>
                <span class="card-icon">ðŸŽ¨</span>
                <h2 class="card-title">Presentation Generator</h2>
                <p class="card-description">
                    Create stunning visual presentations from your BOQ with images and pricing in professional
                    PowerPoint format.
                </p>
                <ul class="card-features">
                    <li>Upload BOQ with images</li>
                    <li>Auto-generate slides</li>
                    <li>Professional templates</li>
                    <li>Export to PPTX/PDF</li>
                </ul>
                <button class="card-cta" onclick="showMainApp('presentation')">
                    Create Presentation â†’
                </button>
            </div>

            <!-- Card 4: MAS Generator -->
            <div class="feature-card" data-card="mas">
                <span class="card-badge">Essential</span>
                <span class="card-icon">ðŸ“‹</span>
                <h2 class="card-title">MAS Generator</h2>
                <p class="card-description">
                    Generate Material Approval Sheets automatically from your BOQ for streamlined approval workflows.
                </p>
                <ul class="card-features">
                    <li>Upload BOQ data</li>
                    <li>Extract material specs</li>
                    <li>Generate approval sheets</li>
                    <li>Export in multiple formats</li>
                </ul>
                <button class="card-cta" onclick="showMainApp('mas')">
                    Generate MAS â†’
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application Interface (Hidden by default) -->
    <div id="mainAppContainer" class="main-app-container" style="display: none;">
        <!-- Top Navigation Bar with Logo -->
        <div class="app-nav-bar">
            <div style="display: flex; gap: 10px;">
                <button class="nav-home-btn" onclick="returnToHome()">
                    â† Return to Home
                </button>
                <button class="nav-home-btn" onclick="goToLandingPage()" style="background: #3b82f6; color: white;">
                    ðŸ  Home
                </button>
            </div>
            <img src="/static/images/al-shaya-logo-white@2x.png" alt="Alshaya Enterprises" class="app-logo">
        </div>

        <!-- Main Content from Original App -->
        <div class="main-content">
            <!-- Upload Section -->
            <div class="card">
                <h2>Upload & Extract Files</h2>

                <!-- Extraction Settings (Collapsible) -->
                <div style="margin-bottom: 20px; background: #1e1e1e; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;"
                        onclick="toggleUploadSettings()">
                        <h3 style="margin: 0; color: #e0e0e0; font-size: 0.95em;">Extraction Settings</h3>
                        <span id="uploadSettingsToggle" style="color: #888;">â–¼</span>
                    </div>
                    <div id="uploadSettingsPanel" style="display: none; margin-top: 15px;">
                        <div style="margin-bottom: 15px; padding: 12px; background: #2a2a2a; border-radius: 8px; border-left: 4px solid #10b981;">
                            <label for="upload-setting-extractionMethod" style="color: #e0e0e0; font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.95em;">
                                ðŸ”§ Extraction Method
                            </label>
                            <select id="upload-setting-extractionMethod" 
                                    style="width: 100%; padding: 8px; background: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 0.9em; cursor: pointer;">
                                <option value="pdfplumber" selected>PDFPlumber (Local)</option>
                                <option value="pp-structure">PP-StructureV3 API (Cloud)</option>
                            </select>
                        </div>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useDocPreprocessor"
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useDocPreprocessor"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Document
                                    Preprocessor</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useSealRecognition" checked
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useSealRecognition"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Seal Recognition</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useTableRecognition" checked
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useTableRecognition"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Table Recognition</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useFormulaRecognition" checked
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useFormulaRecognition"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Formula
                                    Recognition</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useChartRecognition" checked
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useChartRecognition"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Chart Recognition</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useRegionDetection" checked
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useRegionDetection"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Region Detection</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-formatBlockContent" checked
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-formatBlockContent"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Format Block
                                    Content</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useTextlineOrientation"
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useTextlineOrientation"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Textline
                                    Orientation</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useDocOrientationClassify"
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useDocOrientationClassify"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Document
                                    Orientation</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-useDocUnwarping"
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-useDocUnwarping"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Image Distortion
                                    Correction</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="upload-setting-visualize"
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <label for="upload-setting-visualize"
                                    style="color: #e0e0e0; cursor: pointer; font-size: 0.9em;">Visualize (Debug)</label>
                            </div>
                        </div>

                        <!-- Table Recognition Advanced Settings -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                            <h4 style="color: #e0e0e0; margin-bottom: 10px; font-size: 0.9em;">Table Recognition
                                Advanced</h4>
                            <div
                                style="background: #2a1f0e; border-left: 3px solid #ff9800; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
                                <p style="color: #ff9800; margin: 0; font-size: 0.75em;">
                                    âš ï¸ Wired/Wireless to HTML or E2E modes may lose images
                                </p>
                            </div>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-useWiredTableCellsTransToHtml"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-useWiredTableCellsTransToHtml"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">Wired Table to
                                        HTML</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-useWirelessTableCellsTransToHtml"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-useWirelessTableCellsTransToHtml"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">Wireless Table to
                                        HTML</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-useTableOrientationClassify"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-useTableOrientationClassify"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">Table
                                        Orientation</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-useOcrResultsWithTableCells"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-useOcrResultsWithTableCells"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">Cell
                                        Recognition</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-useE2eWiredTableRecModel"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-useE2eWiredTableRecModel"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">E2E Wired
                                        Table</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-useE2eWirelessTableRecModel"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-useE2eWirelessTableRecModel"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">E2E Wireless
                                        Table</label>
                                </div>
                            </div>
                        </div>

                        <!-- Layout Detection Settings -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                            <h4 style="color: #e0e0e0; margin-bottom: 10px; font-size: 0.9em;">ðŸ“ Layout Detection</h4>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-layoutThreshold"
                                        style="color: #e0e0e0; font-size: 0.8em;">Layout Threshold</label>
                                    <input type="number" id="upload-setting-layoutThreshold" step="0.1" min="0" max="1"
                                        value="0.5"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="upload-setting-layoutNms"
                                        style="width: 14px; height: 14px; cursor: pointer;">
                                    <label for="upload-setting-layoutNms"
                                        style="color: #e0e0e0; cursor: pointer; font-size: 0.85em;">NMS
                                        Postprocessing</label>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-layoutUnclipRatio"
                                        style="color: #e0e0e0; font-size: 0.8em;">Expansion Coeff</label>
                                    <input type="number" id="upload-setting-layoutUnclipRatio" step="0.1" min="0"
                                        value="1.0"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-layoutMergeBboxesMode"
                                        style="color: #e0e0e0; font-size: 0.8em;">Box Filtering</label>
                                    <select id="upload-setting-layoutMergeBboxesMode"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                        <option value="large">Large</option>
                                        <option value="small">Small</option>
                                        <option value="union">Union</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Text Detection Settings -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                            <h4 style="color: #e0e0e0; margin-bottom: 10px; font-size: 0.9em;">ðŸ”¤ Text Detection</h4>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-textDetLimitSideLen"
                                        style="color: #e0e0e0; font-size: 0.8em;">Side Length Limit</label>
                                    <input type="number" id="upload-setting-textDetLimitSideLen" min="1" value="64"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-textDetLimitType"
                                        style="color: #e0e0e0; font-size: 0.8em;">Limit Type</label>
                                    <select id="upload-setting-textDetLimitType"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                        <option value="min">Min</option>
                                        <option value="max">Max</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-textDetThresh"
                                        style="color: #e0e0e0; font-size: 0.8em;">Pixel Threshold</label>
                                    <input type="number" id="upload-setting-textDetThresh" step="0.1" min="0"
                                        value="0.3"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-textDetBoxThresh"
                                        style="color: #e0e0e0; font-size: 0.8em;">Box Threshold</label>
                                    <input type="number" id="upload-setting-textDetBoxThresh" step="0.1" min="0"
                                        value="0.6"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-textDetUnclipRatio"
                                        style="color: #e0e0e0; font-size: 0.8em;">Expansion Coeff</label>
                                    <input type="number" id="upload-setting-textDetUnclipRatio" step="0.1" min="0"
                                        value="1.5"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-textRecScoreThresh"
                                        style="color: #e0e0e0; font-size: 0.8em;">Recognition Threshold</label>
                                    <input type="number" id="upload-setting-textRecScoreThresh" step="0.1" min="0"
                                        value="0.0"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                            </div>
                        </div>

                        <!-- Seal Detection Settings -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                            <h4 style="color: #e0e0e0; margin-bottom: 10px; font-size: 0.9em;">ðŸ”– Seal Detection</h4>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-sealDetLimitSideLen"
                                        style="color: #e0e0e0; font-size: 0.8em;">Side Length Limit</label>
                                    <input type="number" id="upload-setting-sealDetLimitSideLen" min="1" value="736"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-sealDetLimitType"
                                        style="color: #e0e0e0; font-size: 0.8em;">Limit Type</label>
                                    <select id="upload-setting-sealDetLimitType"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                        <option value="min">Min</option>
                                        <option value="max">Max</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-sealDetThresh"
                                        style="color: #e0e0e0; font-size: 0.8em;">Pixel Threshold</label>
                                    <input type="number" id="upload-setting-sealDetThresh" step="0.1" min="0"
                                        value="0.2"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-sealDetBoxThresh"
                                        style="color: #e0e0e0; font-size: 0.8em;">Box Threshold</label>
                                    <input type="number" id="upload-setting-sealDetBoxThresh" step="0.1" min="0"
                                        value="0.6"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-sealDetUnclipRatio"
                                        style="color: #e0e0e0; font-size: 0.8em;">Expansion Coeff</label>
                                    <input type="number" id="upload-setting-sealDetUnclipRatio" step="0.1" min="0"
                                        value="0.5"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="upload-setting-sealRecScoreThresh"
                                        style="color: #e0e0e0; font-size: 0.8em;">Recognition Threshold</label>
                                    <input type="number" id="upload-setting-sealRecScoreThresh" step="0.1" min="0"
                                        value="0.0"
                                        style="padding: 4px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; font-size: 0.85em;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ðŸ“</div>
                    <div class="upload-text">Drag & Drop files here</div>
                    <div class="upload-subtext">or click to browse (PDF, XLS, XLSX, JPG, PNG)</div>
                    <div class="upload-subtext" style="margin-top: 10px; font-size: 0.85em; color: #888;">Files will be
                        automatically extracted after upload</div>
                    <input type="file" id="fileInput" accept=".pdf,.xls,.xlsx,.jpg,.jpeg,.png" multiple>
                </div>

                <div class="progress-bar" id="uploadProgress">
                    <div class="progress-fill" id="uploadProgressFill">0%</div>
                </div>
                <div class="progress-status" id="progressStatus"></div>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-danger" onclick="cleanupFiles()">ðŸ—‘ï¸ Clear All Files</button>
                </div>
            </div>

            <!-- Extracted Tables Section -->
            <div class="card" id="extractedTablesCard" style="display:none;">
                <h2>ðŸ“Š Extracted Tables</h2>
                <div id="extractedTablesContainer"></div>
            </div>

            <!-- Extraction Settings Panel (Hidden by default) -->
            <div class="card" id="extractionSettingsCard" style="display:none; max-width: 800px; margin: 20px auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">âš™ï¸ Advanced Extraction Settings</h2>
                    <button onclick="toggleExtractionSettings()"
                        style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">âœ•
                        Close</button>
                </div>
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; border-left: 4px solid #10b981;">
                        <label for="setting-extractionMethod" style="color: #e0e0e0; font-weight: 600; display: block; margin-bottom: 8px; font-size: 1em;">
                            ðŸ”§ Extraction Method
                        </label>
                        <select id="setting-extractionMethod" 
                                style="width: 100%; padding: 10px; background: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 0.95em; cursor: pointer;">
                            <option value="pdfplumber" selected>PDFPlumber (Local - Fast & Reliable)</option>
                            <option value="pp-structure">PP-StructureV3 API (Cloud - Advanced OCR)</option>
                        </select>
                        <p style="color: #888; margin-top: 8px; font-size: 0.85em; line-height: 1.4;">
                            <strong>PDFPlumber:</strong> Local extraction, works offline, faster for simple tables.<br>
                            <strong>PP-StructureV3 API:</strong> Cloud-based AI extraction, better for complex layouts and OCR.
                        </p>
                    </div>
                    <p style="color: #888; margin-bottom: 20px; font-size: 0.9em;">
                        These settings match the configuration from the example JSON that produced clean extractions.
                        Modify only if needed for specific document types.
                    </p>
                    <div id="ppStructureSettings" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useDocPreprocessor"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useDocPreprocessor" style="color: #e0e0e0; cursor: pointer;">Document
                                Preprocessor</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useSealRecognition" checked
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useSealRecognition" style="color: #e0e0e0; cursor: pointer;">Seal
                                Recognition</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useTableRecognition" checked
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useTableRecognition" style="color: #e0e0e0; cursor: pointer;">Table
                                Recognition <strong>(Required)</strong></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useFormulaRecognition" checked
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useFormulaRecognition" style="color: #e0e0e0; cursor: pointer;">Formula
                                Recognition</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useChartRecognition" checked
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useChartRecognition" style="color: #e0e0e0; cursor: pointer;">Chart
                                Recognition</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useRegionDetection" checked
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useRegionDetection" style="color: #e0e0e0; cursor: pointer;">Region
                                Detection</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-formatBlockContent" checked
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-formatBlockContent" style="color: #e0e0e0; cursor: pointer;">Format
                                Block Content</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useTextlineOrientation"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useTextlineOrientation"
                                style="color: #e0e0e0; cursor: pointer;">Textline Orientation</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useDocOrientationClassify"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useDocOrientationClassify"
                                style="color: #e0e0e0; cursor: pointer;">Document Orientation</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-useDocUnwarping"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-useDocUnwarping" style="color: #e0e0e0; cursor: pointer;">Image
                                Distortion Correction</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="setting-visualize"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="setting-visualize" style="color: #e0e0e0; cursor: pointer;">Visualize (Debug
                                Images)</label>
                        </div>
                    </div>

                    <!-- Table Recognition Advanced Settings -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 1em;">ðŸ“Š Table Recognition Advanced
                        </h3>
                        <div
                            style="background: #2a1f0e; border-left: 3px solid #ff9800; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
                            <p style="color: #ff9800; margin: 0; font-size: 0.85em;">
                                âš ï¸ <strong>Warning:</strong> Enabling "Wired/Wireless Table to HTML" or "End-to-End
                                Table" modes may cause images in table cells to be lost. Keep these disabled if you need
                                product images.
                            </p>
                        </div>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-useWiredTableCellsTransToHtml"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-useWiredTableCellsTransToHtml"
                                    style="color: #e0e0e0; cursor: pointer;">Wired Table to HTML <span
                                        style="color: #ff9800; font-size: 0.85em;">âš ï¸ May lose images</span></label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-useWirelessTableCellsTransToHtml"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-useWirelessTableCellsTransToHtml"
                                    style="color: #e0e0e0; cursor: pointer;">Wireless Table to HTML <span
                                        style="color: #ff9800; font-size: 0.85em;">âš ï¸ May lose images</span></label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-useTableOrientationClassify"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-useTableOrientationClassify"
                                    style="color: #e0e0e0; cursor: pointer;">Table Orientation Correction</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-useOcrResultsWithTableCells"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-useOcrResultsWithTableCells"
                                    style="color: #e0e0e0; cursor: pointer;">Cell-by-Cell Recognition</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-useE2eWiredTableRecModel"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-useE2eWiredTableRecModel"
                                    style="color: #e0e0e0; cursor: pointer;">End-to-End Wired Table <span
                                        style="color: #ff9800; font-size: 0.85em;">âš ï¸ May lose images</span></label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-useE2eWirelessTableRecModel"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-useE2eWirelessTableRecModel"
                                    style="color: #e0e0e0; cursor: pointer;">End-to-End Wireless Table <span
                                        style="color: #ff9800; font-size: 0.85em;">âš ï¸ May lose images</span></label>
                            </div>
                        </div>
                    </div>

                    <!-- Layout Detection Settings -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 1em;">ðŸ“ Layout Detection</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-layoutThreshold" style="color: #e0e0e0; font-size: 0.9em;">Layout
                                    Threshold (0-1)</label>
                                <input type="number" id="setting-layoutThreshold" step="0.1" min="0" max="1" value="0.5"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="setting-layoutNms"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="setting-layoutNms" style="color: #e0e0e0; cursor: pointer;">NMS
                                    Postprocessing</label>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-layoutUnclipRatio"
                                    style="color: #e0e0e0; font-size: 0.9em;">Expansion Coefficient</label>
                                <input type="number" id="setting-layoutUnclipRatio" step="0.1" min="0" value="1.0"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-layoutMergeBboxesMode"
                                    style="color: #e0e0e0; font-size: 0.9em;">Overlapping Box Filtering</label>
                                <select id="setting-layoutMergeBboxesMode"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                                    <option value="large">Large (Keep Largest)</option>
                                    <option value="small">Small (Keep Smallest)</option>
                                    <option value="union">Union (Keep Both)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Text Detection Settings -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 1em;">ðŸ”¤ Text Detection</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-textDetLimitSideLen" style="color: #e0e0e0; font-size: 0.9em;">Image
                                    Side Length Limit</label>
                                <input type="number" id="setting-textDetLimitSideLen" min="1" value="64"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-textDetLimitType" style="color: #e0e0e0; font-size: 0.9em;">Side
                                    Length Limit Type</label>
                                <select id="setting-textDetLimitType"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                                    <option value="min">Min (Shortest Side)</option>
                                    <option value="max">Max (Longest Side)</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-textDetThresh" style="color: #e0e0e0; font-size: 0.9em;">Pixel
                                    Threshold</label>
                                <input type="number" id="setting-textDetThresh" step="0.1" min="0" value="0.3"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-textDetBoxThresh" style="color: #e0e0e0; font-size: 0.9em;">Box
                                    Threshold</label>
                                <input type="number" id="setting-textDetBoxThresh" step="0.1" min="0" value="0.6"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-textDetUnclipRatio"
                                    style="color: #e0e0e0; font-size: 0.9em;">Expansion Coefficient</label>
                                <input type="number" id="setting-textDetUnclipRatio" step="0.1" min="0" value="1.5"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-textRecScoreThresh"
                                    style="color: #e0e0e0; font-size: 0.9em;">Recognition Score Threshold</label>
                                <input type="number" id="setting-textRecScoreThresh" step="0.1" min="0" value="0.0"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Seal Detection Settings -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 1em;">ðŸ”– Seal Detection</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-sealDetLimitSideLen" style="color: #e0e0e0; font-size: 0.9em;">Image
                                    Side Length Limit</label>
                                <input type="number" id="setting-sealDetLimitSideLen" min="1" value="736"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-sealDetLimitType" style="color: #e0e0e0; font-size: 0.9em;">Side
                                    Length Limit Type</label>
                                <select id="setting-sealDetLimitType"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                                    <option value="min">Min (Shortest Side)</option>
                                    <option value="max">Max (Longest Side)</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-sealDetThresh" style="color: #e0e0e0; font-size: 0.9em;">Pixel
                                    Threshold</label>
                                <input type="number" id="setting-sealDetThresh" step="0.1" min="0" value="0.2"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-sealDetBoxThresh" style="color: #e0e0e0; font-size: 0.9em;">Box
                                    Threshold</label>
                                <input type="number" id="setting-sealDetBoxThresh" step="0.1" min="0" value="0.6"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-sealDetUnclipRatio"
                                    style="color: #e0e0e0; font-size: 0.9em;">Expansion Coefficient</label>
                                <input type="number" id="setting-sealDetUnclipRatio" step="0.1" min="0" value="0.5"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label for="setting-sealRecScoreThresh"
                                    style="color: #e0e0e0; font-size: 0.9em;">Recognition Score Threshold</label>
                                <input type="number" id="setting-sealRecScoreThresh" step="0.1" min="0" value="0.0"
                                    style="padding: 6px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: #e0e0e0; width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="resetExtractionSettings()"
                        style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ðŸ”„
                        Reset to Defaults</button>
                    <button onclick="toggleExtractionSettings()"
                        style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">âœ“
                        Apply & Close</button>
                </div>
            </div>

            <!-- Costing Card Section -->
            <div class="card" id="costingCard" style="display:none;">
                <h2>Apply Costing Factors</h2>
                <div class="costing-card">
                    <div class="factor-control">
                        <div class="factor-label">
                            <span>Net Margin (%)</span>
                            <span class="factor-value" id="netMarginValue">0%</span>
                        </div>
                        <input type="range" min="0" max="100" value="0" step="0.5" class="slider" id="netMarginSlider">
                    </div>

                    <div class="factor-control">
                        <div class="factor-label">
                            <span>Freight (%)</span>
                            <span class="factor-value" id="freightValue">0%</span>
                        </div>
                        <input type="range" min="0" max="50" value="0" step="0.5" class="slider" id="freightSlider">
                    </div>

                    <div class="factor-control">
                        <div class="factor-label">
                            <span>Customs (%)</span>
                            <span class="factor-value" id="customsValue">0%</span>
                        </div>
                        <input type="range" min="0" max="50" value="0" step="0.5" class="slider" id="customsSlider">
                    </div>

                    <div class="factor-control">
                        <div class="factor-label">
                            <span>Installation (%)</span>
                            <span class="factor-value" id="installationValue">0%</span>
                        </div>
                        <input type="range" min="0" max="50" value="0" step="0.5" class="slider"
                            id="installationSlider">
                    </div>

                    <div class="factor-control">
                        <div class="factor-label">
                            <span>Exchange Rate</span>
                            <span class="factor-value" id="exchangeRateValue">1.00</span>
                        </div>
                        <input type="range" min="0.1" max="10" value="1" step="0.01" class="slider"
                            id="exchangeRateSlider">
                    </div>

                    <div class="factor-control">
                        <div class="factor-label">
                            <span>Additional (%)</span>
                            <span class="factor-value" id="additionalValue">0%</span>
                        </div>
                        <input type="range" min="0" max="50" value="0" step="0.5" class="slider" id="additionalSlider">
                    </div>

                    <div class="costing-actions">
                        <button class="btn btn-primary" onclick="applyCosting()">ðŸŽ¯ Apply Costing</button>
                    </div>
                </div>
            </div>

            <!-- Costed BOQ Preview Section (Separate Card) -->
            <div class="card" id="costingPreviewCard" style="display:none;">
                <h2>ðŸ“Š Costed BOQ Preview</h2>
                <div id="costedTableContent"></div>
                <div class="summary-section" id="costingSummary"></div>
            </div>

            <!-- Offer Actions Card (Shows after costing) -->
            <div class="card" id="offerActionsCard" style="display:none;">
                <h2>ðŸ“„ Generate Documents</h2>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-success" onclick="generateOffer('pdf')">ðŸ“„ Download Offer (PDF)</button>
                    <button class="btn btn-success" onclick="generateOffer('excel')">ðŸ“Š Download Offer (Excel)</button>
                </div>
            </div>

            <!-- Presentation Generator Card (Costed) -->
            <div class="card" id="presentationCardCosted" style="display:none;">
                <h2>ðŸŽ¨ Presentation Generator</h2>
                <p style="color: #64748b; margin-bottom: 20px;">Generate professional presentation with product images
                    and details (one slide per item). Includes costing information.</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-info" onclick="generatePresentation('pptx')" style="flex: 1;">ðŸ“Š Generate
                        PowerPoint (PPTX)</button>
                    <button class="btn btn-primary" onclick="generatePresentation('pdf')" style="flex: 1;">ðŸ“„ Generate
                        PDF</button>
                </div>
            </div>

            <!-- MAS Generator Card (Costed) -->
            <div class="card" id="masCardCosted" style="display:none;">
                <h2>ðŸ“‹ MAS Generator</h2>
                <p style="color: #64748b; margin-bottom: 20px;">Generate Material Approval Submission documents in A4
                    portrait format with 1 page per item, including product images and technical specifications.
                    Includes costing information.</p>
                <button class="btn btn-warning" onclick="generateMASFromCosting()">ðŸ“‹ Generate MAS PDF</button>
            </div>

            <!-- Presentation Generator Card -->
            <div class="card" id="presentationCard" style="display:none;">
                <h2>ðŸŽ¨ Presentation Generator</h2>
                <p style="color: #64748b; margin-bottom: 20px;">Generate professional presentation with product images
                    and details (one slide per item). Works with or without costing applied.</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-info" onclick="generatePresentation('pptx')" style="flex: 1;">ðŸ“Š Generate
                        PowerPoint (PPTX)</button>
                    <button class="btn btn-primary" onclick="generatePresentation('pdf')" style="flex: 1;">ðŸ“„ Generate
                        PDF</button>
                </div>
            </div>

            <!-- MAS Generator Card -->
            <div class="card" id="masCard" style="display:none;">
                <h2>ðŸ“‹ MAS Generator</h2>
                <p style="color: #64748b; margin-bottom: 20px;">Generate Material Approval Submission documents in A4
                    portrait format with 1 page per item, including product images and technical specifications. Works
                    with or without costing applied.</p>
                <button class="btn btn-warning" onclick="generateMAS()">ðŸ“‹ Generate MAS PDF</button>
            </div>

            <!-- Multi-Budget Card -->
            <div class="card" id="multiBudgetCard" style="display:none;">
                <h2>ðŸ’° Multi-Budget Offers</h2>
                <p style="color: #64748b; margin-bottom: 20px;">Create budget offers with product selection from scraped
                    brands. Works with extracted or costed tables.</p>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button id="generateFromBOQBtn" class="btn btn-primary"
                        onclick="if(typeof window.generateFromBOQ==='function'){window.generateFromBOQ();}else{alert('Function loading... Please refresh.');}"
                        style="flex: 1; min-width: 180px;">
                        ðŸ“‹ Generate from BOQ
                    </button>
                    <button id="createNewBOQBtn" class="btn btn-success"
                        onclick="if(typeof window.createNewBOQ==='function'){window.createNewBOQ();}else{alert('Function loading... Please refresh.');}"
                        style="flex: 1; min-width: 180px;">
                        âž• Create New BOQ
                    </button>
                    <button id="openAddBrandModalBtn" class="btn btn-secondary"
                        onclick="if(typeof window.openAddBrandModal==='function'){window.openAddBrandModal();}else{alert('Function loading... Please refresh.');}"
                        style="flex: 1; min-width: 180px;">
                        âž• Add Brand
                    </button>
                </div>

                <!-- Budget Tier Tabs -->
                <div class="budget-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #1a365d;">
                    <button id="budgetaryTab" class="budget-tab active" data-tier="budgetary"
                        onclick="if(typeof window.switchBudgetTab==='function'){window.switchBudgetTab('budgetary');}else{console.error('switchBudgetTab not found');}"
                        style="flex: 1; padding: 12px 20px; background: #1a365d; color: #d4af37; border: none; border-bottom: 3px solid #d4af37; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        ðŸ’° Budgetary
                    </button>
                    <button id="midRangeTab" class="budget-tab" data-tier="mid_range"
                        onclick="if(typeof window.switchBudgetTab==='function'){window.switchBudgetTab('mid_range');}else{console.error('switchBudgetTab not found');}"
                        style="flex: 1; padding: 12px 20px; background: #2d4a6b; color: #e0e0e0; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        â­ Mid-Range
                    </button>
                    <button id="highEndTab" class="budget-tab" data-tier="high_end"
                        onclick="if(typeof window.switchBudgetTab==='function'){window.switchBudgetTab('high_end');}else{console.error('switchBudgetTab not found');}"
                        style="flex: 1; padding: 12px 20px; background: #2d4a6b; color: #e0e0e0; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        ðŸ‘‘ High-End
                    </button>
                </div>

                <!-- Budgetary Table Container -->
                <div id="budgetaryTableContainer" class="budget-table-container" style="display: block;">
                    <div id="budgetaryTableWrapper"
                        style="overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 400px); border: 1px solid #ddd; border-radius: 8px; background: white; width: 100%;">
                        <div style="padding: 20px; text-align: center; color: #64748b;">
                            <p>No table data yet. Click "Generate from BOQ" or "Create New BOQ" to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Mid-Range Table Container -->
                <div id="mid_rangeTableContainer" class="budget-table-container" style="display: none;">
                    <div id="mid_rangeTableWrapper"
                        style="overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 400px); border: 1px solid #ddd; border-radius: 8px; background: white; width: 100%;">
                        <div style="padding: 20px; text-align: center; color: #64748b;">
                            <p>No table data yet. Click "Generate from BOQ" or "Create New BOQ" to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- High-End Table Container -->
                <div id="high_endTableContainer" class="budget-table-container" style="display: none;">
                    <div id="high_endTableWrapper"
                        style="overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 400px); border: 1px solid #ddd; border-radius: 8px; background: white; width: 100%;">
                        <div style="padding: 20px; text-align: center; color: #64748b;">
                            <p>No table data yet. Click "Generate from BOQ" or "Create New BOQ" to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Export Buttons -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #1a365d;">
                    <h3 style="color: #1a365d; margin-bottom: 15px;">Export Options</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="exportMultiBudget('offer', 'pdf')"
                            style="flex: 1; min-width: 150px;">
                            ðŸ“„ Download Offer PDF
                        </button>
                        <button class="btn btn-info" onclick="exportMultiBudget('offer', 'excel')"
                            style="flex: 1; min-width: 150px;">
                            ðŸ“Š Download Offer Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportMultiBudget('presentation', 'pptx')"
                            style="flex: 1; min-width: 150px;">
                            ðŸ“Š Generate PowerPoint
                        </button>
                        <button class="btn btn-primary" onclick="exportMultiBudget('presentation', 'pdf')"
                            style="flex: 1; min-width: 150px;">
                            ðŸ“„ Generate PDF
                        </button>
                        <button class="btn btn-warning" onclick="exportMultiBudget('mas', 'pdf')"
                            style="flex: 1; min-width: 150px;">
                            ðŸ“‹ Generate MAS PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Background Scraping Jobs Tray (Minimized) -->
            <div id="backgroundJobsTray"
                style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 9999; background: linear-gradient(135deg, #1a365d 0%, #2d5a8e 100%); border: 2px solid #d4af37; border-radius: 12px; padding: 15px; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="color: #d4af37; margin: 0; font-size: 1.1em;">ðŸ”„ Background Scraping</h3>
                    <button onclick="restoreAddBrandModal()"
                        style="background: transparent; border: none; color: #d4af37; font-size: 18px; cursor: pointer; padding: 0; width: 24px; height: 24px;">â¤´ï¸</button>
                </div>
                <div id="backgroundJobsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Jobs will be added here -->
                </div>
            </div>

            <!-- Add Brand Modal -->
            <div id="addBrandModal" class="modal"
                style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);"
                onclick="handleModalClick(event)">
                <div class="modal-content" onclick="event.stopPropagation()"
                    style="background-color: #1e293b; margin: 5% auto; padding: 30px; border: 2px solid #d4af37; border-radius: 12px; width: 90%; max-width: 600px; color: #e0e0e0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #d4af37; margin: 0;">âž• Add New Brand</h2>
                        <div>
                            <button onclick="minimizeAddBrandModal()"
                                style="background: transparent; border: none; color: #d4af37; font-size: 24px; cursor: pointer; padding: 0 10px; margin-right: 10px; line-height: 1;"
                                title="Minimize (keeps scraping running)">âž–</button>
                            <span class="modal-close" onclick="closeAddBrandModal()"
                                style="color: #d4af37; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
                        </div>
                    </div>
                    <p style="color: #94a3b8; margin-bottom: 25px;">Enter brand website or Architonic collection link to
                        scrape products automatically.</p>

                    <form id="addBrandFormActive" onsubmit="handleAddBrand(event)">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Brand
                                Name *</label>
                            <input type="text" id="brandNameInput" required
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;"
                                placeholder="e.g., Herman Miller">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label
                                style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Website
                                or Architonic Link *</label>
                            <input type="url" id="brandWebsiteInput" required
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;"
                                placeholder="https://www.example.com or https://www.architonic.com/...">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Origin
                                (Country)</label>
                            <input type="text" id="brandCountryInput"
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;"
                                placeholder="e.g., USA">
                        </div>

                        <div style="margin-bottom: 25px;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Budget
                                Tier *</label>
                            <select id="brandTierInput" required
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;">
                                <option value="budgetary">ðŸ’° Budgetary</option>
                                <option value="mid_range" selected>â­ Mid-Range</option>
                                <option value="high_end">ðŸ‘‘ High-End</option>
                            </select>
                        </div>

                        <!-- Scraping Method -->
                        <div style="margin-bottom: 20px;">
                            <label
                                style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Scraping
                                Method *</label>
                            <select id="scrapingMethodInput" required onchange="toggleFirecrawlOptions()"
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;">
                                <option value="requests">ðŸš€ Requests Scraper (Recommended - No API Limits)</option>
                                <option value="firecrawl">ðŸ”¥ Firecrawl API (AI-Powered - Has API Limits)</option>
                                <option value="universal">âš¡ Universal Scraper (Legacy)</option>
                            </select>
                            <small style="color: #94a3b8; display: block; margin-top: 5px;">Universal is faster but may
                                miss some products. Firecrawl is more thorough.</small>
                        </div>

                        <!-- Firecrawl Options (shown only when Firecrawl is selected) -->
                        <div id="firecrawlOptionsInput" style="margin-bottom: 20px; display: none;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Max
                                Pages
                                to Crawl</label>
                            <input type="number" id="crawlLimitInput" value="50" min="1" max="200"
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;">
                            <small style="color: #94a3b8; display: block; margin-top: 5px;">Limit the number of pages to
                                crawl (default: 50)</small>
                        </div>

                        <div id="addBrandProgress" style="display: none; margin-bottom: 20px;">
                            <!-- Real-time Event Preview -->
                            <div id="scrapingEvents"
                                style="display: none; background: #0a0f1a; border: 1px solid #475569; border-radius: 6px; padding: 12px; margin-bottom: 12px; max-height: 150px; overflow-y: auto; font-size: 0.85em;">
                                <div
                                    style="color: #d4af37; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>ðŸ”´ Live Scraping Events</span>
                                    <span id="eventCount" style="color: #94a3b8; font-size: 0.9em;">0 events</span>
                                </div>
                                <div id="eventsList" style="color: #e0e0e0; line-height: 1.6;">
                                    <!-- Events will be added here -->
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div style="background: #0f172a; border-radius: 6px; padding: 15px;">
                                <div style="color: #e0e0e0; margin-bottom: 10px;" id="progressText">Starting scrape...
                                </div>
                                <div style="background: #475569; border-radius: 4px; height: 20px; overflow: hidden;">
                                    <div id="progressBar"
                                        style="background: linear-gradient(90deg, #d4af37, #ffd700); height: 100%; width: 0%; transition: width 0.3s;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="addBrandResult"
                            style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 6px; background: #0f172a;">
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeAddBrandModal()"
                                style="padding: 12px 24px;">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="scrapeBrandBtn"
                                style="padding: 12px 24px; background: #d4af37; color: #1a365d; font-weight: bold; cursor: pointer;">
                                ðŸ” Get Products
                            </button>
                        </div>
                    </form>

                    <!-- Download/Upload Database Section -->
                    <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #475569;">
                        <h3 style="color: #d4af37; margin-bottom: 20px; font-size: 1.2em;">ðŸ“¥ Database Management</h3>
                        <p style="color: #94a3b8; margin-bottom: 20px; font-size: 0.9em;">Download or upload brand
                            database as Excel for manual editing.</p>

                        <!-- Budget Tier Selection (moved to top) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Budget
                                Tier</label>
                            <select id="dbTierSelect"
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;">
                                <option value="budgetary">ðŸ’° Budgetary</option>
                                <option value="mid_range" selected>â­ Mid-Range</option>
                                <option value="high_end">ðŸ‘‘ High-End</option>
                            </select>
                        </div>

                        <!-- Brand Selection for Download/Upload (moved below tier) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Select
                                Brand</label>
                            <select id="dbBrandSelect"
                                style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #0f172a; color: #e0e0e0; font-size: 14px;">
                                <option value="">-- Select Brand --</option>
                            </select>
                        </div>

                        <!-- Download Database Button -->
                        <div style="margin-bottom: 15px;">
                            <button type="button" onclick="downloadBrandDatabase()" class="btn btn-primary"
                                style="width: 100%; padding: 12px 24px; background: #10b981; color: white; font-weight: bold; cursor: pointer; border: none; border-radius: 6px;">
                                ðŸ“¥ Download Database (Excel)
                            </button>
                        </div>

                        <!-- Upload Database Section -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #475569;">
                            <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: bold;">Upload
                                Updated Excel File</label>
                            <!-- Hidden file input -->
                            <input type="file" id="dbFileUpload" accept=".xlsx,.xls" style="display: none;"
                                onchange="uploadBrandDatabase()">
                            <!-- Button triggers file input -->
                            <button type="button" onclick="document.getElementById('dbFileUpload').click()"
                                class="btn btn-primary"
                                style="width: 100%; padding: 12px 24px; background: #3b82f6; color: white; font-weight: bold; cursor: pointer; border: none; border-radius: 6px;">
                                ðŸ“¤ Upload Database (Excel)
                            </button>
                        </div>

                        <!-- Upload Progress/Result -->
                        <div id="dbUploadProgress" style="display: none; margin-top: 15px;">
                            <div style="background: #0f172a; border-radius: 6px; padding: 15px;">
                                <div style="color: #e0e0e0; margin-bottom: 10px;" id="dbUploadText">Uploading...</div>
                                <div style="background: #475569; border-radius: 4px; height: 20px; overflow: hidden;">
                                    <div id="dbUploadBar"
                                        style="background: linear-gradient(90deg, #3b82f6, #60a5fa); height: 100%; width: 0%; transition: width 0.3s;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="dbUploadResult"
                            style="display: none; margin-top: 15px; padding: 15px; border-radius: 6px; background: #0f172a;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Notification -->
    <div class="upload-notification" id="uploadNotification">
        <div class="upload-notification-content">
            <div class="upload-notification-icon">ðŸ“¤</div>
            <div class="upload-notification-text">
                <div class="upload-notification-title" id="notificationTitle">File Uploaded!</div>
                <div class="upload-notification-subtitle" id="notificationSubtitle">Processing...</div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()" title="Close (ESC)"
                aria-label="Close image">&times;</button>
            <img id="modalImage" style="max-width: 100%; height: auto; border-radius: 8px;">
        </div>
    </div>

    <!-- Workflow Templates (Keep for backwards compatibility, hidden) -->
    <div id="workflowTemplates" style="display: none;">
        <!-- Quote with Price List Workflow -->
        <div id="workflow-quote-pricelist" class="feature-card">
            <div class="workflow-container">
                <div class="workflow-header">
                    <div class="workflow-title">
                        <span>ðŸ’°</span>
                        <span>Quote with Price List</span>
                    </div>
                    <button class="close-btn" onclick="closeWorkflow()">Ã—</button>
                </div>
                <div class="workflow-content">
                    <!-- Step 1: Upload -->
                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Upload Your Files</div>
                        </div>
                        <div class="upload-zone" id="upload-quote-pricelist"
                            onclick="document.getElementById('file-quote-pricelist').click()">
                            <div class="upload-icon">ðŸ“¤</div>
                            <div class="upload-text">Drop your BOQ & Price List here</div>
                            <div class="upload-subtext">Supported: PDF, XLSX, XLS, JPG, PNG (Max 50MB)</div>
                            <input type="file" id="file-quote-pricelist" multiple
                                accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png">
                        </div>
                        <div class="file-info" id="fileinfo-quote-pricelist">
                            <div class="file-name">âœ“ Files uploaded successfully!</div>
                        </div>
                    </div>

                    <!-- Step 2: Process -->
                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">Process & Extract</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="processFiles('quote-pricelist')">
                                ðŸš€ Extract Data
                            </button>
                            <button class="btn btn-secondary">
                                âš™ï¸ Advanced Settings
                            </button>
                        </div>
                        <div class="loading-overlay" id="loading-quote-pricelist">
                            <div class="spinner-wrapper">
                                <div class="spinner"></div>
                            </div>
                            <div class="loading-text">Processing your files...</div>
                            <div class="loading-subtext">AI is extracting and analyzing BOQ data</div>
                        </div>
                    </div>

                    <!-- Step 3: Results & Export -->
                    <div class="results-section" id="results-quote-pricelist">
                        <div class="results-header">
                            <div class="results-title">âœ… Quote Generated!</div>
                        </div>
                        <div class="preview-container" id="preview-quote-pricelist">
                            <!-- Preview content will be inserted here -->
                        </div>
                        <div class="export-section">
                            <div class="export-title">
                                <span>ðŸ’¾</span>
                                <span>Export Your Quote</span>
                            </div>
                            <div class="export-buttons">
                                <button class="export-btn" onclick="exportFile('quote-pricelist', 'pdf')">
                                    <span>ðŸ“„</span> Download PDF
                                </button>
                                <button class="export-btn" onclick="exportFile('quote-pricelist', 'excel')">
                                    <span>ðŸ“Š</span> Download Excel
                                </button>
                                <button class="export-btn" onclick="exportFile('quote-pricelist', 'word')">
                                    <span>ðŸ“</span> Download Word
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="error-message" id="error-quote-pricelist"></div>
                </div>
            </div>
        </div>

        <!-- Multi-Budget Workflow -->
        <div id="workflow-multi-budget" class="feature-card">
            <div class="workflow-container">
                <div class="workflow-header">
                    <div class="workflow-title">
                        <span>ðŸŽ¯</span>
                        <span>Multi-Budget Offers</span>
                    </div>
                    <button class="close-btn" onclick="closeWorkflow()">Ã—</button>
                </div>
                <div class="workflow-content">
                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Upload BOQ (No Prices Needed)</div>
                        </div>
                        <div class="upload-zone" id="upload-multi-budget"
                            onclick="document.getElementById('file-multi-budget').click()">
                            <div class="upload-icon">ðŸ“¤</div>
                            <div class="upload-text">Drop your BOQ here</div>
                            <div class="upload-subtext">AI will generate pricing - No price list required! (PDF, XLSX,
                                XLS)</div>
                            <input type="file" id="file-multi-budget" multiple accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png">
                        </div>
                        <div class="file-info" id="fileinfo-multi-budget">
                            <div class="file-name">âœ“ Files uploaded successfully!</div>
                        </div>
                    </div>

                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">AI Processing</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="processFiles('multi-budget')">
                                ðŸ¤– Generate Budget Options
                            </button>
                        </div>
                        <div class="loading-overlay" id="loading-multi-budget">
                            <div class="spinner-wrapper">
                                <div class="spinner"></div>
                            </div>
                            <div class="loading-text">AI is analyzing your BOQ...</div>
                            <div class="loading-subtext">Creating 3 budget tier options</div>
                        </div>
                    </div>

                    <div class="results-section" id="results-multi-budget">
                        <div class="results-header">
                            <div class="results-title">âœ… Budget Options Ready!</div>
                        </div>
                        <div class="preview-container" id="preview-multi-budget"></div>
                        <div class="export-section">
                            <div class="export-title">
                                <span>ðŸ’¾</span>
                                <span>Export Budget Options</span>
                            </div>
                            <div class="export-buttons">
                                <button class="export-btn" onclick="exportFile('multi-budget', 'pdf')">
                                    <span>ðŸ“„</span> Download PDF
                                </button>
                                <button class="export-btn" onclick="exportFile('multi-budget', 'excel')">
                                    <span>ðŸ“Š</span> Download Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="error-message" id="error-multi-budget"></div>
                </div>
            </div>
        </div>

        <!-- Presentation Generator Workflow -->
        <div id="workflow-presentation" class="feature-card">
            <div class="workflow-container">
                <div class="workflow-header">
                    <div class="workflow-title">
                        <span>ðŸŽ¨</span>
                        <span>Presentation Generator</span>
                    </div>
                    <button class="close-btn" onclick="closeWorkflow()">Ã—</button>
                </div>
                <div class="workflow-content">
                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Upload BOQ with Images</div>
                        </div>
                        <div class="upload-zone" id="upload-presentation"
                            onclick="document.getElementById('file-presentation').click()">
                            <div class="upload-icon">ðŸŽ¨</div>
                            <div class="upload-text">Drop your BOQ & Product Images</div>
                            <div class="upload-subtext">Create stunning presentations (PDF, XLSX, JPG, PNG)</div>
                            <input type="file" id="file-presentation" multiple accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png">
                        </div>
                        <div class="file-info" id="fileinfo-presentation">
                            <div class="file-name">âœ“ Files uploaded successfully!</div>
                        </div>
                    </div>

                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">Generate Slides</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="processFiles('presentation')">
                                ðŸŽ¬ Create Presentation
                            </button>
                        </div>
                        <div class="loading-overlay" id="loading-presentation">
                            <div class="spinner-wrapper">
                                <div class="spinner"></div>
                            </div>
                            <div class="loading-text">Creating your presentation...</div>
                            <div class="loading-subtext">AI is designing professional slides</div>
                        </div>
                    </div>

                    <div class="results-section" id="results-presentation">
                        <div class="results-header">
                            <div class="results-title">âœ… Presentation Ready!</div>
                        </div>
                        <div class="preview-container" id="preview-presentation"></div>
                        <div class="export-section">
                            <div class="export-title">
                                <span>ðŸ’¾</span>
                                <span>Download Presentation</span>
                            </div>
                            <div class="export-buttons">
                                <button class="export-btn" onclick="exportFile('presentation', 'pptx')">
                                    <span>ðŸ“Š</span> Download PowerPoint
                                </button>
                                <button class="export-btn" onclick="exportFile('presentation', 'pdf')">
                                    <span>ðŸ“„</span> Download PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="error-message" id="error-presentation"></div>
                </div>
            </div>
        </div>

        <!-- MAS Generator Workflow -->
        <div id="workflow-mas" class="feature-card">
            <div class="workflow-container">
                <div class="workflow-header">
                    <div class="workflow-title">
                        <span>ðŸ“‹</span>
                        <span>MAS Generator</span>
                    </div>
                    <button class="close-btn" onclick="closeWorkflow()">Ã—</button>
                </div>
                <div class="workflow-content">
                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Upload BOQ Data</div>
                        </div>
                        <div class="upload-zone" id="upload-mas" onclick="document.getElementById('file-mas').click()">
                            <div class="upload-icon">ðŸ“‹</div>
                            <div class="upload-text">Drop your BOQ here</div>
                            <div class="upload-subtext">Generate Material Approval Sheets (PDF, XLSX, XLS)</div>
                            <input type="file" id="file-mas" multiple accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png">
                        </div>
                        <div class="file-info" id="fileinfo-mas">
                            <div class="file-name">âœ“ Files uploaded successfully!</div>
                        </div>
                    </div>

                    <div class="step-section">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">Generate MAS</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="processFiles('mas')">
                                ðŸ“ Generate Approval Sheets
                            </button>
                        </div>
                        <div class="loading-overlay" id="loading-mas">
                            <div class="spinner-wrapper">
                                <div class="spinner"></div>
                            </div>
                            <div class="loading-text">Generating MAS documents...</div>
                            <div class="loading-subtext">Extracting material specifications</div>
                        </div>
                    </div>

                    <div class="results-section" id="results-mas">
                        <div class="results-header">
                            <div class="results-title">âœ… MAS Documents Ready!</div>
                        </div>
                        <div class="preview-container" id="preview-mas"></div>
                        <div class="export-section">
                            <div class="export-title">
                                <span>ðŸ’¾</span>
                                <span>Download MAS</span>
                            </div>
                            <div class="export-buttons">
                                <button class="export-btn" onclick="exportFile('mas', 'pdf')">
                                    <span>ðŸ“„</span> Download PDF
                                </button>
                                <button class="export-btn" onclick="exportFile('mas', 'excel')">
                                    <span>ðŸ“Š</span> Download Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="error-message" id="error-mas"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Image modal function for click-to-enlarge
        function openImageModal(imagePath, imageId) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); cursor: pointer;';
                modal.innerHTML = `
                    <span style="position: absolute; top: 20px; right: 40px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
                    <img id="modalImage" style="margin: auto; display: block; max-width: 90%; max-height: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #f1f1f1; font-size: 16px; text-align: center; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 8px;">Click anywhere to close</div>
                `;
                document.body.appendChild(modal);
                modal.onclick = function() { closeImageModal(); };
            }
            
            // Show modal with image
            document.getElementById('modalImage').src = imagePath;
            modal.style.display = 'block';
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) modal.style.display = 'none';
        }

        // Session and state management
        let uploadedFiles = [];
        let currentWorkflow = null;

        // Hero section functions

        // Initialize hero animations (removed - no longer needed)

        // Make createFileItem available globally BEFORE loadFileList uses it
        // This function creates a file item element for the file list
        window.createFileItem = function createFileItem(file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = `file-${file.id}`;

            console.log('Creating file item for:', file.original_name, 'ID:', file.id);

            // Determine status class
            let statusClass = 'status-uploaded';
            let statusText = 'Uploaded';
            if (file.status === 'extracted') {
                statusClass = 'status-extracted';
                statusText = 'Extracted';
            } else if (file.status === 'processing') {
                statusClass = 'status-processing';
                statusText = 'Processing';
            }

            // Format file size if available
            let fileSizeHtml = '';
            if (file.size) {
                const sizeKB = (file.size / 1024).toFixed(2);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const displaySize = file.size > 1048576 ? `${sizeMB} MB` : `${sizeKB} KB`;
                fileSizeHtml = `<div class="file-size">${displaySize}</div>`;
            }

            const fileName = file.original_name || 'Unnamed File';
            console.log('Setting file name to:', fileName);

            // Create the HTML structure with vertical layout
            div.innerHTML = `
                <div class="file-info" style="display: block; visibility: visible;">
                    <div class="file-name" style="display: flex; visibility: visible; margin-bottom: 15px;">
                        <span class="file-name-text">${fileName}</span>
                    </div>
                    <div class="file-meta" style="display: flex; visibility: visible;">
                        <div class="file-status ${statusClass}">${statusText}</div>
                        ${fileSizeHtml}
                    </div>
                </div>
                <div class="file-actions">
                    <button class="action-btn btn-primary" onclick="extractTable('${file.id}')">ðŸŽ¯ Extract</button>
                    <button class="action-btn btn-secondary" onclick="toggleExtractionSettings()" title="Advanced Extraction Settings">âš™ï¸ Settings</button>
                    <button class="action-btn btn-success" onclick="openCosting('${file.id}')">ðŸ’° Costing</button>
                    <button class="action-btn btn-info" onclick="downloadExtracted('${file.id}', 'excel')" style="display:none;" id="download-${file.id}">ðŸ“¥ Excel</button>
                    <button class="action-btn btn-danger" onclick="deleteFile('${file.id}')">ðŸ—‘ï¸ Delete</button>
                </div>
            `;

            // Add mouse tracking for hover effect
            div.addEventListener('mousemove', (e) => {
                const rect = div.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                div.style.setProperty('--mouse-x', x + '%');
                div.style.setProperty('--mouse-y', y + '%');
            });

            console.log('File item created, HTML:', div.innerHTML.substring(0, 200));

            return div;
        };

        // Make loadFileList available globally BEFORE it's called
        // This function loads the list of uploaded files from the server
        window.loadFileList = async function loadFileList() {
            try {
                console.log('loadFileList called');
                const response = await fetch('/files');
                const data = await response.json();

                console.log('Loading file list, received:', data);

                const fileCountBadge = document.getElementById('fileCount');
                const fileList = document.getElementById('fileList');

                if (!fileList) {
                    console.error('fileList element not found!');
                    return;
                }

                if (data.files && data.files.length > 0) {
                    console.log('Found', data.files.length, 'files');

                    // Update file count badge
                    if (fileCountBadge) {
                        fileCountBadge.textContent = data.files.length;
                    }

                    fileList.innerHTML = '';
                    data.files.forEach((file, index) => {
                        console.log('Adding file:', file.original_name, 'with ID:', file.id);
                        const fileItem = window.createFileItem ? window.createFileItem(file) : createFileItem(file);
                        // Add staggered animation delay
                        fileItem.style.animationDelay = `${index * 0.1}s`;
                        fileList.appendChild(fileItem);
                    });
                } else {
                    console.log('No files found');

                    // Update file count badge
                    if (fileCountBadge) {
                        fileCountBadge.textContent = '0';
                    }

                    fileList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                            <div style="font-size: 4em; margin-bottom: 15px; opacity: 0.5;">ðŸ“‚</div>
                            <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;">No files uploaded yet</p>
                            <p style="font-size: 0.95em; opacity: 0.8;">Upload files to get started</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        };

        // Initialize on page load
        // Note: loadFileList removed as uploaded files card is no longer displayed

        // Initialize particles
        function createParticles() {
            const container = document.getElementById('bgParticles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = Math.random() * 100 + 50 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 5 + 's';
                particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
                container.appendChild(particle);
            }
        }

        createParticles();

        // Open workflow
        function openWorkflow(cardType) {
            currentWorkflow = cardType;
            const card = document.querySelector(`[data-card="${cardType}"]`);
            const cardsContainer = document.getElementById('cardsContainer');

            // Hide main content (header removed)
            cardsContainer.style.display = 'none';

            // Expand card
            card.classList.add('expanded');
            card.querySelector('.workflow-container').classList.add('active');
        }

        // Close workflow
        function closeWorkflow() {
            const expandedCard = document.querySelector('.feature-card.expanded');
            if (expandedCard) {
                expandedCard.classList.remove('expanded');
                expandedCard.querySelector('.workflow-container').classList.remove('active');
            }

            const cardsContainer = document.getElementById('cardsContainer');

            // Header removed - no need to show
            cardsContainer.style.display = 'grid';
            currentWorkflow = null;
        }

        // Return to hero section
        function returnToHome() {
            const heroSection = document.getElementById('heroSection');
            const cardsContainer = document.getElementById('cardsContainer');
            const mainAppContainer = document.getElementById('mainAppContainer');

            // Close any open workflow first
            const expandedCard = document.querySelector('.feature-card.expanded');
            if (expandedCard) {
                expandedCard.classList.remove('expanded');
                const workflowContainer = expandedCard.querySelector('.workflow-container');
                if (workflowContainer) {
                    workflowContainer.classList.remove('active');
                }
            }

            // Hide all workflow-specific cards
            if (typeof hideAllWorkflowCards === 'function') {
                hideAllWorkflowCards();
            }

            // Hide main app container
            if (mainAppContainer) {
                mainAppContainer.style.display = 'none';
                mainAppContainer.style.opacity = '0';
            }

            // Hide cards container (if it exists separately)
            if (cardsContainer) {
                cardsContainer.style.display = 'none';
            }

            // Show hero section with cards (this is the main app page with cards)
            if (heroSection) {
                // Ensure hero section is visible
                heroSection.style.display = 'flex';
                heroSection.style.visibility = 'visible';

                // Fade in with smooth transition
                heroSection.style.opacity = '0';
                heroSection.style.transition = 'opacity 0.6s ease-in';

                // Force reflow and then fade in
                heroSection.offsetHeight; // Force reflow
                setTimeout(() => {
                    heroSection.style.opacity = '1';
                }, 10);
            }

            // Scroll to top smoothly after a brief delay
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);

            // Reset workflow state
            window.currentWorkflowType = null;
        }

        // Navigate to landing page
        function goToLandingPage() {
            window.location.href = '/landing';
        }

        // File upload handling with backend integration
        document.querySelectorAll('input[type="file"]').forEach(input => {
            // Prevent duplicate event listeners
            if (input.dataset.uploadListenerAdded === 'true') {
                return;
            }
            input.dataset.uploadListenerAdded = 'true';

            input.addEventListener('change', async function (e) {
                const fileInfo = document.getElementById('fileinfo-' + this.id.replace('file-', ''));
                const files = this.files;

                if (files.length > 0) {
                    // Prevent duplicate uploads - check if already uploading
                    if (this.dataset.uploading === 'true') {
                        console.warn('Upload already in progress, skipping duplicate');
                        return;
                    }
                    
                    // Mark as uploading
                    this.dataset.uploading = 'true';
                    
                    // Show upload progress popup (similar to file generation popup)
                    const uploadPopup = showProgressPopup('Preparing upload...');
                    updateProgressPopup(0, 'Starting upload...');

                    // Upload files to backend
                    uploadedFiles = [];
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        try {
                            // Update progress - uploading phase (30%)
                            const uploadProgress = Math.round(((i + 0.3) / files.length) * 100);
                            updateProgressPopup(uploadProgress, `ðŸ“¤ Uploading: ${file.name} (${Math.round(file.size / 1024)} KB)`);
                            
                            const result = await uploadFileSimple(file);
                            console.log('Upload result:', result);
                            
                            // Update progress - extraction phase (70%)
                            const extractProgress = Math.round(((i + 0.7) / files.length) * 100);
                            updateProgressPopup(extractProgress, `ðŸ” Extracting tables from: ${file.name}`);
                            
                            // Small delay to show extraction message
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            if (result && result.success) {
                                uploadedFiles.push({
                                    id: result.file_id,
                                    original_name: result.filename || file.name,
                                    filename: result.filename || file.name,
                                    extraction_success: result.extraction_success,
                                    extraction_error: result.extraction_error
                                });
                                
                                // Update progress to completed for this file (100%)
                                const finalProgress = Math.round(((i + 1) / files.length) * 100);
                                updateProgressPopup(finalProgress, `âœ… Success: Extracted ${file.name} (${result.tables_found || 0} tables found)`);
                            } else {
                                console.error('Upload failed:', result?.error || 'Unknown error');
                                updateProgressPopup(uploadProgress, `âŒ Failed: Could not upload ${file.name}`);
                            }
                        } catch (error) {
                            console.error('Error uploading file:', error);
                            updateProgressPopup(0, `âŒ Error: ${error.message || 'Upload failed'}`);
                        }
                    }

                    console.log('Uploaded files array:', uploadedFiles);

                    console.log('ðŸ”¥ðŸ”¥ðŸ”¥ NEW CODE LOADED - CHECKING LENGTH ðŸ”¥ðŸ”¥ðŸ”¥');
                    
                    // Mark as no longer uploading
                    this.dataset.uploading = 'false';

                    console.log('About to check uploadedFiles.length:', uploadedFiles.length);
                    console.log('Condition check:', uploadedFiles.length > 0);
                    
                    if (uploadedFiles.length > 0) {
                        console.log('Processing uploaded files for auto-display...');
                        
                        // Update progress popup to 100%
                        updateProgressPopup(100, `ðŸŽ‰ Complete! Processing ${uploadedFiles.length} file(s) - Displaying tables...`);
                        
                        // Keep the progress display visible for a moment
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Auto-display extracted tables for each uploaded file
                        for (const uploadedFile of uploadedFiles) {
                            console.log('Checking file for auto-display:', uploadedFile);
                            console.log('  - id:', uploadedFile.id);
                            console.log('  - extraction_success:', uploadedFile.extraction_success);
                            
                            if (uploadedFile.id && uploadedFile.extraction_success) {
                                console.log('Auto-displaying tables for file:', uploadedFile.id);
                                // Call the auto-stitch function
                                if (typeof autoStitchAndDisplayTables === 'function') {
                                    try {
                                        await autoStitchAndDisplayTables(uploadedFile.id);
                                        console.log('Auto-stitch completed for:', uploadedFile.id);
                                    } catch (error) {
                                        console.error('Error auto-stitching:', error);
                                    }
                                } else {
                                    console.error('autoStitchAndDisplayTables function not found!');
                                }
                            } else {
                                console.log('Skipping auto-display: extraction_success =', uploadedFile.extraction_success);
                            }
                        }
                        
                        // Close the popup
                        closeProgressPopup();
                        
                        // Show success notification
                        showUploadNotification('Success!', `âœ“ ${uploadedFiles.length} file(s) extracted successfully!`, 'âœ…');
                        
                        // File list refresh removed as uploaded files card is no longer displayed
                    } else {
                        // Close popup on error
                        closeProgressPopup();
                        
                        if (fileInfo) {
                            fileInfo.classList.remove('show');
                        }
                        // Only show error if error element exists (for workflow cards)
                        const cardType = this.id.replace('file-', '');
                        const errorElement = document.getElementById('error-' + cardType);
                        if (errorElement) {
                            showError(cardType, 'Failed to upload files');
                        } else {
                            console.error('Failed to upload files. No error element found for:', cardType);
                            // Show a general notification instead
                            if (typeof showUploadNotification === 'function') {
                                showUploadNotification('Upload Failed', 'Failed to upload files. Please try again.', 'âŒ');
                            }
                        }
                    }
                }
            });
        });

        // Upload file to backend (simplified version for workflow cards)
        async function uploadFileSimple(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Get extraction settings from upload area (use defaults if not available)
            try {
                const extractionSettings = typeof getUploadExtractionSettings === 'function'
                    ? getUploadExtractionSettings()
                    : {};
                formData.append('extraction_settings', JSON.stringify(extractionSettings));
                formData.append('auto_extract', 'true');
            } catch (e) {
                // If getUploadExtractionSettings doesn't exist, continue without it
                console.warn('Could not get extraction settings:', e);
            }

            try {
                // Use upload-and-extract endpoint with extended timeout for large files
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 minutes timeout

                const response = await fetch('/upload-and-extract', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
                    }
                    console.error('Upload failed:', errorData);
                    return { success: false, error: errorData.error || `HTTP ${response.status}` };
                }

                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    return { success: false, error: 'Invalid response from server' };
                }

                if (!result) {
                    console.error('Empty result from server');
                    return { success: false, error: 'Empty response from server' };
                }

                return result;
            } catch (error) {
                console.error('Upload error:', error);
                return { success: false, error: error.message || 'Unknown error occurred' };
            }
        }

        // Drag and drop for upload zones
        document.querySelectorAll('.upload-zone').forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const fileInput = zone.querySelector('input[type="file"]');
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });
        });

        // Process files with backend integration
        async function processFiles(cardType) {
            const loading = document.getElementById('loading-' + cardType);
            const results = document.getElementById('results-' + cardType);
            const error = document.getElementById('error-' + cardType);

            if (uploadedFiles.length === 0) {
                showError(cardType, 'Please upload files first');
                return;
            }

            // Show loading
            loading.classList.add('show');
            error.classList.remove('show');
            results.classList.remove('show');

            try {
                // Extract data from all uploaded files
                const extractions = [];
                // Get extraction settings from UI (same for all files)
                const settings = getExtractionSettings();

                for (let file of uploadedFiles) {
                    loading.querySelector('.loading-text').textContent =
                        `Processing ${file.original_name}...`;

                    // Extended timeout for large file extraction
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 minutes

                    const response = await fetch(`/extract/${file.id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    const result = await response.json();
                    if (result.success) {
                        extractions.push({ file: file, data: result.result });
                    }
                }

                if (extractions.length > 0) {
                    // Stitch tables if multiple files
                    if (extractions.length === 1) {
                        const stitchResponse = await fetch(`/stitch-tables/${extractions[0].file.id}`, {
                            method: 'POST'
                        });
                        const stitchResult = await stitchResponse.json();

                        if (stitchResult.success) {
                            // Don't display in workflow results - table is already shown in extracted tables section
                            // Just show a success message
                            displayResults(cardType, {
                                success: true,
                                message: 'Tables extracted and stitched successfully',
                                row_count: stitchResult.row_count,
                                page_count: stitchResult.page_count,
                                file: extractions[0].file
                            }, extractions[0].file);
                        }
                    } else {
                        displayResults(cardType, { success: true, extractions: extractions }, null);
                    }

                    loading.classList.remove('show');
                    results.classList.add('show');
                } else {
                    throw new Error('No data extracted from files');
                }
            } catch (err) {
                loading.classList.remove('show');
                showError(cardType, err.message || 'Processing failed');
            }
        }

        // Display results
        function displayResults(cardType, data, file) {
            const preview = document.getElementById('preview-' + cardType);

            let html = `
                <div style="padding: 30px; background: rgba(26, 54, 93, 0.95); border-radius: 15px; border: 2px solid #10b981;">
                    <h3 style="color: #059669; margin-bottom: 20px; font-size: 1.5em;">âœ… Processing Complete!</h3>
            `;

            // Always show success message - table is displayed in extracted tables section
            html += `
                <div style="padding: 20px; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #10b981;">
                    <strong style="color: #059669; font-size: 1.2em;">
                        ${data.stitched_html ? 'ðŸ“Š Table Stitched Successfully!' : 'âœ… Processing Complete!'}
                    </strong>
                    <p style="color: #475569; margin-top: 10px; line-height: 1.8;">
                        ${data.stitched_html ? 'The table has been extracted and stitched from all pages. Scroll down to view and edit the full table.' :
                    data.extractions ? `Your BOQ has been successfully processed. Processed ${data.extractions.length} file(s).` :
                        'Your data has been successfully processed.'}
                    </p>
                    ${data.row_count ? `
                        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                            <strong style="color: #1a365d;">Summary:</strong>
                            <ul style="margin-top: 10px; color: #475569; line-height: 2;">
                                <li>âœ… Total Rows: ${data.row_count || 'N/A'}</li>
                                <li>ðŸ“„ Pages Processed: ${data.page_count || 'N/A'}</li>
                                <li>ðŸ“Ž File: ${file ? file.original_name : 'Multiple files'}</li>
                        </ul>
                        </div>
                        <button onclick="document.getElementById('extractedTablesCard').scrollIntoView({behavior: 'smooth'})" 
                                style="margin-top: 15px; padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ðŸ‘‡ View Editable Table Below
                        </button>
                    ` : ''}
                    </div>
                `;

            html += '</div>';
            preview.innerHTML = html;

            // Store file ID for export
            if (file) {
                preview.dataset.fileId = file.id;
            }
        }

        // Show error message
        function showError(cardType, message) {
            const error = document.getElementById('error-' + cardType);
            if (!error) {
                console.error(`Error element not found for cardType: ${cardType}`);
                console.error('Error message:', message);
                return;
            }
            error.textContent = 'âš ï¸ Error: ' + message;
            error.classList.add('show');

            setTimeout(() => {
                error.classList.remove('show');
            }, 5000);
        }

        // Export file with backend integration
        async function exportFile(cardType, format) {
            const preview = document.getElementById('preview-' + cardType);
            const fileId = preview.dataset.fileId;

            if (!fileId) {
                showError(cardType, 'No data to export');
                return;
            }

            // Determine export endpoint based on workflow type
            let endpoint = '';
            switch (cardType) {
                case 'quote-pricelist':
                    endpoint = `/download/extracted/${fileId}?format=${format}`;
                    break;
                case 'multi-budget':
                    endpoint = `/download/extracted/${fileId}?format=${format}`;
                    break;
                case 'presentation':
                    endpoint = `/generate-presentation/${fileId}`;
                    break;
                case 'mas':
                    endpoint = `/generate-mas/${fileId}`;
                    break;
                default:
                    endpoint = `/download/extracted/${fileId}?format=${format}`;
            }

            // Open download in new window
            window.open(endpoint, '_blank');
        }

        // Add hover effects to cards
        document.querySelectorAll('.feature-card').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const rotateX = (y - centerY) / 20;
                const rotateY = (centerX - x) / 20;

                if (!card.classList.contains('expanded')) {
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-20px) scale(1.02)`;
                }
            });

            card.addEventListener('mouseleave', () => {
                if (!card.classList.contains('expanded')) {
                    card.style.transform = '';
                }
            });
        });

        // ==================== MAIN APP FUNCTIONS ====================

        // Helper function to hide all workflow-specific cards
        function hideAllWorkflowCards() {
            const cards = ['costingCard', 'costingPreviewCard', 'offerActionsCard', 'presentationCard', 'masCard', 'multiBudgetCard'];
            cards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) card.style.display = 'none';
            });
        }

        // Helper function to show workflow-specific cards
        function showWorkflowSpecificCards(workflowType) {
            // All workflows show extracted tables, but different action cards
            switch (workflowType) {
                case 'quote-pricelist':
                    // Quote workflow: shows costing after extraction
                    // Costing card will auto-show after table extraction
                    break;
                case 'presentation':
                    // Presentation workflow: shows presentation card after extraction
                    break;
                case 'mas':
                    // MAS workflow: shows MAS card after extraction
                    break;
                case 'multi-budget':
                    // Multi-budget workflow: shows multi-budget card immediately
                    const multiBudgetCard = document.getElementById('multiBudgetCard');
                    if (multiBudgetCard) {
                        multiBudgetCard.style.display = 'block';
                        // Initialize brand dropdowns for the active tier
                        if (typeof window.updateBrandDropdownsForTier === 'function') {
                            window.updateBrandDropdownsForTier(currentBudgetTier || 'budgetary');
                        }
                        // Ensure button listeners are attached (backup initialization)
                        if (typeof window.initializeMultiBudgetButtons === 'function') {
                            window.initializeMultiBudgetButtons();
                        }
                    }
                    break;
            }
        }

        // Show main application (called when cards are clicked from within app)
        // This function is overridden by the one above, but keeping for compatibility
        // The main showMainApp function above handles both cases now

        // Main app upload and file management
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressFill = document.getElementById('uploadProgressFill');

        // Click to upload
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            // Prevent duplicate uploads
            if (fileInput.dataset.uploading === 'true') {
                console.warn('Upload already in progress, ignoring duplicate trigger');
                return;
            }
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            // Prevent concurrent uploads
            if (fileInput.dataset.uploading === 'true') {
                console.warn('Upload already in progress, skipping');
                return;
            }
            
            const uploadArea = document.getElementById('uploadArea');
            fileInput.dataset.uploading = 'true';
            uploadArea.classList.add('uploading');
            
            console.log('Handling', files.length, 'files');
            try {
                for (let file of files) {
                    await uploadFile(file);
                }
                console.log('Upload complete');
            } finally {
                fileInput.dataset.uploading = 'false';
                uploadArea.classList.remove('uploading');
            }
            // File list refresh removed as uploaded files card is no longer displayed
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Get extraction settings from upload area
            const extractionSettings = getUploadExtractionSettings();
            formData.append('extraction_settings', JSON.stringify(extractionSettings));
            formData.append('auto_extract', 'true'); // Flag to auto-extract

            const progressBar = document.getElementById('uploadProgress');
            const progressStatus = document.getElementById('progressStatus');

            progressBar.style.display = 'block';
            progressBar.classList.add('active');

            // Show upload notification
            showUploadNotification('Uploading File', `${file.name}`, 'â³');

            // Helper function to update progress with detailed status
            function updateProgress(percent, mainText, detailText = '', statusText = '') {
                uploadProgressFill.style.width = percent + '%';
                const detailHtml = detailText ? `<div style="font-size: 0.85em; color: rgba(15, 23, 41, 0.7); margin-top: 4px;">${detailText}</div>` : '';
                uploadProgressFill.innerHTML = `
                    <div class="progress-text">
                        <div class="progress-spinner"></div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 2px;">
                            <span>${Math.round(percent)}% ${mainText}</span>
                            ${detailHtml}
                        </div>
                    </div>
                `;

                // Update status text below progress bar
                if (statusText) {
                    progressStatus.innerHTML = statusText;
                    progressStatus.classList.add('show');
                } else {
                    progressStatus.classList.remove('show');
                }
            }

            // Create progress animation for upload phase
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 30) {
                    progress += Math.random() * 5;
                    progress = Math.min(progress, 30);
                    updateProgress(
                        progress,
                        'Uploading file...',
                        `Sending ${file.name} to server`,
                        `<strong>Step 1:</strong> Uploading file to server... (${(file.size / 1024 / 1024).toFixed(2)} MB)`
                    );
                }
            }, 200);

            try {
                // Extended timeout for large files
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 minutes

                const response = await fetch('/upload-and-extract', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                clearInterval(progressInterval);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                    uploadProgressFill.style.width = '0%';
                    uploadProgressFill.classList.add('error');
                    progressBar.classList.remove('active');
                    showUploadNotification('Upload Failed', errorData.error || `HTTP ${response.status}`, 'âŒ');
                    console.error('Upload failed:', errorData);
                    return;
                }

                const result = await response.json();
                console.log('Upload response received:', result);

                if (result && result.success) {
                    console.log('Upload successful, file_id:', result.file_id, 'extraction_success:', result.extraction_success);
                    // Upload complete - show extraction phase
                    updateProgress(
                        35,
                        'Upload complete',
                        'Initializing document extraction...',
                        `<strong>Step 2:</strong> File uploaded successfully. Preparing to extract data using PP-StructureV3 API...`
                    );
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Extraction phase
                    updateProgress(
                        45,
                        'Extracting data',
                        'Calling PP-StructureV3 API for document analysis',
                        `<strong>Step 3:</strong> Sending document to PP-StructureV3 API for intelligent extraction. This may take a moment for large files...`
                    );
                    await new Promise(resolve => setTimeout(resolve, 400));

                    if (result.extraction_success) {
                        // Show extraction details if available
                        updateProgress(
                            60,
                            'Extraction complete',
                            'Processing extracted content from API response',
                            `<strong>Step 4:</strong> API extraction successful! Processing ${result.page_count || 'multiple'} page(s) of extracted content...`
                        );
                        await new Promise(resolve => setTimeout(resolve, 300));

                        // Table detection phase
                        updateProgress(
                            70,
                            'Detecting tables',
                            'Identifying table structures in document',
                            `<strong>Step 5:</strong> Analyzing document structure and identifying table blocks across all pages...`
                        );
                        await new Promise(resolve => setTimeout(resolve, 400));

                        // Table stitching phase
                        updateProgress(
                            80,
                            'Stitching tables',
                            'Combining tables from multiple pages',
                            `<strong>Step 6:</strong> Stitching tables from multiple pages into a single editable table. Removing empty rows...`
                        );
                        await new Promise(resolve => setTimeout(resolve, 300));

                        showUploadNotification('Extraction Complete!', `${file.name} processed successfully`, 'âœ…');

                        // Automatically stitch and display tables
                        setTimeout(async () => {
                            try {
                                console.log('Starting auto-stitch for file_id:', result.file_id);
                                updateProgress(
                                    90,
                                    'Rendering tables',
                                    'Preparing editable table view',
                                    `<strong>Step 7:</strong> Rendering interactive table with add/delete row buttons and drag-drop image support...`
                                );
                                await autoStitchAndDisplayTables(result.file_id);
                                console.log('Auto-stitch completed successfully');

                                uploadProgressFill.classList.remove('warning', 'error');
                                uploadProgressFill.classList.add('success');
                                progressBar.classList.remove('active');

                                updateProgress(
                                    100,
                                    'Complete!',
                                    `Successfully processed ${file.name}`,
                                    `<strong>âœ“ Complete!</strong> Your table is ready for editing. You can now edit cells, add/delete rows, and drag images.`
                                );

                                // Show completion message
                                setTimeout(() => {
                                    uploadProgressFill.innerHTML = `
                                        <div class="progress-text">
                                            <span style="font-size: 1.3em;">âœ“</span>
                                            <span>100% Complete & Ready for Editing!</span>
                                        </div>
                                    `;
                                }, 500);
                            } catch (error) {
                                console.error('Error stitching tables:', error);
                                uploadProgressFill.style.width = '100%';
                                uploadProgressFill.classList.add('warning');
                                progressBar.classList.remove('active');
                                uploadProgressFill.innerHTML = `
                                    <div class="progress-text">
                                        <span>âš </span>
                                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                            <span>100% Extracted</span>
                                            <div style="font-size: 0.85em; color: rgba(15, 23, 41, 0.7);">Stitching failed: ${error.message || 'Unknown error'}</div>
                                        </div>
                                    </div>
                                `;
                                updateProgress(
                                    100,
                                    '',
                                    '',
                                    `<strong>âš  Warning:</strong> Tables were extracted but stitching failed: ${error.message || 'Unknown error'}. You can still view the raw extracted data.`
                                );
                                showUploadNotification('Stitching Failed', `Tables extracted but stitching failed: ${error.message || 'Unknown error'}`, 'âš ï¸');
                            }
                        }, 500);
                    } else {
                        uploadProgressFill.style.width = '100%';
                        uploadProgressFill.classList.add('error');
                        progressBar.classList.remove('active');
                        const errorDetail = result.extraction_error || 'Unknown error occurred during extraction';
                        uploadProgressFill.innerHTML = `
                            <div class="progress-text">
                                <span>âš </span>
                                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <span>100% Uploaded</span>
                                    <div style="font-size: 0.85em; color: rgba(15, 23, 41, 0.7);">Extraction failed: ${errorDetail}</div>
                                </div>
                            </div>
                        `;
                        updateProgress(
                            100,
                            '',
                            '',
                            `<strong>âŒ Error:</strong> File uploaded but extraction failed: ${errorDetail}. Page will refresh in 3 seconds to allow new upload...`
                        );
                        showUploadNotification('Extraction Failed', `${file.name} uploaded but extraction failed: ${errorDetail}. Refreshing...`, 'âš ï¸');
                        
                        // Auto-refresh page after 3 seconds to allow new upload
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    }

                    // File list refresh removed as uploaded files card is no longer displayed
                } else {
                    uploadProgressFill.style.width = '0%';
                    uploadProgressFill.classList.add('error');
                    progressBar.classList.remove('active');
                    showUploadNotification('Upload Failed', result?.error || 'Unknown error', 'âŒ');
                }
            } catch (error) {
                clearInterval(progressInterval);
                uploadProgressFill.style.width = '0%';
                uploadProgressFill.classList.add('error');
                progressBar.classList.remove('active');
                uploadProgressFill.innerHTML = `
                    <div class="progress-text">
                        <span>âŒ</span>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span>Upload Error</span>
                            <div style="font-size: 0.85em; color: rgba(15, 23, 41, 0.7);">${error.message}</div>
                        </div>
                    </div>
                `;
                updateProgress(
                    0,
                    '',
                    '',
                    `<strong>âŒ Upload Error:</strong> ${error.message}. Page will refresh in 3 seconds...`
                );
                showUploadNotification('Upload Error', error.message, 'âŒ');
                console.error('Upload error:', error);
                
                // Auto-refresh page after 3 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }

            setTimeout(() => {
                progressBar.style.display = 'none';
                progressBar.classList.remove('active');
                uploadProgressFill.style.width = '0%';
                uploadProgressFill.innerHTML = '';
                uploadProgressFill.classList.remove('success', 'error', 'warning');
                progressStatus.classList.remove('show');
                progressStatus.innerHTML = '';
            }, 6000); // Increased from 5000 to 6000 to give users more time to read the status
        }


        function createFileItem(file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = `file-${file.id}`;

            console.log('Creating file item for:', file.original_name, 'ID:', file.id);

            // Determine status class
            let statusClass = 'status-uploaded';
            let statusText = 'Uploaded';
            if (file.status === 'extracted') {
                statusClass = 'status-extracted';
                statusText = 'Extracted';
            } else if (file.status === 'processing') {
                statusClass = 'status-processing';
                statusText = 'Processing';
            }

            // Format file size if available
            let fileSizeHtml = '';
            if (file.size) {
                const sizeKB = (file.size / 1024).toFixed(2);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const displaySize = file.size > 1048576 ? `${sizeMB} MB` : `${sizeKB} KB`;
                fileSizeHtml = `<div class="file-size">${displaySize}</div>`;
            }

            const fileName = file.original_name || 'Unnamed File';
            console.log('Setting file name to:', fileName);

            // Create the HTML structure with vertical layout
            div.innerHTML = `
                <div class="file-info" style="display: block; visibility: visible;">
                    <div class="file-name" style="display: flex; visibility: visible; margin-bottom: 15px;">
                        <span class="file-name-text">${fileName}</span>
                    </div>
                    <div class="file-meta" style="display: flex; visibility: visible;">
                        <div class="file-status ${statusClass}">${statusText}</div>
                        ${fileSizeHtml}
                    </div>
                </div>
                <div class="file-actions">
                    <button class="action-btn btn-primary" onclick="extractTable('${file.id}')">ðŸŽ¯ Extract</button>
                    <button class="action-btn btn-secondary" onclick="toggleExtractionSettings()" title="Advanced Extraction Settings">âš™ï¸ Settings</button>
                    <button class="action-btn btn-success" onclick="openCosting('${file.id}')">ðŸ’° Costing</button>
                    <button class="action-btn btn-info" onclick="downloadExtracted('${file.id}', 'excel')" style="display:none;" id="download-${file.id}">ðŸ“¥ Excel</button>
                    <button class="action-btn btn-danger" onclick="deleteFile('${file.id}')">ðŸ—‘ï¸ Delete</button>
                </div>
            `;

            // Add mouse tracking for hover effect
            div.addEventListener('mousemove', (e) => {
                const rect = div.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                div.style.setProperty('--mouse-x', x + '%');
                div.style.setProperty('--mouse-y', y + '%');
            });

            console.log('File item created, HTML:', div.innerHTML.substring(0, 200));

            return div;
        }

        // Get current extraction settings from UI
        function getExtractionSettings() {
            return {
                extractionMethod: document.getElementById('setting-extractionMethod')?.value || 'pdfplumber',
                useDocPreprocessor: document.getElementById('setting-useDocPreprocessor')?.checked || false,
                useSealRecognition: document.getElementById('setting-useSealRecognition')?.checked !== false,
                useTableRecognition: document.getElementById('setting-useTableRecognition')?.checked !== false,
                useFormulaRecognition: document.getElementById('setting-useFormulaRecognition')?.checked !== false,
                useChartRecognition: document.getElementById('setting-useChartRecognition')?.checked !== false,
                useRegionDetection: document.getElementById('setting-useRegionDetection')?.checked !== false,
                formatBlockContent: document.getElementById('setting-formatBlockContent')?.checked !== false,
                useTextlineOrientation: document.getElementById('setting-useTextlineOrientation')?.checked || false,
                useDocOrientationClassify: document.getElementById('setting-useDocOrientationClassify')?.checked || false,
                useDocUnwarping: document.getElementById('setting-useDocUnwarping')?.checked || false,
                visualize: document.getElementById('setting-visualize')?.checked !== false,
                // Table Recognition Advanced
                useWiredTableCellsTransToHtml: document.getElementById('setting-useWiredTableCellsTransToHtml')?.checked || false,
                useWirelessTableCellsTransToHtml: document.getElementById('setting-useWirelessTableCellsTransToHtml')?.checked || false,
                useTableOrientationClassify: document.getElementById('setting-useTableOrientationClassify')?.checked || false,
                useOcrResultsWithTableCells: document.getElementById('setting-useOcrResultsWithTableCells')?.checked || false,
                useE2eWiredTableRecModel: document.getElementById('setting-useE2eWiredTableRecModel')?.checked || false,
                useE2eWirelessTableRecModel: document.getElementById('setting-useE2eWirelessTableRecModel')?.checked || false,
                // Layout Detection (only send if different from API defaults)
                layoutThreshold: (() => {
                    const val = parseFloat(document.getElementById('setting-layoutThreshold')?.value);
                    return (val && val !== 0.5) ? val : null;
                })(),
                layoutNms: document.getElementById('setting-layoutNms')?.checked ? true : null,
                layoutUnclipRatio: (() => {
                    const val = parseFloat(document.getElementById('setting-layoutUnclipRatio')?.value);
                    return (val && val !== 1.0) ? val : null;
                })(),
                layoutMergeBboxesMode: (() => {
                    const val = document.getElementById('setting-layoutMergeBboxesMode')?.value;
                    return (val && val !== 'large') ? val : null;
                })(),
                // Text Detection (only send if different from API defaults)
                textDetLimitSideLen: (() => {
                    const val = parseInt(document.getElementById('setting-textDetLimitSideLen')?.value);
                    return (val && val !== 64) ? val : null;
                })(),
                textDetLimitType: (() => {
                    const val = document.getElementById('setting-textDetLimitType')?.value;
                    return (val && val !== 'min') ? val : null;
                })(),
                textDetThresh: (() => {
                    const val = parseFloat(document.getElementById('setting-textDetThresh')?.value);
                    return (val && val !== 0.3) ? val : null;
                })(),
                textDetBoxThresh: (() => {
                    const val = parseFloat(document.getElementById('setting-textDetBoxThresh')?.value);
                    return (val && val !== 0.6) ? val : null;
                })(),
                textDetUnclipRatio: (() => {
                    const val = parseFloat(document.getElementById('setting-textDetUnclipRatio')?.value);
                    return (val && val !== 1.5) ? val : null;
                })(),
                textRecScoreThresh: (() => {
                    const val = parseFloat(document.getElementById('setting-textRecScoreThresh')?.value);
                    return (val && val !== 0.0) ? val : null;
                })(),
                // Seal Detection (only send if different from API defaults)
                sealDetLimitSideLen: (() => {
                    const val = parseInt(document.getElementById('setting-sealDetLimitSideLen')?.value);
                    return (val && val !== 736) ? val : null;
                })(),
                sealDetLimitType: (() => {
                    const val = document.getElementById('setting-sealDetLimitType')?.value;
                    return (val && val !== 'min') ? val : null;
                })(),
                sealDetThresh: (() => {
                    const val = parseFloat(document.getElementById('setting-sealDetThresh')?.value);
                    return (val && val !== 0.2) ? val : null;
                })(),
                sealDetBoxThresh: (() => {
                    const val = parseFloat(document.getElementById('setting-sealDetBoxThresh')?.value);
                    return (val && val !== 0.6) ? val : null;
                })(),
                sealDetUnclipRatio: (() => {
                    const val = parseFloat(document.getElementById('setting-sealDetUnclipRatio')?.value);
                    return (val && val !== 0.5) ? val : null;
                })(),
                sealRecScoreThresh: (() => {
                    const val = parseFloat(document.getElementById('setting-sealRecScoreThresh')?.value);
                    return (val && val !== 0.0) ? val : null;
                })()
            };
        }

        // Toggle upload settings panel
        function toggleUploadSettings() {
            const panel = document.getElementById('uploadSettingsPanel');
            const toggle = document.getElementById('uploadSettingsToggle');
            if (panel && toggle) {
                const isVisible = panel.style.display !== 'none';
                panel.style.display = isVisible ? 'none' : 'block';
                toggle.textContent = isVisible ? 'â–¼' : 'â–²';
            }
        }

        // Get extraction settings from upload area
        function getUploadExtractionSettings() {
            return {
                extractionMethod: document.getElementById('upload-setting-extractionMethod')?.value || 'pdfplumber',
                useDocPreprocessor: document.getElementById('upload-setting-useDocPreprocessor')?.checked || false,
                useSealRecognition: document.getElementById('upload-setting-useSealRecognition')?.checked !== false,
                useTableRecognition: document.getElementById('upload-setting-useTableRecognition')?.checked !== false,
                useFormulaRecognition: document.getElementById('upload-setting-useFormulaRecognition')?.checked !== false,
                useChartRecognition: document.getElementById('upload-setting-useChartRecognition')?.checked !== false,
                useRegionDetection: document.getElementById('upload-setting-useRegionDetection')?.checked !== false,
                formatBlockContent: document.getElementById('upload-setting-formatBlockContent')?.checked !== false,
                useTextlineOrientation: document.getElementById('upload-setting-useTextlineOrientation')?.checked || false,
                useDocOrientationClassify: document.getElementById('upload-setting-useDocOrientationClassify')?.checked || false,
                useDocUnwarping: document.getElementById('upload-setting-useDocUnwarping')?.checked || false,
                visualize: document.getElementById('upload-setting-visualize')?.checked !== false,
                // Table Recognition Advanced
                useWiredTableCellsTransToHtml: document.getElementById('upload-setting-useWiredTableCellsTransToHtml')?.checked || false,
                useWirelessTableCellsTransToHtml: document.getElementById('upload-setting-useWirelessTableCellsTransToHtml')?.checked || false,
                useTableOrientationClassify: document.getElementById('upload-setting-useTableOrientationClassify')?.checked || false,
                useOcrResultsWithTableCells: document.getElementById('upload-setting-useOcrResultsWithTableCells')?.checked || false,
                useE2eWiredTableRecModel: document.getElementById('upload-setting-useE2eWiredTableRecModel')?.checked || false,
                useE2eWirelessTableRecModel: document.getElementById('upload-setting-useE2eWirelessTableRecModel')?.checked || false,
                // Layout Detection (only send if different from API defaults)
                layoutThreshold: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-layoutThreshold')?.value);
                    return (val && val !== 0.5) ? val : null;
                })(),
                layoutNms: document.getElementById('upload-setting-layoutNms')?.checked ? true : null,
                layoutUnclipRatio: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-layoutUnclipRatio')?.value);
                    return (val && val !== 1.0) ? val : null;
                })(),
                layoutMergeBboxesMode: (() => {
                    const val = document.getElementById('upload-setting-layoutMergeBboxesMode')?.value;
                    return (val && val !== 'large') ? val : null;
                })(),
                // Text Detection (only send if different from API defaults)
                textDetLimitSideLen: (() => {
                    const val = parseInt(document.getElementById('upload-setting-textDetLimitSideLen')?.value);
                    return (val && val !== 64) ? val : null;
                })(),
                textDetLimitType: (() => {
                    const val = document.getElementById('upload-setting-textDetLimitType')?.value;
                    return (val && val !== 'min') ? val : null;
                })(),
                textDetThresh: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-textDetThresh')?.value);
                    return (val && val !== 0.3) ? val : null;
                })(),
                textDetBoxThresh: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-textDetBoxThresh')?.value);
                    return (val && val !== 0.6) ? val : null;
                })(),
                textDetUnclipRatio: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-textDetUnclipRatio')?.value);
                    return (val && val !== 1.5) ? val : null;
                })(),
                textRecScoreThresh: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-textRecScoreThresh')?.value);
                    return (val && val !== 0.0) ? val : null;
                })(),
                // Seal Detection (only send if different from API defaults)
                sealDetLimitSideLen: (() => {
                    const val = parseInt(document.getElementById('upload-setting-sealDetLimitSideLen')?.value);
                    return (val && val !== 736) ? val : null;
                })(),
                sealDetLimitType: (() => {
                    const val = document.getElementById('upload-setting-sealDetLimitType')?.value;
                    return (val && val !== 'min') ? val : null;
                })(),
                sealDetThresh: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-sealDetThresh')?.value);
                    return (val && val !== 0.2) ? val : null;
                })(),
                sealDetBoxThresh: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-sealDetBoxThresh')?.value);
                    return (val && val !== 0.6) ? val : null;
                })(),
                sealDetUnclipRatio: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-sealDetUnclipRatio')?.value);
                    return (val && val !== 0.5) ? val : null;
                })(),
                sealRecScoreThresh: (() => {
                    const val = parseFloat(document.getElementById('upload-setting-sealRecScoreThresh')?.value);
                    return (val && val !== 0.0) ? val : null;
                })()
            };
        }

        // Global function to remove ALL error messages
        function removeAllErrorMessages() {
            console.log('ðŸ§¹ Removing all error messages...');

            // Find and remove ALL error elements across the entire page
            const errorSelectors = [
                'div[style*="color: #dc3545"]',
                'div[style*="color:#dc3545"]',
                'div[style*="color: red"]',
                'div[style*="color:red"]',
                '.alert-danger',
                '.error-message'
            ];

            errorSelectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    const text = element.textContent.toLowerCase();
                    if (text.includes('error') || text.includes('failed') ||
                        text.includes('file not found') || text.includes('session') ||
                        text.includes('stitching')) {
                        console.log('Removing error:', text.substring(0, 50));
                        element.remove();
                    }
                });
            });

            // Also check for pink/red background error boxes
            document.querySelectorAll('div').forEach(div => {
                const bgColor = window.getComputedStyle(div).backgroundColor;
                const text = div.textContent.toLowerCase();
                if ((bgColor.includes('255') || div.style.background?.includes('pink') || div.style.background?.includes('red')) &&
                    (text.includes('error stitching') || text.includes('file not found'))) {
                    console.log('Removing error box:', text.substring(0, 50));
                    div.remove();
                }
            });
        }

        // Automatically stitch and display tables after extraction
        async function autoStitchAndDisplayTables(fileId) {
            // Show the extracted tables card
            const extractedTablesCard = document.getElementById('extractedTablesCard');
            const extractedTablesContainer = document.getElementById('extractedTablesContainer');

            if (!extractedTablesCard || !extractedTablesContainer) {
                console.error('Extracted tables card not found');
                return;
            }

            // Clear ALL error messages before displaying new content
            removeAllErrorMessages();

            // Create a section for this file's extraction if it doesn't exist
            let extractionSection = document.getElementById(`extraction-${fileId}`);
            if (!extractionSection) {
                extractionSection = document.createElement('div');
                extractionSection.id = `extraction-${fileId}`;
                extractionSection.className = 'extraction-preview';
                extractedTablesContainer.appendChild(extractionSection);
            }

            // Create stitch result container if it doesn't exist (needed for stitchTables function)
            let stitchResult = document.getElementById(`stitch-result-${fileId}`);
            if (!stitchResult) {
                stitchResult = document.createElement('div');
                stitchResult.id = `stitch-result-${fileId}`;
                stitchResult.style.display = 'none';
                extractionSection.appendChild(stitchResult);
            }

            // Show the extracted tables card
            extractedTablesCard.style.display = 'block';
            extractionSection.style.display = 'block';

            // Use the existing stitchTables function from table_manager.js which has all the proper functionality
            // Check if stitchTables is available (it's loaded from static/js/table_manager.js)
            if (typeof stitchTables === 'function') {
                await stitchTables(fileId);
            } else {
                // Fallback: implement full stitching functionality inline
                stitchResult.style.display = 'block';
                stitchResult.innerHTML = '<div class="loading"></div> Stitching tables from all pages...';
                extractedTablesCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

                try {
                    const response = await fetch(`/stitch-tables/${fileId}`, { method: 'POST' });
                    const result = await response.json();

                    if (!response.ok || result.error) {
                        // Handle error - try to get available files and use the most recent one
                        console.error('Stitching error:', result);
                        if (result.available_files && result.available_files.length > 0) {
                            // Use the most recent file that has extraction
                            const extractedFile = result.available_files.find(f => f.has_extraction) || result.available_files[0];
                            if (extractedFile && extractedFile.id !== fileId) {
                                console.log(`Retrying with file ID: ${extractedFile.id}`);
                                // Retry with the available file ID
                                const retryResponse = await fetch(`/stitch-tables/${extractedFile.id}`, { method: 'POST' });
                                const retryResult = await retryResponse.json();
                                if (retryResult.success) {
                                    // Use retry result
                                    result = retryResult;
                                } else {
                                    throw new Error(retryResult.message || 'Stitching failed');
                                }
                            } else {
                                throw new Error(result.message || 'File not found in session');
                            }
                        } else {
                            throw new Error(result.message || 'No files available for stitching');
                        }
                    }

                    if (result.success) {
                        // Display stitched table with full functionality (same as table_manager.js)
                        let stitchedHtml = `
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="color: #2e7d32; margin: 0 0 5px 0;">âœ… Stitched Table (Fully Editable)</h4>
                                        <p style="margin: 0; color: #555; font-size: 0.9em;">
                                            <strong>Total Rows:</strong> ${result.row_count} | <strong>Pages:</strong> ${result.page_count}
                                            | âœï¸ Click cells to edit | ðŸ–¼ï¸ Drag images | âž• Add rows | ðŸ—‘ï¸ Delete rows
                                        </p>
                                    </div>
                                </div>
                                <div id="editable-table-${fileId}" style="background: white; padding: 15px; border-radius: 4px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative;">
                        `;

                        // Parse and style the stitched table
                        let tempDiv = document.createElement('div');
                        tempDiv.innerHTML = result.stitched_html;

                        // Style the stitched table and make it editable
                        tempDiv.querySelectorAll('table').forEach(table => {
                            table.style.width = '100%';
                            table.style.borderCollapse = 'collapse';
                            table.style.marginTop = '10px';
                            table.style.position = 'relative';
                            table.setAttribute('border', '1');
                            table.setAttribute('id', `table-${fileId}`);

                            table.querySelectorAll('td, th').forEach(cell => {
                                cell.style.border = '1px solid #ddd';
                                cell.style.padding = '8px';
                                cell.style.textAlign = 'left';
                                cell.style.verticalAlign = 'middle';
                                cell.style.position = 'relative';
                                cell.style.minHeight = '40px';
                                cell.style.cursor = 'text';
                            });

                            // Find and style header row from thead (if exists) or first row
                            let headerRow = null;
                            const thead = table.querySelector('thead');
                            if (thead) {
                                headerRow = thead.querySelector('tr');
                            } else {
                                const tbody = table.querySelector('tbody');
                                if (tbody) {
                                    headerRow = tbody.querySelector('tr:first-child');
                                } else {
                                    headerRow = table.querySelector('tr');
                                }
                            }

                            if (headerRow) {
                                // Convert all td to th and style as header
                                const cells = Array.from(headerRow.querySelectorAll('td, th'));
                                cells.forEach(cell => {
                                    if (cell.tagName === 'TD') {
                                        const th = document.createElement('th');
                                        th.innerHTML = cell.innerHTML;
                                        th.style.cssText = cell.style.cssText;
                                        Array.from(cell.attributes).forEach(attr => {
                                            if (attr.name !== 'style') {
                                                th.setAttribute(attr.name, attr.value);
                                            }
                                        });
                                        cell.parentNode.replaceChild(th, cell);
                                    }
                                });

                                headerRow.querySelectorAll('th').forEach(th => {
                                    th.style.backgroundColor = '#4caf50';
                                    th.style.color = 'white';
                                    th.style.fontWeight = '600';
                                    th.setAttribute('contenteditable', 'false');
                                    th.setAttribute('onblur', 'this.style.outline="none"; this.style.backgroundColor="#4caf50";');
                                });

                                // Move header row to thead if not already there
                                if (!thead) {
                                    const newThead = document.createElement('thead');
                                    newThead.appendChild(headerRow);
                                    table.insertBefore(newThead, table.firstChild);
                                }

                                // Add action column header if it doesn't exist
                                let actionHeader = headerRow.querySelector('.action-column-header');
                                if (!actionHeader) {
                                    actionHeader = document.createElement('th');
                                    actionHeader.className = 'action-column-header';
                                    actionHeader.textContent = 'Actions';
                                    actionHeader.contentEditable = 'false';
                                    actionHeader.style.cssText = 'width:120px;border:1px solid #ddd;background:#4caf50;color:white;font-weight:600;text-align:center;padding:8px;';
                                    headerRow.appendChild(actionHeader);
                                }
                            }

                            // Make cells editable and add action buttons to each data row (skip header)
                            const tbody = table.querySelector('tbody') || table;
                            const dataRows = tbody.querySelectorAll('tr');

                            // Filter out empty rows before processing
                            const rowsToRemove = [];
                            dataRows.forEach((row, index) => {
                                // Skip header row
                                if (headerRow && (row === headerRow || row.closest('thead'))) {
                                    return;
                                }

                                // Check if row is empty (no text content in any cell)
                                const cells = row.querySelectorAll('td, th');
                                let hasContent = false;

                                cells.forEach(cell => {
                                    const cellText = cell.textContent.trim();
                                    // Check if cell has actual content (not just whitespace)
                                    if (cellText && cellText.length > 0) {
                                        hasContent = true;
                                    }
                                });

                                // Mark empty rows for removal
                                if (!hasContent) {
                                    rowsToRemove.push(row);
                                }
                            });

                            // Remove empty rows
                            rowsToRemove.forEach(row => {
                                console.log('Removing empty row:', row);
                                row.remove();
                            });

                            // Re-query data rows after filtering
                            const filteredDataRows = tbody.querySelectorAll('tr');
                            let dataRowIndex = 0;

                            filteredDataRows.forEach((row, index) => {
                                // Skip header row
                                if (headerRow && (row === headerRow || row.closest('thead'))) {
                                    return;
                                }

                                dataRowIndex++;

                                // Apply alternating row colors
                                if (dataRowIndex % 2 === 0) {
                                    row.style.backgroundColor = '#f8f9fa';
                                } else {
                                    row.style.backgroundColor = 'white';
                                }

                                // Remove any existing action buttons from ALL cells except Actions column
                                // This includes removing buttons from first column (Sl.No) or any other non-Actions cells
                                Array.from(row.cells).forEach((cell, cellIndex) => {
                                    // Skip action column - that's where we WANT the buttons
                                    if (cell.classList.contains('action-column-cell')) {
                                        return;
                                    }

                                    // Remove ALL button-related elements from this cell
                                    // Remove ALL button elements and their containers from this cell
                                    const allButtons = cell.querySelectorAll('button, .row-action-btn');
                                    allButtons.forEach(btn => {
                                        // Check if button is an action button (add/delete)
                                        let isActionBtn = btn.classList.contains('row-action-btn') ||
                                            btn.getAttribute('data-action') === 'add' ||
                                            btn.getAttribute('data-action') === 'delete' ||
                                            (btn.onclick && (btn.onclick.toString().includes('addRow') || btn.onclick.toString().includes('deleteRow')));

                                        // Check text content for emojis if not already identified
                                        if (!isActionBtn && btn.textContent) {
                                            const text = btn.textContent.trim();
                                            if (text.includes('âž•') || text.includes('ðŸ—‘ï¸') || text.includes('+') || text.includes('Ã—') || text.includes('x')) {
                                                isActionBtn = true;
                                            }
                                        }

                                        if (isActionBtn) {
                                            // Check if button is in a container div
                                            const container = btn.closest('div');
                                            if (container && container.parentNode === cell) {
                                                // Check if container only has buttons (no other content)
                                                const containerText = container.textContent.trim().replace(/[âž•ðŸ—‘ï¸+Ã—x\s]/g, '');
                                                const buttonsInContainer = container.querySelectorAll('button');
                                                if (buttonsInContainer.length > 0 && containerText.length === 0) {
                                                    // Container only contains buttons, remove it
                                                    container.remove();
                                                } else {
                                                    // Container has other content, just remove the button
                                                    btn.remove();
                                                }
                                            } else {
                                                // Button is direct child or in nested container, remove it
                                                btn.remove();
                                            }
                                        }
                                    });

                                    // Clean up any empty divs or spans left behind
                                    cell.querySelectorAll('div, span').forEach(el => {
                                        if (el.innerHTML.trim() === '') {
                                            el.remove();
                                        }
                                    });
                                });

                                // Specific cleanup for first column (Sl.No) which often gets polluted
                                if (row.cells.length > 0) {
                                    const firstCell = row.cells[0];
                                    // Remove any buttons in first cell
                                    firstCell.querySelectorAll('button, .row-action-btn').forEach(btn => btn.remove());
                                    // Remove divs containing buttons or button-like text
                                    firstCell.querySelectorAll('div').forEach(div => {
                                        if (div.querySelector('button, .row-action-btn') ||
                                            (div.textContent && (div.textContent.includes('âž•') || div.textContent.includes('ðŸ—‘ï¸')))) {
                                            div.remove();
                                        }
                                    });
                                }

                                // Remove existing action column cell if present
                                const existingActionCell = row.querySelector('.action-column-cell');
                                if (existingActionCell) {
                                    existingActionCell.remove();
                                }

                                // Make all existing cells editable (except action column)
                                for (let j = 0; j < row.cells.length; j++) {
                                    const cell = row.cells[j];
                                    if (!cell.classList.contains('action-column-cell')) {
                                        cell.setAttribute('contenteditable', 'true');
                                        cell.setAttribute('ondrop', 'handleDrop(event)');
                                        cell.setAttribute('ondragover', 'handleDragOver(event)');
                                        const bgColor = (dataRowIndex % 2 === 0) ? '#f8f9fa' : 'white';
                                        cell.setAttribute('onfocus', 'this.style.outline="2px solid #2196F3"; this.style.backgroundColor="#fff9e6";');
                                        cell.setAttribute('onblur', `this.style.outline="none"; this.style.backgroundColor="${bgColor}";`);
                                    }
                                }

                                // Add action buttons column (using function from table_manager.js if available, else inline)
                                if (typeof addActionButtonsToRow === 'function') {
                                    addActionButtonsToRow(row, fileId);
                                } else {
                                    // Inline action buttons implementation
                                    const actionCell = document.createElement('td');
                                    actionCell.className = 'action-column-cell';
                                    actionCell.style.cssText = 'width:120px;border:1px solid #ddd;background:#f8f9fa;padding:4px;text-align:center;vertical-align:middle;';
                                    actionCell.contentEditable = 'false';
                                    actionCell.innerHTML = `
                                        <div style="display:flex;gap:5px;justify-content:center;align-items:center;">
                                            <button type="button" class="row-action-btn" data-action="add" data-file-id="${fileId}" title="Add row below"
                                                style="background:linear-gradient(135deg,#4caf50,#45a049);color:white;padding:8px 12px;border:none;cursor:pointer;border-radius:6px;font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.2);transition:all 0.2s;">
                                                âž•
                                            </button>
                                            <button type="button" class="row-action-btn" data-action="delete" title="Delete row"
                                                style="background:linear-gradient(135deg,#f44336,#e53935);color:white;padding:8px 12px;border:none;cursor:pointer;border-radius:6px;font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.2);transition:all 0.2s;">
                                                ðŸ—‘ï¸
                                            </button>
                                        </div>
                                    `;
                                    row.appendChild(actionCell);
                                }
                            });

                            // Make images draggable and clickable
                            table.querySelectorAll('img').forEach(img => {
                                img.style.maxWidth = '100px';
                                img.style.maxHeight = '100px';
                                img.style.width = 'auto';
                                img.style.height = 'auto';
                                img.style.display = 'block';
                                img.style.margin = '3px auto';
                                img.style.borderRadius = '3px';
                                img.style.cursor = 'move';
                                img.style.objectFit = 'contain';
                                img.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                img.style.transition = 'transform 0.2s, box-shadow 0.2s';

                                // Make draggable
                                img.setAttribute('draggable', 'true');
                                img.setAttribute('ondragstart', 'handleDragStart(event)');
                                img.setAttribute('ondragend', 'handleDragEnd(event)');

                                // Click to enlarge
                                img.onclick = function (e) {
                                    e.stopPropagation();
                                    if (typeof showImage === 'function') {
                                        showImage(this.src);
                                    }
                                };

                                // Hover effect
                                img.onmouseover = function () {
                                    this.style.transform = 'scale(1.05)';
                                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                                };
                                img.onmouseout = function () {
                                    this.style.transform = 'scale(1)';
                                    this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                };
                            });
                        });

                        stitchedHtml += tempDiv.innerHTML + `
                                </div>
                                <div style="margin-top: 20px; display: flex; justify-content: center;">
                                    <button class="action-btn" onclick="openCosting('${fileId}')">ðŸ’° Apply Costing</button>
                                </div>
                                <div style="margin-top: 15px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                    <button class="action-btn" onclick="generateOfferPDF('${fileId}')">ðŸ“„ Download Offer PDF</button>
                                    <button class="action-btn" onclick="generateOfferExcel('${fileId}')">ðŸ“Š Download Offer Excel</button>
                                    <button class="action-btn" onclick="generatePresentationPPTX('${fileId}')">ðŸ“½ï¸ Generate Presentation</button>
                                    <button class="action-btn" onclick="generatePresentationPDF('${fileId}')">ðŸ“‘ Generate Presentation PDF</button>
                                    <button class="action-btn" onclick="generateMAS('${fileId}')">ðŸ“‹ Generate MAS</button>
                                </div>
                            </div>
                        `;

                        stitchResult.innerHTML = stitchedHtml;

                        // Store original HTML for reset functionality
                        window[`originalTable_${fileId}`] = tempDiv.innerHTML;

                        // Setup event delegation for action buttons (if setupTableActionButtons exists)
                        setTimeout(() => {
                            const table = document.getElementById(`table-${fileId}`);
                            if (table) {
                                // Final cleanup pass to ensure no duplicate buttons
                                if (typeof cleanupDuplicateButtons === 'function') {
                                    cleanupDuplicateButtons(table);
                                }
                                if (typeof setupTableActionButtons === 'function') {
                                    setupTableActionButtons(table, fileId);
                                    // Run cleanup again after setup
                                    if (typeof cleanupDuplicateButtons === 'function') {
                                        cleanupDuplicateButtons(table);
                                    }
                                } else {
                                    // Basic event delegation for action buttons
                                    table.addEventListener('click', function (e) {
                                        const button = e.target.closest('.row-action-btn');
                                        if (!button) return;

                                        e.stopPropagation();
                                        e.preventDefault();

                                        const action = button.getAttribute('data-action');
                                        const row = button.closest('tr');
                                        if (!row) return;

                                        if (action === 'add') {
                                            if (typeof handleAddRow === 'function') {
                                                handleAddRow(row, fileId);
                                            }
                                        } else if (action === 'delete') {
                                            if (typeof handleDeleteRow === 'function') {
                                                handleDeleteRow(row);
                                            } else {
                                                if (confirm('Delete this row?')) {
                                                    const table = row.closest('table');
                                                    if (table && table.rows.length > 2) {
                                                        row.remove();
                                                    } else {
                                                        alert('Cannot delete the last row!');
                                                    }
                                                }
                                            }
                                        }
                                    }, true);
                                }
                            }
                        }, 100);

                        showAlert('Tables stitched successfully! You can now edit cells, drag images, and manage rows.', 'success');

                        // Remove ALL error messages after successful stitching - multiple times to ensure cleanup
                        setTimeout(() => removeAllErrorMessages(), 100);
                        setTimeout(() => removeAllErrorMessages(), 500);
                        setTimeout(() => removeAllErrorMessages(), 1000);
                    } else {
                        // Only show error if it's a real failure (not a session cleanup issue)
                        if (!result.error?.includes('File not found') && !result.error?.includes('session')) {
                            stitchResult.innerHTML = `<div style="color: #dc3545; padding: 10px;">Error: ${result.error || 'Failed to stitch tables'}</div>`;
                        }
                    }
                } catch (error) {
                    console.error('Error stitching tables:', error);
                    // Only show error if it's a real failure (not a session cleanup issue)
                    if (!error.message?.includes('File not found') && !error.message?.includes('session')) {
                        stitchResult.innerHTML = `<div style="color: #dc3545; padding: 10px;">Error: ${error.message}</div>`;
                    }
                }
            }
        }

        // Toggle extraction settings panel (legacy - for file items)
        function toggleExtractionSettings() {
            const settingsCard = document.getElementById('extractionSettingsCard');
            if (settingsCard) {
                const isVisible = settingsCard.style.display !== 'none';
                settingsCard.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    settingsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Toggle PP-Structure settings visibility based on extraction method
        function updateExtractionMethodSettings() {
            const method = document.getElementById('setting-extractionMethod')?.value || 'pdfplumber';
            const ppSettings = document.getElementById('ppStructureSettings');
            if (ppSettings) {
                ppSettings.style.display = (method === 'pp-structure' || method === 'pp-structurev3' || method === 'api') ? 'grid' : 'none';
            }
        }

        // Toggle PP-Structure settings visibility for upload area
        function updateUploadExtractionMethodSettings() {
            const method = document.getElementById('upload-setting-extractionMethod')?.value || 'pdfplumber';
            const uploadSettingsPanel = document.getElementById('uploadSettingsPanel');
            if (uploadSettingsPanel) {
                // Show/hide PP-Structure specific settings
                const ppSettings = uploadSettingsPanel.querySelectorAll('[id^="upload-setting-"]:not([id="upload-setting-extractionMethod"])');
                ppSettings.forEach(setting => {
                    if (setting.id.includes('useDocPreprocessor') || setting.id.includes('useSealRecognition') || 
                        setting.id.includes('useTableRecognition') || setting.id.includes('useFormulaRecognition') ||
                        setting.id.includes('useChartRecognition') || setting.id.includes('useRegionDetection') ||
                        setting.id.includes('formatBlockContent') || setting.id.includes('useTextlineOrientation') ||
                        setting.id.includes('useDocOrientationClassify') || setting.id.includes('useDocUnwarping') ||
                        setting.id.includes('visualize') || setting.id.includes('useWiredTableCellsTransToHtml') ||
                        setting.id.includes('useWirelessTableCellsTransToHtml') || setting.id.includes('useTableOrientationClassify') ||
                        setting.id.includes('useOcrResultsWithTableCells') || setting.id.includes('useE2eWiredTableRecModel') ||
                        setting.id.includes('useE2eWirelessTableRecModel') || setting.id.includes('layoutThreshold') ||
                        setting.id.includes('layoutNms') || setting.id.includes('layoutUnclipRatio') ||
                        setting.id.includes('layoutMergeBboxesMode') || setting.id.includes('textDetLimitSideLen') ||
                        setting.id.includes('textDetLimitType') || setting.id.includes('textDetThresh') ||
                        setting.id.includes('textDetBoxThresh') || setting.id.includes('textDetUnclipRatio') ||
                        setting.id.includes('textRecScoreThresh') || setting.id.includes('sealDetLimitSideLen') ||
                        setting.id.includes('sealDetLimitType') || setting.id.includes('sealDetThresh') ||
                        setting.id.includes('sealDetBoxThresh') || setting.id.includes('sealDetUnclipRatio') ||
                        setting.id.includes('sealRecScoreThresh')) {
                        const parent = setting.closest('div');
                        if (parent) {
                            parent.style.display = (method === 'pp-structure' || method === 'pp-structurev3' || method === 'api') ? 'flex' : 'none';
                        }
                    }
                });
            }
        }

        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const extractionMethodSelect = document.getElementById('setting-extractionMethod');
            const uploadExtractionMethodSelect = document.getElementById('upload-setting-extractionMethod');
            
            if (extractionMethodSelect) {
                extractionMethodSelect.addEventListener('change', updateExtractionMethodSettings);
                updateExtractionMethodSettings(); // Initial call
            }
            
            if (uploadExtractionMethodSelect) {
                uploadExtractionMethodSelect.addEventListener('change', updateUploadExtractionMethodSettings);
                updateUploadExtractionMethodSettings(); // Initial call
            }
        });

        // Reset extraction settings to defaults from example JSON
        function resetExtractionSettings() {
            // Basic settings
            document.getElementById('setting-useDocPreprocessor').checked = false;
            document.getElementById('setting-useSealRecognition').checked = true;
            document.getElementById('setting-useTableRecognition').checked = true;
            document.getElementById('setting-useFormulaRecognition').checked = true;
            document.getElementById('setting-useChartRecognition').checked = true;
            document.getElementById('setting-useRegionDetection').checked = true;
            document.getElementById('setting-formatBlockContent').checked = true;
            document.getElementById('setting-useTextlineOrientation').checked = false;
            document.getElementById('setting-useDocOrientationClassify').checked = false;
            document.getElementById('setting-useDocUnwarping').checked = false;
            document.getElementById('setting-visualize').checked = false;

            // Table Recognition Advanced
            document.getElementById('setting-useWiredTableCellsTransToHtml').checked = false;
            document.getElementById('setting-useWirelessTableCellsTransToHtml').checked = false;
            document.getElementById('setting-useTableOrientationClassify').checked = false;
            document.getElementById('setting-useOcrResultsWithTableCells').checked = false;
            document.getElementById('setting-useE2eWiredTableRecModel').checked = false;
            document.getElementById('setting-useE2eWirelessTableRecModel').checked = false;

            // Layout Detection
            document.getElementById('setting-layoutThreshold').value = '0.5';
            document.getElementById('setting-layoutNms').checked = false;
            document.getElementById('setting-layoutUnclipRatio').value = '1.0';
            document.getElementById('setting-layoutMergeBboxesMode').value = 'large';

            // Text Detection
            document.getElementById('setting-textDetLimitSideLen').value = '64';
            document.getElementById('setting-textDetLimitType').value = 'min';
            document.getElementById('setting-textDetThresh').value = '0.3';
            document.getElementById('setting-textDetBoxThresh').value = '0.6';
            document.getElementById('setting-textDetUnclipRatio').value = '1.5';
            document.getElementById('setting-textRecScoreThresh').value = '0.0';

            // Seal Detection
            document.getElementById('setting-sealDetLimitSideLen').value = '736';
            document.getElementById('setting-sealDetLimitType').value = 'min';
            document.getElementById('setting-sealDetThresh').value = '0.2';
            document.getElementById('setting-sealDetBoxThresh').value = '0.6';
            document.getElementById('setting-sealDetUnclipRatio').value = '0.5';
            document.getElementById('setting-sealRecScoreThresh').value = '0.0';

            showAlert('Settings reset to defaults from example JSON', 'success');
        }

        async function extractTable(fileId) {
            // Show the extracted tables card
            const extractedTablesCard = document.getElementById('extractedTablesCard');
            const extractedTablesContainer = document.getElementById('extractedTablesContainer');

            // Create a section for this file's extraction
            let extractionSection = document.getElementById(`extraction-${fileId}`);
            if (!extractionSection) {
                extractionSection = document.createElement('div');
                extractionSection.id = `extraction-${fileId}`;
                extractionSection.className = 'extraction-preview';
                extractedTablesContainer.appendChild(extractionSection);
            }

            extractedTablesCard.style.display = 'block';
            extractionSection.style.display = 'block';
            extractionSection.innerHTML = '<div class="loading"></div> Extracting table data...';

            // Update file status to processing
            const fileStatusElem = document.querySelector(`#file-${fileId} .file-status`);
            if (fileStatusElem) {
                fileStatusElem.className = 'file-status status-processing';
                fileStatusElem.textContent = 'Processing';
            }

            // Scroll to extracted tables section
            extractedTablesCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

            try {
                // Get extraction settings from UI
                const settings = getExtractionSettings();
                console.log('Extraction settings being sent:', settings);
                console.log('Extraction method:', settings.extractionMethod);

                // Determine timeout based on extraction method
                const isApiMethod = settings.extractionMethod === 'pp-structure' || 
                                   settings.extractionMethod === 'pp-structurev3' || 
                                   settings.extractionMethod === 'api';
                const timeout = isApiMethod ? 600000 : 300000; // 10 minutes for API, 5 minutes for pdfplumber
                
                // Show progress message
                if (isApiMethod) {
                    extractionSection.innerHTML = '<div class="loading"></div> Processing with PP-StructureV3 API (this may take several minutes for large files)...';
                } else {
                    extractionSection.innerHTML = '<div class="loading"></div> Extracting with PDFPlumber...';
                }

                // Create AbortController for timeout handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, timeout);

                let response;
                try {
                    response = await fetch(`/extract/${fileId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error(`Request timed out after ${timeout / 1000 / 60} minutes. The extraction may still be processing on the server. Please check the server logs.`);
                    }
                    throw fetchError;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error', message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    displayExtractionResult(fileId, result.result);
                    const methodName = result.extraction_method === 'pp-structure' || result.extraction_method === 'pp-structurev3' || result.extraction_method === 'api' 
                        ? 'PP-StructureV3 API' : 'PDFPlumber';
                    showAlert(`Extraction completed using ${methodName}! âœ“`, 'success');

                    // Show download button
                    const downloadBtn = document.getElementById(`download-${fileId}`);
                    if (downloadBtn) {
                        downloadBtn.style.display = 'inline-block';
                    }

                    // Update file status
                    if (fileStatusElem) {
                        fileStatusElem.className = 'file-status status-extracted';
                        fileStatusElem.textContent = 'Extracted';
                    }

                    // Automatically stitch tables after extraction
                    // Wait a bit longer to ensure session is updated and use the fileId from the response
                    setTimeout(async () => {
                        try {
                            // Verify file exists in session before stitching
                            const filesResponse = await fetch('/api/files/list');
                            const filesData = await filesResponse.json();
                            const fileExists = filesData.files && filesData.files.some(f => f.id === fileId);
                            
                            if (!fileExists) {
                                console.warn(`File ${fileId} not found in session, skipping auto-stitch`);
                                return;
                            }
                            
                            // Check if stitchTables function exists
                            if (typeof stitchTables === 'function') {
                                await stitchTables(fileId);
                            } else {
                                // Fallback: call stitch endpoint directly
                                const stitchResponse = await fetch(`/stitch-tables/${fileId}`, { method: 'POST' });
                                const stitchResult = await stitchResponse.json();
                                if (stitchResult.success) {
                                    showAlert('Tables stitched successfully!', 'success');
                                } else {
                                    console.warn('Stitching failed:', stitchResult.error);
                                    // Don't show error to user as extraction was successful - user can manually stitch
                                }
                            }
                        } catch (error) {
                            console.error('Error stitching tables:', error);
                            // Don't show error to user as extraction was successful - user can manually stitch
                        }
                    }, 1500);
                } else {
                    // Display detailed error message if available
                    let errorMsg = result.error || 'Unknown error occurred';
                    if (result.message) {
                        errorMsg = `${result.error}: ${result.message}`;
                    }
                    if (result.details) {
                        errorMsg += `<br><small>Details: ${result.details}</small>`;
                    }
                    if (result.hint) {
                        errorMsg += `<br><small style="color: #666;">ðŸ’¡ ${result.hint}</small>`;
                    }
                    extractionSection.innerHTML = `<div class="alert-error">âš ï¸ ${errorMsg}</div>`;
                    showAlert(errorMsg, 'error');
                    // Reset status to uploaded
                    if (fileStatusElem) {
                        fileStatusElem.className = 'file-status status-uploaded';
                        fileStatusElem.textContent = 'Uploaded';
                    }
                }
            } catch (error) {
                console.error('Extraction error:', error);
                let errorMsg = error.message || 'An unexpected error occurred during extraction';
                
                // Handle timeout specifically
                if (errorMsg.includes('timeout') || errorMsg.includes('timed out')) {
                    errorMsg = `Request timed out. The extraction may still be processing on the server. Large files with PP-StructureV3 API can take 5-10 minutes. Please check the server logs or try again later.`;
                    extractionSection.innerHTML = `<div class="alert-error" style="padding: 15px;">
                        <strong>âš ï¸ Request Timeout</strong><br>
                        ${errorMsg}<br>
                        <small style="color: #888;">The backend may still be processing. Check server logs for progress.</small>
                    </div>`;
                } else {
                    extractionSection.innerHTML = `<div class="alert-error">âš ï¸ Error: ${errorMsg}</div>`;
                }
                
                showAlert(errorMsg, 'error');
                // Reset status to uploaded
                if (fileStatusElem) {
                    fileStatusElem.className = 'file-status status-uploaded';
                    fileStatusElem.textContent = 'Uploaded';
                }
                
                // Auto-refresh page after 3 seconds to allow new upload
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        }

        function displayExtractionResult(fileId, result) {
            const extractionSection = document.getElementById(`extraction-${fileId}`);

            // Get filename for display
            const fileNameElem = document.querySelector(`#file-${fileId} .file-name`);
            const fileName = fileNameElem ? fileNameElem.textContent : 'File';

            let html = `
                <div style="border-left: 4px solid #d4af37; padding-left: 20px; margin-bottom: 30px;">
                    <h3 style="color: #d4af37; margin-bottom: 10px;">ðŸ“„ ${fileName}</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-btn btn-info" onclick="downloadExtracted('${fileId}', 'excel')">ðŸ’¾ Download Raw Data</button>
                        <button class="action-btn btn-success" onclick="openCosting('${fileId}')">ðŸ’° Apply Costing</button>
                        <button class="action-btn" onclick="toggleRawData('${fileId}')" id="toggle-raw-${fileId}" style="background: #6c757d; color: #0f1419;">ðŸ‘ï¸ Show Raw Data</button>
                    </div>
                    <div id="stitch-result-${fileId}" style="display:none;"></div>
                    <div id="raw-data-${fileId}" style="display:none;">
                        <h4 style="color: #d4af37; margin-top: 20px;">Raw Extraction Data (All Pages)</h4>
            `;

            // Check if this is an Excel file result
            if (result.file_type === 'excel') {
                // Display Excel sheets
                html += `<div style="margin-bottom: 20px;">
                    <p style="color: #10b981; font-weight: 600;">âœ… ${result.message}</p>
                    <p style="color: #888; font-size: 14px;">Extraction Method: ${result.extraction_type}</p>
                    <p style="color: #888; font-size: 14px;">Total Sheets: ${result.sheet_count}</p>
                </div>`;

                // Display each sheet
                Object.keys(result.sheets).forEach((sheetName, idx) => {
                    const sheet = result.sheets[sheetName];
                    html += `<div style="margin-bottom: 30px;">
                        <h4 style="color: #b8941f;">ðŸ“Š Sheet: ${sheetName}</h4>`;
                    
                    if (sheet.error) {
                        html += `<p style="color: #ef4444;">Error: ${sheet.error}</p>`;
                    } else {
                        html += `<p style="color: #888; font-size: 14px;">Rows: ${sheet.shape[0]} | Columns: ${sheet.shape[1]}</p>`;
                        
                        // Display the table
                        if (sheet.html) {
                            let tempDiv = document.createElement('div');
                            tempDiv.innerHTML = sheet.html;
                            
                            // Style the table
                            tempDiv.querySelectorAll('table').forEach(table => {
                                table.style.width = '100%';
                                table.style.borderCollapse = 'collapse';
                                table.style.marginTop = '20px';
                                table.style.marginBottom = '20px';
                                table.setAttribute('border', '1');

                                // Style cells
                                table.querySelectorAll('td, th').forEach(cell => {
                                    cell.style.border = '1px solid #ddd';
                                    cell.style.padding = '12px';
                                    cell.style.textAlign = 'left';
                                    cell.style.verticalAlign = 'middle';
                                    cell.style.color = '#333';
                                    cell.style.backgroundColor = '#fff';
                                });

                                // Style header row
                                table.querySelectorAll('th').forEach(th => {
                                    th.style.backgroundColor = '#d4af37';
                                    th.style.color = 'white';
                                    th.style.fontWeight = '600';
                                });

                                // Alternate row colors
                                let rows = table.querySelectorAll('tr');
                                rows.forEach((row, i) => {
                                    if (i > 0 && i % 2 === 0) {
                                        row.querySelectorAll('td').forEach(td => {
                                            td.style.backgroundColor = '#f8f9fa';
                                        });
                                    }
                                });
                            });
                            
                            html += `<div style="overflow-x: auto;">${tempDiv.innerHTML}</div>`;
                        }
                    }
                    html += '</div>';
                });
            } else {
                // Handle the prunedResult format from PP-StructureV3 - but hide it by default
                result.layoutParsingResults.forEach((layoutResult, idx) => {
                html += `<div style="margin-bottom: 30px;"><h4 style="color: #b8941f;">Page ${idx + 1}</h4>`;

                // Check if prunedResult exists
                const prunedResult = layoutResult.prunedResult;
                if (prunedResult && prunedResult.parsing_res_list) {
                    // Process each block in the parsing results
                    prunedResult.parsing_res_list.forEach((block, blockIdx) => {
                        if (block.block_label === 'table' && block.block_content) {
                            // Render table content
                            let tableContent = block.block_content;

                            // Extract and render HTML tables
                            let tempDiv = document.createElement('div');
                            tempDiv.innerHTML = tableContent;

                            // Style all tables
                            tempDiv.querySelectorAll('table').forEach(table => {
                                table.style.width = '100%';
                                table.style.borderCollapse = 'collapse';
                                table.style.marginTop = '20px';
                                table.style.marginBottom = '20px';
                                table.setAttribute('border', '1');

                                // Style cells
                                table.querySelectorAll('td, th').forEach(cell => {
                                    cell.style.border = '1px solid #ddd';
                                    cell.style.padding = '12px';
                                    cell.style.textAlign = 'left';
                                    cell.style.verticalAlign = 'middle';
                                });

                                // Style header row
                                table.querySelectorAll('th').forEach(th => {
                                    th.style.backgroundColor = '#d4af37';
                                    th.style.color = 'white';
                                    th.style.fontWeight = '600';
                                });

                                // Alternate row colors
                                let rows = table.querySelectorAll('tr');
                                rows.forEach((row, i) => {
                                    if (i > 0 && i % 2 === 0) {
                                        row.style.backgroundColor = '#f8f9fa';
                                    }
                                });

                                // Style images inside table cells
                                table.querySelectorAll('img').forEach(img => {
                                    img.style.maxWidth = '150px';
                                    img.style.maxHeight = '150px';
                                    img.style.width = 'auto';
                                    img.style.height = 'auto';
                                    img.style.display = 'block';
                                    img.style.margin = '5px auto';
                                    img.style.borderRadius = '4px';
                                    img.style.cursor = 'pointer';
                                    img.style.objectFit = 'contain';

                                    // Add click to enlarge
                                    img.onclick = function () {
                                        showImage(this.src);
                                    };
                                });
                            });

                            html += `<div style="overflow-x: auto;">${tempDiv.innerHTML}</div>`;
                        } else if (block.block_content) {
                            // Render other content types as formatted text
                            html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;"><strong>${block.block_label}:</strong><br><pre style="white-space: pre-wrap; margin-top: 10px;">${block.block_content}</pre></div>`;
                        }
                    });
                }
                html += '</div>'; // Close page div
            });
            } // Close else block for non-Excel files

            html += '</div>'; // Close raw-data div
            html += '</div>'; // Close file extraction div
            extractionSection.innerHTML = html;
        }

        function toggleRawData(fileId) {
            const rawDataDiv = document.getElementById(`raw-data-${fileId}`);
            const toggleBtn = document.getElementById(`toggle-raw-${fileId}`);

            if (rawDataDiv.style.display === 'none') {
                rawDataDiv.style.display = 'block';
                toggleBtn.textContent = 'ðŸ‘ï¸ Hide Raw Data';
            } else {
                rawDataDiv.style.display = 'none';
                toggleBtn.textContent = 'ðŸ‘ï¸ Show Raw Data';
            }
        }

        function downloadExtracted(fileId, format) {
            window.open(`/download/extracted/${fileId}?format=${format}`, '_blank');
        }

        async function deleteFile(fileId) {
            if (!confirm('Are you sure you want to delete this file?')) return;

            try {
                const response = await fetch(`/delete-file/${fileId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('File deleted successfully', 'success');

                    // Remove extraction preview if exists
                    const extractionPreview = document.getElementById(`extraction-${fileId}`);
                    if (extractionPreview) {
                        extractionPreview.remove();
                    }

                    // Hide extracted tables card if no more extractions
                    const extractedTablesContainer = document.getElementById('extractedTablesContainer');
                    if (extractedTablesContainer && extractedTablesContainer.children.length === 0) {
                        document.getElementById('extractedTablesCard').style.display = 'none';
                    }

                    if (typeof window.loadFileList === 'function') {
                        window.loadFileList();
                    }
                } else {
                    showAlert('Delete failed: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Delete error: ' + error.message, 'error');
            }
        }

        async function cleanupFiles() {
            if (!confirm('This will delete all uploaded files. Continue?')) return;

            try {
                const response = await fetch('/cleanup', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('All files cleaned up', 'success');

                    // Clear extracted tables
                    const extractedTablesContainer = document.getElementById('extractedTablesContainer');
                    if (extractedTablesContainer) {
                        extractedTablesContainer.innerHTML = '';
                    }
                    document.getElementById('extractedTablesCard').style.display = 'none';

                    // File list refresh removed as uploaded files card is no longer displayed
                }
            } catch (error) {
                showAlert('Cleanup error: ' + error.message, 'error');
            }
        }

        function showImage(imagePath) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imagePath;
            modal.style.display = 'flex';

            // Close on ESC key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);

            // Close on click outside image (on modal background)
            const handleModalClick = (e) => {
                if (e.target === modal) {
                    closeModal();
                    modal.removeEventListener('click', handleModalClick);
                }
            };
            modal.addEventListener('click', handleModalClick);
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // Alert function
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: #0f1419;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // Upload notification function
        function showUploadNotification(title, subtitle, icon = 'ðŸ“¤') {
            const notification = document.getElementById('uploadNotification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationSubtitle = document.getElementById('notificationSubtitle');
            const notificationIcon = notification.querySelector('.upload-notification-icon');

            notificationTitle.textContent = title;
            notificationSubtitle.textContent = subtitle;
            notificationIcon.textContent = icon;

            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Generate Offer function
        async function generateOffer(format) {
            if (!currentFileIdForCosting) {
                showAlert('Please apply costing first', 'error');
                return;
            }

            let popup = null;
            try {
                // Show progress popup
                const formatName = format === 'pdf' ? 'Offer PDF' : 'Offer Excel';
                popup = showProgressPopup(`Preparing ${formatName}...`);
                updateProgressPopup(20, `Preparing ${formatName}...`);

                updateProgressPopup(50, `Generating ${formatName}...`);
                const response = await fetch(`/generate-offer/${currentFileIdForCosting}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    updateProgressPopup(90, 'Finalizing...');
                    // Download based on format
                    if (format === 'pdf') {
                        window.open(`/download/offer/${currentFileIdForCosting}?format=pdf`, '_blank');
                    } else if (format === 'excel') {
                        window.open(`/download/offer/${currentFileIdForCosting}?format=excel`, '_blank');
                    }
                    
                    updateProgressPopup(100, 'Completed!');
                    setTimeout(() => {
                        closeProgressPopup();
                        showAlert(`âœ… ${formatName} generated successfully!`, 'success');
                    }, 800);
                } else {
                    closeProgressPopup();
                    showAlert('Error: ' + result.error, 'error');
                }
            } catch (error) {
                closeProgressPopup();
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Generate Presentation function
        async function generatePresentation(format) {
            // Use currentFileId (from extraction) if costing hasn't been applied
            const fileId = currentFileIdForCosting || currentFileId;

            if (!fileId) {
                showAlert('Please extract tables first', 'error');
                return;
            }

            let popup = null;
            try {
                const formatName = format === 'pdf' ? 'Presentation PDF' : 'Presentation PPTX';
                popup = showProgressPopup(`Preparing ${formatName}...`);
                updateProgressPopup(20, `Preparing ${formatName}...`);

                updateProgressPopup(50, `Generating ${formatName}...`);
                const response = await fetch(`/generate-presentation/${fileId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ format: format })
                });

                const result = await response.json();

                if (result.success) {
                    updateProgressPopup(90, 'Finalizing...');
                    // Download the file
                    window.open(`/download/presentation/${fileId}?format=${format}`, '_blank');
                    
                    updateProgressPopup(100, 'Completed!');
                    setTimeout(() => {
                        closeProgressPopup();
                        showAlert(`âœ… ${formatName} generated successfully!`, 'success');
                    }, 800);
                } else {
                    closeProgressPopup();
                    showAlert('Error: ' + result.error, 'error');
                }
            } catch (error) {
                closeProgressPopup();
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Generate MAS function
        async function generateMAS(passedFileId) {
            // Use passed fileId parameter, or fallback to currentFileIdForCosting
            const fileId = passedFileId || currentFileIdForCosting;
            
            console.log('generateMAS called - passedFileId:', passedFileId, 'currentFileIdForCosting:', currentFileIdForCosting, 'using fileId:', fileId);

            if (!fileId) {
                showAlert('Please extract tables first', 'error');
                return;
            }

            let popup = null;
            try {
                popup = showProgressPopup('Preparing MAS PDF...');
                updateProgressPopup(20, 'Preparing MAS PDF...');

                updateProgressPopup(50, 'Generating Material Approval Sheet...');

                const response = await fetch(`/generate-mas/${fileId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    updateProgressPopup(90, 'Finalizing...');
                    // Download the file
                    window.open(`/download/mas/${fileId}?format=pdf`, '_blank');
                    
                    updateProgressPopup(100, 'Completed!');
                    setTimeout(() => {
                        closeProgressPopup();
                        showAlert('âœ… Material Approval Sheet generated successfully!', 'success');
                    }, 800);
                } else {
                    closeProgressPopup();
                    showAlert('Error: ' + result.error, 'error');
                }
            } catch (error) {
                closeProgressPopup();
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Value Engineering function
        async function generateAlternativeOffers() {
            console.log('generateAlternativeOffers called');

            // Check if stitched table exists - look for any table in the preview area
            const stitchedTable = document.querySelector('table[border="1"]') ||
                document.querySelector('table') ||
                document.querySelector('.editable-table');

            console.log('Found table:', stitchedTable);

            if (!stitchedTable) {
                showAlert('Please stitch tables first before generating alternatives', 'error');
                return;
            }

            // Show progress modal
            showProgressModal('Generating Alternative Offers');
            updateProgress('Initializing...', 0);

            try {
                // Load alternatives directly from existing table (fileId not needed - we read from DOM)
                await loadValueEngineeringData(null);

                updateProgress('Building alternative table...', 90);

                // Create and display the alternative offers table
                displayAlternativeOffersTable();

                updateProgress('Complete!', 100);
                setTimeout(() => {
                    hideProgressModal();
                    showAlert('Alternative offers generated successfully!', 'success');
                }, 500);
            } catch (error) {
                console.error('Value Engineering error:', error);
                hideProgressModal();
                showAlert('Error generating alternatives: ' + error.message, 'error');
            }
        }

        // Show Value Engineering Modal
        function showValueEngineeringModal(fileId) {
            const modal = document.getElementById('valueEngineeringModal');
            if (!modal) {
                createValueEngineeringModal(fileId);
            } else {
                loadValueEngineeringData(fileId);
                modal.style.display = 'block';
            }
        }

        // Create Value Engineering Modal
        function createValueEngineeringModal(fileId) {
            const modalHTML = `
                <div id="valueEngineeringModal" class="ve-modal">
                    <div class="ve-modal-content">
                        <div class="ve-modal-header">
                            <h2>ðŸ“Š Quote Alternatives - Value Engineering</h2>
                            <span class="ve-modal-close" onclick="closeValueEngineeringModal()">&times;</span>
                        </div>
                        
                        <div class="ve-modal-body">
                            <!-- Budget Tier Tabs -->
                            <div class="ve-tier-tabs">
                                <button class="ve-tier-tab active" data-tier="budgetary" onclick="selectBudgetTier('budgetary')">
                                    ðŸ’° Budgetary
                                </button>
                                <button class="ve-tier-tab" data-tier="mid_range" onclick="selectBudgetTier('mid_range')">
                                    â­ Mid-Range
                                </button>
                                <button class="ve-tier-tab" data-tier="high_end" onclick="selectBudgetTier('high_end')">
                                    ðŸ‘‘ High-End
                                </button>
                            </div>
                            
                            <!-- Summary Section -->
                            <div class="ve-summary-card">
                                <div class="ve-summary-item">
                                    <span class="ve-summary-label">Original Estimate:</span>
                                    <span class="ve-summary-value" id="veOriginalTotal">OMR 0.00</span>
                                </div>
                                <div class="ve-summary-item">
                                    <span class="ve-summary-label">New Total:</span>
                                    <span class="ve-summary-value ve-new-total" id="veNewTotal">OMR 0.00</span>
                                </div>
                                <div class="ve-summary-item">
                                    <span class="ve-summary-label">Difference:</span>
                                    <span class="ve-summary-value" id="veDifference">OMR 0.00 (0%)</span>
                                </div>
                                <div class="ve-summary-item">
                                    <span class="ve-summary-label">Items Selected:</span>
                                    <span class="ve-summary-value" id="veProgress">0 / 0</span>
                                </div>
                            </div>
                            
                            <!-- BOQ Items List -->
                            <div id="veItemsList" class="ve-items-list">
                                <div class="ve-loading">Loading items...</div>
                            </div>
                        </div>
                        
                        <div class="ve-modal-footer">
                            <button class="btn btn-secondary" onclick="closeValueEngineeringModal()">Close</button>
                            <button class="btn btn-success" onclick="exportAlternativeQuote()">ðŸ“¥ Export Alternative Quote</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            loadValueEngineeringData(fileId);
        }

        // Close Value Engineering Modal
        function closeValueEngineeringModal() {
            const modal = document.getElementById('valueEngineeringModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        let currentVEFileId = null;
        let veItems = [];
        let veSelections = {};

        // Load Value Engineering Data from existing stitched table
        async function loadValueEngineeringData(fileId) {
            currentVEFileId = fileId;

            try {
                updateProgress('Reading table data...', 10);

                // Get the existing stitched table data from DOM
                const stitchedTable = document.querySelector('table[border="1"]') ||
                    document.querySelector('table') ||
                    document.querySelector('.editable-table');

                if (!stitchedTable) {
                    hideProgressModal();
                    showAlert('No stitched table found. Please stitch tables first.', 'error');
                    return;
                }

                updateProgress('Parsing items...', 20);

                // Parse the existing table to get items
                veItems = parseStitchedTableToItems(stitchedTable);

                console.log('Parsed veItems:', veItems);

                if (veItems.length === 0) {
                    hideProgressModal();
                    showAlert('No items found in table', 'warning');
                    console.warn('No items extracted from table');
                    return;
                }

                console.log(`Found ${veItems.length} items to process`);
                updateProgress(`Processing ${veItems.length} items...`, 30);

                // Fetch alternatives for each item based on budget tier
                await fetchAlternativesForItems(currentBudgetTier);

                console.log('Alternatives fetched successfully');
                updateProgress('Finalizing data...', 80);

            } catch (error) {
                showAlert('Error loading alternatives: ' + error.message, 'error');
                throw error;
            }
        }

        // Display Alternative Offers Table
        function displayAlternativeOffersTable() {
            console.log('displayAlternativeOffersTable called');

            // Get the original table to copy structure
            const originalTable = document.querySelector('table[border="1"]') ||
                document.querySelector('table');

            if (!originalTable) {
                showAlert('Original table not found', 'error');
                return;
            }

            // Create container for alternative offers
            let altOffersContainer = document.getElementById('alternativeOffersContainer');
            if (!altOffersContainer) {
                altOffersContainer = document.createElement('div');
                altOffersContainer.id = 'alternativeOffersContainer';
                altOffersContainer.style.cssText = 'margin-top: 40px; padding: 30px; background: rgba(26, 54, 93, 0.95); border-radius: 15px; border: 2px solid #d4af37;';

                // Insert after the original table - try multiple strategies
                const previewContainer = document.getElementById('preview-content');
                if (previewContainer) {
                    console.log('Appending to preview-content');
                    previewContainer.appendChild(altOffersContainer);
                } else {
                    // Fallback: insert after the table itself
                    console.log('Inserting after table parent');
                    const tableParent = originalTable.parentElement;
                    if (tableParent && tableParent.parentElement) {
                        tableParent.parentElement.insertBefore(altOffersContainer, tableParent.nextSibling);
                    } else {
                        // Last resort: append to body
                        console.log('Appending to document body');
                        document.body.appendChild(altOffersContainer);
                    }
                }
            } else {
                console.log('Reusing existing container');
            }

            // Build the HTML for the alternative offers section
            let html = `
                <div style=\"margin-bottom: 25px;\">
                    <h3 style=\"color: #d4af37; margin-bottom: 20px; font-size: 1.8em;\">\ud83d\udca1 Alternative Offers - Value Engineering</h3>
                    
                    <!-- Budget Tier Selector -->
                    <div style=\"margin-bottom: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;\">
                        <label style=\"color: #d4af37; font-weight: bold; margin-bottom: 10px; display: block;\">Select Budget Tier:</label>
                        <div style=\"display: flex; gap: 15px; flex-wrap: wrap;\">
                            <button onclick=\"changeBudgetTier('budgetary')\" id=\"tier-budgetary\" class=\"tier-btn active\" style=\"flex: 1; min-width: 150px; padding: 15px 25px; border: 2px solid #d4af37; border-radius: 8px; background: #d4af37; color: #1a365d; font-weight: 600; cursor: pointer; transition: all 0.3s;\">\ud83d\udcb0 Budgetary</button>
                            <button onclick=\"changeBudgetTier('mid_range')\" id=\"tier-mid_range\" class=\"tier-btn\" style=\"flex: 1; min-width: 150px; padding: 15px 25px; border: 2px solid #d4af37; border-radius: 8px; background: transparent; color: #d4af37; font-weight: 600; cursor: pointer; transition: all 0.3s;\">â­ Mid-Range</button>
                            <button onclick=\"changeBudgetTier('high_end')\" id=\"tier-high_end\" class=\"tier-btn\" style=\"flex: 1; min-width: 150px; padding: 15px 25px; border: 2px solid #d4af37; border-radius: 8px; background: transparent; color: #d4af37; font-weight: 600; cursor: pointer; transition: all 0.3s;\">\ud83d\udc51 High-End</button>
                        </div>
                    </div>
                    
                    <!-- Export Buttons -->
                    <div style=\"margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap;\">
                        <button onclick=\"applySelectedAlternatives()\" class=\"action-btn\" style=\"background: #d4af37; color: #1a365d; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\u2713 Apply Selected Items</button>
                        <button onclick=\"openAddBrandModal()\" class=\"action-btn\" style=\"background: #8b5cf6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">âž• Add Brand</button>
                        <button onclick=\"exportAlternativeTable('excel')\" class=\"action-btn\" style=\"background: #10b981; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;\">\ud83d\udcbe Export to Excel</button>
                        <button onclick=\"exportAlternativeTable('pdf')\" class=\"action-btn\" style=\"background: #ef4444; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;\">\ud83d\udcc4 Export to PDF</button>
                        <button onclick=\"downloadAlternativeTable()\" class=\"action-btn\" style=\"background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;\">\u2b07\ufe0f Download Edited Table</button>
                    </div>
                </div>
                
                <!-- Alternative Offers Table -->
                <div style=\"max-height: 600px; overflow: auto; border: 1px solid #d4af37; border-radius: 10px; background: white;\" id=\"altTableContainer\">
                    <!-- Table will be inserted here -->
                </div>
            `;

            altOffersContainer.innerHTML = html;

            // Now create and insert the actual table
            createAlternativeTable();

            // Scroll to the new table
            altOffersContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Create the alternative table with columns
        function createAlternativeTable() {
            console.log('createAlternativeTable called');
            const container = document.getElementById('altTableContainer');
            if (!container) {
                console.error('altTableContainer not found!');
                return;
            }

            console.log('Container found, creating table with', veItems.length, 'items');

            // Create table
            const table = document.createElement('table');
            table.border = '1';
            table.style.cssText = 'width: 100%; border-collapse: collapse; background: white;';
            table.contentEditable = 'true';

            console.log('Table element created');

            // Create thead with original + alternative columns
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // Original columns
            const originalHeaders = ['SI.No', 'Image', 'Item Description', 'Qty', 'Unit', 'Unit Rate (OMR)', 'Amount (OMR)'];
            originalHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.cssText = 'background: #1a365d; color: #d4af37; font-weight: bold; padding: 12px; border: 1px solid #d4af37; white-space: nowrap;';
                headerRow.appendChild(th);
            });

            // Alternative columns
            const altHeaders = ['Alternative Selection', 'Alt. Image', 'Alt. Description', 'Alt. Unit Rate (OMR)', 'Alt. Total (OMR)', 'Difference', '% Savings'];
            altHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.cssText = 'background: #d4af37; color: #1a365d; font-weight: bold; padding: 12px; border: 1px solid #b8941f; white-space: nowrap;';
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create tbody with data
            const tbody = document.createElement('tbody');

            veItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.style.cssText = index % 2 === 0 ? 'background: #f9fafb;' : 'background: white;';

                // Set the item's display index for consistent reference
                item.displayIndex = index;

                // Original data columns
                const siNoCell = document.createElement('td');
                siNoCell.contentEditable = 'true';
                siNoCell.textContent = index + 1;
                siNoCell.style.cssText = 'padding: 10px; border: 1px solid #ddd; text-align: center;';
                row.appendChild(siNoCell);

                // Image cell for original item
                const imgCell = document.createElement('td');
                imgCell.contentEditable = 'false';
                imgCell.style.cssText = 'padding: 5px; border: 1px solid #ddd; text-align: center;';
                if (item.imageUrl) {
                    const img = document.createElement('img');
                    img.src = item.imageUrl;
                    img.style.cssText = 'max-width: 80px; max-height: 80px; object-fit: contain;';
                    img.alt = item.description;
                    imgCell.appendChild(img);
                } else {
                    imgCell.textContent = '-';
                }
                row.appendChild(imgCell);

                const descCell = document.createElement('td');
                descCell.contentEditable = 'true';
                descCell.textContent = item.description;
                descCell.style.cssText = 'padding: 10px; border: 1px solid #ddd;';
                row.appendChild(descCell);

                const qtyCell = document.createElement('td');
                qtyCell.contentEditable = 'true';
                qtyCell.textContent = item.qty;
                qtyCell.style.cssText = 'padding: 10px; border: 1px solid #ddd; text-align: center;';
                row.appendChild(qtyCell);

                const unitCell = document.createElement('td');
                unitCell.contentEditable = 'true';
                unitCell.textContent = item.unit;
                unitCell.style.cssText = 'padding: 10px; border: 1px solid #ddd; text-align: center;';
                row.appendChild(unitCell);

                const rateCell = document.createElement('td');
                rateCell.contentEditable = 'true';
                rateCell.textContent = item.unit_rate.toFixed(2);
                rateCell.style.cssText = 'padding: 10px; border: 1px solid #ddd; text-align: right;';
                row.appendChild(rateCell);

                const totalCell = document.createElement('td');
                totalCell.contentEditable = 'true';
                totalCell.textContent = item.total.toFixed(2);
                totalCell.style.cssText = 'padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold;';
                row.appendChild(totalCell);

                // Alternative columns - Create cascading dropdowns
                const selectCell = document.createElement('td');
                selectCell.contentEditable = 'false';
                selectCell.style.cssText = 'padding: 8px; border: 1px solid #ddd;';

                // Create a container for the cascading dropdowns
                const dropdownContainer = document.createElement('div');
                dropdownContainer.style.cssText = 'display: flex; flex-direction: column; gap: 5px;';

                // Category dropdown
                const categorySelect = document.createElement('select');
                categorySelect.className = 've-category-select';
                categorySelect.style.cssText = 'width: 100%; padding: 6px; border: 1px solid #d4af37; border-radius: 4px; background: white; color: #1a365d; font-size: 0.85em;';
                categorySelect.dataset.itemIndex = index;

                const catDefaultOption = document.createElement('option');
                catDefaultOption.value = '';
                catDefaultOption.textContent = '-- Select Category --';
                categorySelect.appendChild(catDefaultOption);

                // Categories will be loaded dynamically - fetch them now
                loadCategoriesForDropdown(categorySelect, currentBudgetTier || 'budgetary');

                // Brand dropdown (initially disabled)
                const brandSelect = document.createElement('select');
                brandSelect.className = 've-brand-select';
                brandSelect.style.cssText = 'width: 100%; padding: 6px; border: 1px solid #d4af37; border-radius: 4px; background: white; color: #1a365d; font-size: 0.85em;';
                brandSelect.dataset.itemIndex = index;
                brandSelect.disabled = true;

                const brandDefaultOption = document.createElement('option');
                brandDefaultOption.value = '';
                brandDefaultOption.textContent = '-- Select Brand --';
                brandSelect.appendChild(brandDefaultOption);

                // Model dropdown (initially disabled)
                const modelSelect = document.createElement('select');
                modelSelect.className = 've-model-select';
                modelSelect.style.cssText = 'width: 100%; padding: 6px; border: 1px solid #d4af37; border-radius: 4px; background: white; color: #1a365d; font-size: 0.85em;';
                modelSelect.dataset.itemIndex = index;
                modelSelect.disabled = true;

                const modelDefaultOption = document.createElement('option');
                modelDefaultOption.value = '';
                modelDefaultOption.textContent = '-- Select Model --';
                modelSelect.appendChild(modelDefaultOption);

                // Event listener for category change
                categorySelect.addEventListener('change', (e) => {
                    const selectedCategory = e.target.value;
                    item.category = selectedCategory;
                    item.subcategory = null;
                    item.selectedBrand = null;
                    item.selectedModel = null;

                    // Reset and populate brand dropdown
                    brandSelect.innerHTML = '';
                    brandSelect.appendChild(brandDefaultOption.cloneNode(true));
                    modelSelect.innerHTML = '';
                    modelSelect.appendChild(modelDefaultOption.cloneNode(true));
                    modelSelect.disabled = true;

                    if (selectedCategory === 'general') {
                        // For general category, add Local option
                        brandSelect.disabled = false;
                        const localOption = document.createElement('option');
                        localOption.value = 'Local';
                        localOption.textContent = 'Local';
                        brandSelect.appendChild(localOption);
                    } else if (selectedCategory && allBrandsData[selectedCategory]) {
                        brandSelect.disabled = false;
                        Object.keys(allBrandsData[selectedCategory]).forEach(brandName => {
                            const option = document.createElement('option');
                            option.value = brandName;
                            option.textContent = brandName;
                            brandSelect.appendChild(option);
                        });
                    } else {
                        brandSelect.disabled = true;
                    }

                    // Clear alternative data display
                    clearAlternativeDataInRow(row);
                });

                // Event listener for brand change
                brandSelect.addEventListener('change', (e) => {
                    const selectedBrand = e.target.value;
                    item.selectedBrand = selectedBrand;
                    item.selectedModel = null;

                    // Reset and populate model dropdown
                    modelSelect.innerHTML = '';
                    modelSelect.appendChild(modelDefaultOption.cloneNode(true));

                    if (selectedBrand === 'Local' && item.category === 'general') {
                        // For Local brand in general category, add general item option
                        modelSelect.disabled = false;
                        const generalOption = document.createElement('option');
                        generalOption.value = JSON.stringify({
                            model: 'General Item',
                            price_range: '0-0',
                            features: ['Custom item'],
                            subcategory: 'general'
                        });
                        generalOption.textContent = 'General Item';
                        modelSelect.appendChild(generalOption);
                    } else if (selectedBrand && item.category && allBrandsData[item.category][selectedBrand]) {
                        modelSelect.disabled = false;
                        const brandData = allBrandsData[item.category][selectedBrand];

                        // Add all models from all subcategories for this brand
                        Object.keys(brandData.models).forEach(subcategory => {
                            brandData.models[subcategory].forEach(model => {
                                const option = document.createElement('option');
                                option.value = JSON.stringify({
                                    model: model.model,
                                    price_range: model.price_range,
                                    features: model.features,
                                    subcategory: subcategory
                                });
                                // Display without price
                                option.textContent = model.model;
                                modelSelect.appendChild(option);
                            });
                        });
                    } else {
                        modelSelect.disabled = true;
                    }

                    // Clear alternative data display
                    clearAlternativeDataInRow(row);
                });

                // Event listener for model change
                modelSelect.addEventListener('change', (e) => {
                    const selectedValue = e.target.value;
                    if (selectedValue) {
                        const modelData = JSON.parse(selectedValue);
                        item.selectedModel = modelData.model;
                        item.subcategory = modelData.subcategory;

                        // Calculate alternative pricing
                        const priceRange = modelData.price_range.split('-');
                        const avgPrice = (parseFloat(priceRange[0]) + parseFloat(priceRange[1])) / 2;
                        const altTotal = avgPrice * item.qty;

                        // Handle Local/General differently - no brand data lookup needed
                        if (item.selectedBrand === 'Local' && item.category === 'general') {
                            // For general items, use original pricing as alternative
                            updateAlternativeDataInRow(row, {
                                brand: 'Local',
                                model: modelData.model,
                                unit_rate: item.unit_rate,
                                total: item.total,
                                country: 'Local'
                            }, item);
                        } else {
                            const brandData = allBrandsData[item.category][item.selectedBrand];

                            // Update row with alternative data including features
                            updateAlternativeDataInRow(row, {
                                brand: item.selectedBrand,
                                model: modelData.model,
                                unit_rate: avgPrice,
                                total: altTotal,
                                country: brandData.country,
                                features: modelData.features || []
                            }, item);
                        }
                    }
                });

                dropdownContainer.appendChild(categorySelect);
                dropdownContainer.appendChild(brandSelect);
                dropdownContainer.appendChild(modelSelect);
                selectCell.appendChild(dropdownContainer);

                row.appendChild(selectCell);

                // Alternative image cell
                const altImgCell = document.createElement('td');
                altImgCell.contentEditable = 'false';
                altImgCell.className = `ve-alt-image-${index}`;
                altImgCell.style.cssText = 'padding: 5px; border: 1px solid #ddd; text-align: center;';
                altImgCell.textContent = '-';
                row.appendChild(altImgCell);

                // Alternative description cell (merged brand + model + details)
                const altDescCell = document.createElement('td');
                altDescCell.contentEditable = 'true';
                altDescCell.className = `ve-alt-description-${index}`;
                altDescCell.textContent = '-';
                altDescCell.style.cssText = 'padding: 10px; border: 1px solid #ddd; min-width: 250px;';
                row.appendChild(altDescCell);

                // Alternative detail columns (rate, total, diff, savings)
                ['rate', 'total', 'diff', 'savings'].forEach(type => {
                    const cell = document.createElement('td');
                    cell.contentEditable = (type === 'rate' || type === 'total') ? 'true' : 'false';
                    cell.className = `ve-alt-${type}-${index}`;
                    cell.textContent = '-';
                    cell.style.cssText = 'padding: 10px; border: 1px solid #ddd; text-align: right;';
                    if (type === 'diff' || type === 'savings') {
                        cell.style.fontWeight = 'bold';
                    }
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            console.log('Table built, now appending to container');
            console.log('Container element:', container);
            console.log('Table element:', table);
            container.innerHTML = '';
            container.appendChild(table);

            console.log('Alternative table created and displayed');
            console.log('Container after append:', container.innerHTML.substring(0, 200));
        }

        // Update alternative data in row when model is selected
        function updateAlternativeDataInRow(row, altData, item) {
            const itemIndex = item.displayIndex !== undefined ? item.displayIndex : item.rowIndex;

            console.log('updateAlternativeDataInRow called:', {
                itemIndex,
                displayIndex: item.displayIndex,
                rowIndex: item.rowIndex,
                altData,
                itemQty: item.qty,
                itemTotal: item.total
            });

            // Update cells with alternative data
            const imgCell = row.querySelector(`.ve-alt-image-${itemIndex}`);
            const descCell = row.querySelector(`.ve-alt-description-${itemIndex}`);
            const rateCell = row.querySelector(`.ve-alt-rate-${itemIndex}`);
            const totalCell = row.querySelector(`.ve-alt-total-${itemIndex}`);
            const diffCell = row.querySelector(`.ve-alt-diff-${itemIndex}`);
            const savingsCell = row.querySelector(`.ve-alt-savings-${itemIndex}`);

            console.log('Cells found:', {
                imgCell: !!imgCell,
                descCell: !!descCell,
                rateCell: !!rateCell,
                totalCell: !!totalCell
            });

            // Create rich description with brand, model, and features
            if (descCell) {
                const brandName = altData.brand;
                const modelName = altData.model;
                const country = altData.country || '';
                const features = altData.features || [];

                // Build detailed description HTML
                let descHTML = `<div style="line-height: 1.6;">`;
                descHTML += `<strong style="color: #1a365d; font-size: 1.1em;">${brandName} ${modelName}</strong><br/>`;

                if (country) {
                    descHTML += `<span style="color: #666; font-size: 0.9em;">Origin: ${country}</span><br/>`;
                }

                if (features && features.length > 0) {
                    descHTML += `<div style="margin-top: 5px; color: #555; font-size: 0.85em;">`;
                    descHTML += features.slice(0, 3).join(' â€¢ ');
                    descHTML += `</div>`;
                }

                descHTML += `</div>`;
                descCell.innerHTML = descHTML;

                // Store brand and model as data attributes for later reference
                descCell.dataset.brand = brandName;
                descCell.dataset.model = modelName;
            }

            if (rateCell) rateCell.textContent = altData.unit_rate.toFixed(2);
            if (totalCell) totalCell.textContent = altData.total.toFixed(2);

            console.log('Cells updated with data:', {
                brand: altData.brand,
                model: altData.model,
                rate: altData.unit_rate.toFixed(2),
                total: altData.total.toFixed(2)
            });

            // Fetch and display product image
            if (imgCell && altData.brand !== 'Local') {
                imgCell.innerHTML = '<div style="color: #999; font-size: 0.8em;">Loading...</div>';
                fetchProductImage(altData.brand, altData.model, item.category)
                    .then(imageUrl => {
                        if (imageUrl) {
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.style.cssText = 'max-width: 80px; max-height: 80px; object-fit: contain;';
                            img.alt = altData.model;
                            img.onerror = () => {
                                imgCell.textContent = 'ðŸ“·';
                            };
                            imgCell.innerHTML = '';
                            imgCell.appendChild(img);
                        } else {
                            imgCell.textContent = 'ðŸ“·';
                        }
                    })
                    .catch(() => {
                        imgCell.textContent = 'ðŸ“·';
                    });
            } else if (imgCell) {
                imgCell.textContent = '-';
            }

            // Calculate difference
            const difference = item.total - altData.total;
            const savingsPercent = item.total > 0 ? (difference / item.total * 100) : 0;

            if (diffCell) {
                diffCell.textContent = difference.toFixed(2);
                diffCell.style.color = difference >= 0 ? '#10b981' : '#ef4444';
            }

            if (savingsCell) {
                savingsCell.textContent = savingsPercent.toFixed(1) + '%';
                savingsCell.style.color = difference >= 0 ? '#10b981' : '#ef4444';
            }
        }

        // Fetch product image from brand website or placeholder
        async function fetchProductImage(brand, model, category) {
            // This is a placeholder - in production, implement API calls to brand websites
            // For now, return placeholder or try to construct URL from brand website

            try {
                // Try to get website from brand data
                let website = null;
                if (category && allBrandsData[category]) {
                    const brandData = allBrandsData[category][brand];
                    if (brandData && brandData.website) {
                        website = brandData.website;
                    }
                }

                // For now, return a placeholder based on brand/model
                // In production, implement actual image scraping or API integration
                console.log(`Fetching image for ${brand} - ${model} from ${website}`);

                // Placeholder: Use a generic furniture icon or product placeholder
                // You can replace this with actual image URLs from your database
                return null; // Return null to show icon instead

            } catch (error) {
                console.error('Error fetching product image:', error);
                return null;
            }
        }

        // Clear alternative data in row
        function clearAlternativeDataInRow(row) {
            ['image', 'description', 'rate', 'total', 'diff', 'savings'].forEach(type => {
                const cells = row.querySelectorAll(`[class*="ve-alt-${type}-"]`);
                cells.forEach(cell => {
                    if (type === 'description') {
                        cell.innerHTML = '-';
                        delete cell.dataset.brand;
                        delete cell.dataset.model;
                    } else {
                        cell.textContent = '-';
                        cell.innerHTML = '-';
                    }
                    if (type === 'diff' || type === 'savings') {
                        cell.style.color = '';
                    }
                });
            });
        }

        // Helper function to get brands for a category
        function getCategoryBrands(category) {
            if (!allBrandsData || !allBrandsData[category]) {
                return [];
            }
            return Object.keys(allBrandsData[category]);
        }

        // Helper function to get models for a brand in a category
        function getBrandModels(category, brandName) {
            if (!allBrandsData || !allBrandsData[category] || !allBrandsData[category][brandName]) {
                return {};
            }
            return allBrandsData[category][brandName].models || {};
        }

        // Change budget tier and regenerate alternatives
        async function changeBudgetTier(tier) {
            console.log('Changing budget tier to:', tier);
            currentBudgetTier = tier;

            // Update button styles
            document.querySelectorAll('.tier-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#d4af37';
            });
            document.getElementById(`tier-${tier}`).style.background = '#d4af37';
            document.getElementById(`tier-${tier}`).style.color = '#1a365d';

            // Regenerate alternatives
            showAlert('Loading alternatives for ' + tier.replace('_', '-') + ' tier...', 'info');

            try {
                await fetchAlternativesForItems(tier);
                createAlternativeTable();
                showAlert('Alternatives updated successfully!', 'success');
            } catch (error) {
                showAlert('Error updating alternatives: ' + error.message, 'error');
            }
        }

        // Export alternative table
        function exportAlternativeTable(format) {
            showAlert(`Export to ${format} coming soon!`, 'info');
        }

        // Download alternative table
        function downloadAlternativeTable() {
            const table = document.querySelector('#altTableContainer table');
            if (!table) {
                showAlert('No table to download', 'error');
                return;
            }

            const html = table.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'alternative-offers-' + new Date().toISOString().slice(0, 10) + '.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Apply selected alternatives to the original table cells
        function applySelectedAlternatives() {
            let appliedCount = 0;
            let skippedCount = 0;

            console.log('applySelectedAlternatives called');

            // Get the original stitched table
            const originalTable = document.querySelector('table[border="1"]') ||
                document.querySelector('table');

            if (!originalTable) {
                showAlert('Original table not found', 'error');
                return;
            }

            // Get all rows from alternative table
            const altTable = document.querySelector('#altTableContainer table');
            if (!altTable) {
                showAlert('Alternative table not found', 'error');
                return;
            }

            const altRows = altTable.querySelectorAll('tbody tr');
            const originalRows = originalTable.querySelectorAll('tbody tr');

            console.log(`Processing ${altRows.length} alternative rows, ${originalRows.length} original rows`);

            // Process each row
            altRows.forEach((altRow, index) => {
                // Check if an alternative is selected for this row
                const altDescCell = altRow.querySelector(`.ve-alt-description-${index}`);
                const altRateCell = altRow.querySelector(`.ve-alt-rate-${index}`);
                const altImageCell = altRow.querySelector(`.ve-alt-image-${index}`);

                console.log(`Row ${index}:`, {
                    descCell: altDescCell,
                    descContent: altDescCell?.textContent,
                    descHTML: altDescCell?.innerHTML,
                    brand: altDescCell?.dataset?.brand,
                    model: altDescCell?.dataset?.model,
                    rateCell: altRateCell,
                    rate: altRateCell?.textContent
                });

                // Check if alternative data exists (not just '-')
                if (!altDescCell ||
                    altDescCell.textContent.trim() === '-' ||
                    altDescCell.textContent.trim() === '' ||
                    !altDescCell.dataset.brand) {
                    console.log(`Row ${index}: Skipping - no alternative selected`);
                    skippedCount++;
                    return; // Skip this row - no alternative selected
                }

                const brand = altDescCell.dataset.brand;
                const model = altDescCell.dataset.model;

                console.log(`Row ${index}: Has alternative - Brand: ${brand}, Model: ${model}`);

                // Find corresponding row in original table (accounting for potential header row)
                const originalRowIndex = index < originalRows.length ? index : index - 1;
                const originalRow = originalRows[originalRowIndex];

                if (!originalRow) {
                    console.log(`Row ${index}: Original row not found at index ${originalRowIndex}`);
                    skippedCount++;
                    return;
                }

                // Get the cells from original row
                const originalCells = originalRow.querySelectorAll('td');

                // Find the description, rate, and total columns (typically columns 1, 4, 5)
                // Assuming structure: SI.No | Image | Description | Qty | Unit | Rate | Total
                if (originalCells.length >= 6) {
                    // Update image (column 1)
                    const imgCell = originalCells[1];
                    const altImage = altImageCell.querySelector('img');
                    if (altImage) {
                        imgCell.innerHTML = '';
                        const newImg = document.createElement('img');
                        newImg.src = altImage.src;
                        newImg.style.cssText = 'max-width: 80px; max-height: 80px; object-fit: contain;';
                        newImg.alt = altModelCell.textContent;
                        imgCell.appendChild(newImg);
                    }

                    // Update description with brand and model (column 2)
                    const descCell = originalCells[2];
                    const originalDesc = descCell.textContent;
                    descCell.innerHTML = `<strong style="color: #d4af37;">${brand} - ${model}</strong><br/><span style="font-size: 0.9em; color: #666;">${originalDesc}</span>`;

                    // Update rate (column 5)
                    const rateCell = originalCells[5];
                    rateCell.textContent = altRateCell.textContent;
                    rateCell.style.background = '#e8f5e9';
                    rateCell.style.fontWeight = 'bold';

                    // Update total (column 6) - multiply rate by qty
                    const qtyCell = originalCells[3];
                    const qty = parseFloat(qtyCell.textContent) || 1;
                    const rate = parseFloat(altRateCell.textContent) || 0;
                    const totalCell = originalCells[6];
                    totalCell.textContent = (qty * rate).toFixed(2);
                    totalCell.style.background = '#e8f5e9';
                    totalCell.style.fontWeight = 'bold';

                    appliedCount++;
                }
            });

            // Update the total at bottom of original table if it exists
            updateOriginalTableTotal(originalTable);

            // Show summary
            if (appliedCount > 0) {
                showAlert(`Applied ${appliedCount} alternative${appliedCount > 1 ? 's' : ''} to original table! ${skippedCount > 0 ? `(${skippedCount} skipped - no alternative selected)` : ''}`, 'success');
            } else {
                showAlert('No alternatives were selected to apply. Please select alternatives from the dropdowns first.', 'warning');
            }
        }

        // Update total row in original table
        function updateOriginalTableTotal(table) {
            const rows = table.querySelectorAll('tbody tr');
            let grandTotal = 0;

            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                // Check if this is a data row (has enough cells and a total column)
                if (cells.length >= 7) {
                    const totalCell = cells[6];
                    const total = parseFloat(totalCell.textContent) || 0;
                    grandTotal += total;
                }
            });

            // Look for a total row and update it
            const lastRow = rows[rows.length - 1];
            if (lastRow) {
                const cells = lastRow.querySelectorAll('td');
                // Check if last row is a total row (contains "total" text)
                const firstCellText = cells[0]?.textContent.toLowerCase() || '';
                if (firstCellText.includes('total')) {
                    // Update the last cell with new grand total
                    const lastCell = cells[cells.length - 1];
                    if (lastCell) {
                        lastCell.textContent = grandTotal.toFixed(2);
                        lastCell.style.background = '#fef3c7';
                        lastCell.style.fontWeight = 'bold';
                        lastCell.style.fontSize = '1.1em';
                    }
                }
            }
        }

        // Parse stitched table from DOM to extract items
        function parseStitchedTableToItems(tableElement) {
            const items = [];
            const rows = tableElement.querySelectorAll('tbody tr');
            const headers = [];

            console.log('parseStitchedTableToItems: Found', rows.length, 'rows');

            // Get headers - first try thead, then first tbody row
            let headerCells = tableElement.querySelectorAll('thead th');

            if (headerCells.length === 0) {
                console.log('No thead headers, checking first tbody row for headers...');
                // If no thead, check if first row contains headers
                const firstRow = tableElement.querySelector('tbody tr');
                if (firstRow) {
                    headerCells = firstRow.querySelectorAll('td');
                    console.log('Found', headerCells.length, 'cells in first row');
                }
            }

            headerCells.forEach(cell => {
                headers.push(cell.textContent.trim().toLowerCase());
            });

            console.log('Table headers:', headers);

            if (headers.length === 0) {
                console.error('No headers found in table');
                return items;
            }

            // Determine starting row index (skip first row if it was used as header)
            const startIndex = tableElement.querySelector('thead') ? 0 : 1;
            console.log('Starting from row index:', startIndex);

            rows.forEach((row, index) => {
                if (index < startIndex) {
                    console.log(`Skipping row ${index} (header row)`);
                    return;
                }

                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                const rowData = {};
                let imageUrl = null;

                cells.forEach((cell, i) => {
                    if (i < headers.length) {
                        rowData[headers[i]] = cell.textContent.trim();

                        // Check if this cell contains an image
                        const img = cell.querySelector('img');
                        if (img && img.src) {
                            imageUrl = img.src;
                        }
                    }
                });

                console.log(`Row ${index} data:`, rowData);
                if (imageUrl) console.log(`Row ${index} image:`, imageUrl);

                // Extract item information
                const description = getValueFromRowData(rowData, ['description', 'item', 'item description', 'particulars']);
                const qty = getValueFromRowData(rowData, ['qty', 'quantity', 'qnty']);
                const unit = getValueFromRowData(rowData, ['unit', 'uom']);
                const unitRate = getValueFromRowData(rowData, ['unit rate', 'rate', 'unit price', 'price']);
                const total = getValueFromRowData(rowData, ['total', 'amount', 'total amount']);

                console.log(`Row ${index} extracted - Desc: ${description}, Qty: ${qty}, Rate: ${unitRate}`);

                // Skip if no description or looks like header
                if (!description || description.length < 5) {
                    console.log(`Skipping row ${index}: no description or too short`);
                    return;
                }
                if (description.toLowerCase().includes('description') || description.toLowerCase().includes('item')) {
                    console.log(`Skipping row ${index}: looks like header`);
                    return;
                }

                // Don't categorize automatically - let user choose
                const item = {
                    rowIndex: index,
                    description: description,
                    qty: parseNumber(qty),
                    unit: unit,
                    unit_rate: parseNumber(unitRate),
                    total: parseNumber(total),
                    imageUrl: imageUrl,
                    category: null,
                    subcategory: null,
                    selectedBrand: null,
                    selectedModel: null
                };

                // Only add items with meaningful data
                if (item.qty > 0 || item.unit_rate > 0) {
                    items.push(item);
                    console.log(`Added item ${items.length}:`, item.description.substring(0, 50));
                } else {
                    console.log(`Skipping row ${index}: no qty or rate`);
                }
            });

            console.log(`Total items extracted: ${items.length}`);
            return items;
        }

        // Helper function to get value from row data
        function getValueFromRowData(rowData, possibleKeys) {
            for (const key of possibleKeys) {
                for (const rowKey in rowData) {
                    if (rowKey.toLowerCase().includes(key)) {
                        return rowData[rowKey];
                    }
                }
            }
            return '';
        }

        // Helper function to parse numbers
        function parseNumber(value) {
            if (typeof value === 'number') return value;
            const cleaned = String(value).replace(/[^\d.-]/g, '');
            return cleaned ? parseFloat(cleaned) : 0;
        }

        // Categorize item based on description
        function categorizeItem(description) {
            const descLower = description.toLowerCase();

            // Seating keywords
            if (descLower.includes('chair') || descLower.includes('seat') || descLower.includes('sofa') ||
                descLower.includes('stool') || descLower.includes('bench') || descLower.includes('lounge')) {

                if (descLower.includes('executive') || descLower.includes('director') || descLower.includes('manager')) {
                    return { category: 'seating', subcategory: 'executive_chairs' };
                } else if (descLower.includes('task') || descLower.includes('office') || descLower.includes('work')) {
                    return { category: 'seating', subcategory: 'task_chairs' };
                } else if (descLower.includes('visitor') || descLower.includes('guest')) {
                    return { category: 'seating', subcategory: 'visitor_chairs' };
                } else if (descLower.includes('conference') || descLower.includes('meeting')) {
                    return { category: 'seating', subcategory: 'conference_chairs' };
                } else if (descLower.includes('sofa') || descLower.includes('couch')) {
                    return { category: 'seating', subcategory: 'sofas' };
                } else {
                    return { category: 'seating', subcategory: 'task_chairs' };
                }
            }

            // Desking keywords
            if (descLower.includes('desk') || descLower.includes('table') || descLower.includes('workstation') ||
                descLower.includes('cabinet') || descLower.includes('pedestal') || descLower.includes('locker')) {

                if (descLower.includes('executive') || descLower.includes('director') || descLower.includes('manager')) {
                    return { category: 'desking', subcategory: 'executive_desks' };
                } else if (descLower.includes('workstation') || descLower.includes('work desk')) {
                    return { category: 'desking', subcategory: 'workstations' };
                } else if (descLower.includes('meeting') || descLower.includes('conference')) {
                    return { category: 'desking', subcategory: 'meeting_tables' };
                } else if (descLower.includes('cabinet')) {
                    return { category: 'desking', subcategory: 'cabinets' };
                } else if (descLower.includes('pedestal')) {
                    return { category: 'desking', subcategory: 'pedestals' };
                } else {
                    return { category: 'desking', subcategory: 'workstations' };
                }
            }

            return { category: 'general', subcategory: 'general' };
        }

        // Store all available brands and models globally
        let allBrandsData = {};

        // Load categories dynamically for a dropdown
        async function loadCategoriesForDropdown(categorySelect, tier) {
            try {
                const response = await fetch(`/api/brands/categories?tier=${tier}`);
                const data = await response.json();

                if (data.success && data.categories && data.categories.length > 0) {
                    // Add categories as options
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categorySelect.appendChild(option);
                    });
                } else {
                    // Fallback: add "General" if no categories found
                    const option = document.createElement('option');
                    option.value = 'general';
                    option.textContent = 'General';
                    categorySelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                // Fallback: add "General"
                const option = document.createElement('option');
                option.value = 'general';
                option.textContent = 'General';
                categorySelect.appendChild(option);
            }
        }

        // Fetch all brands and models from backend for user selection
        async function fetchAlternativesForItems(budgetTier) {
            try {
                // Fetch all available categories dynamically
                allBrandsData = {};

                // First, get all categories for this tier
                const categoriesResponse = await fetch(`/api/brands/categories?tier=${budgetTier}`);
                const categoriesData = await categoriesResponse.json();

                let categories = [];
                if (categoriesData.success && categoriesData.categories && categoriesData.categories.length > 0) {
                    categories = categoriesData.categories;
                } else {
                    // Fallback to empty array if no categories
                    console.warn('No categories found for tier:', budgetTier);
                }

                let totalSteps = Math.max(categories.length, 1);
                let completedSteps = 0;
                const baseProgress = 30; // Starting from 30%
                const progressRange = 50; // Will go from 30% to 80%

                for (const category of categories) {
                    updateProgress(`Loading ${category} brands...`, baseProgress + (completedSteps / totalSteps) * progressRange);

                    // Fetch brands for this category (no category filter - get all brands for tier)
                    const response = await fetch(`/api/brands/list?tier=${budgetTier}`);
                    const data = await response.json();

                    if (data.success && data.brands) {
                        if (!allBrandsData[category]) {
                            allBrandsData[category] = {};
                        }

                        // Filter brands that have this category
                        const brandsInCategory = data.brands.filter(brand =>
                            brand.categories && brand.categories.includes(category)
                        );

                        const totalBrands = brandsInCategory.length;
                        let processedBrands = 0;

                        // Fetch models for each brand in this category
                        for (const brand of brandsInCategory) {
                            allBrandsData[category][brand.name] = {
                                country: brand.country,
                                website: brand.website,
                                models: {}
                            };

                            // Get subcategories for this category and brand
                            const subcatResponse = await fetch(`/api/brands/subcategories?tier=${budgetTier}&brand=${encodeURIComponent(brand.name)}&category=${encodeURIComponent(category)}`);
                            const subcatData = await subcatResponse.json();

                            if (subcatData.success && subcatData.subcategories && subcatData.subcategories.length > 0) {
                                for (const subcat of subcatData.subcategories) {
                                    const modelsResponse = await fetch(`/api/brands/models?tier=${budgetTier}&category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brand.name)}&subcategory=${encodeURIComponent(subcat)}`);
                                    const modelsData = await modelsResponse.json();

                                    if (modelsData.success && modelsData.models && modelsData.models.length > 0) {
                                        allBrandsData[category][brand.name].models[subcat] = modelsData.models;
                                    }
                                }
                            } else {
                                // If no subcategories, fetch models directly for this category
                                const modelsResponse = await fetch(`/api/brands/models?tier=${budgetTier}&category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brand.name)}`);
                                const modelsData = await modelsResponse.json();

                                if (modelsData.success && modelsData.models && modelsData.models.length > 0) {
                                    allBrandsData[category][brand.name].models['general'] = modelsData.models;
                                }
                            }

                            processedBrands++;
                            const categoryProgress = (processedBrands / totalBrands) * (progressRange / totalSteps);
                            updateProgress(`Loading ${category} brands (${processedBrands}/${totalBrands})...`,
                                baseProgress + (completedSteps / totalSteps) * progressRange + categoryProgress);
                        }
                    }

                    completedSteps++;
                }

                console.log('All brands data loaded:', allBrandsData);
            } catch (error) {
                console.error('Error fetching brands data:', error);
                hideProgressModal();
                throw error;
            }
        }

        // Estimate lead time
        function estimateLeadTime(tier, country) {
            const leadTimes = {
                'budgetary': '2-3 weeks',
                'mid_range': '4-6 weeks',
                'high_end': '6-10 weeks'
            };

            if (['China', 'Taiwan', 'Malaysia'].includes(country)) {
                return leadTimes[tier] || '4-6 weeks';
            } else if (country === 'Turkey') {
                return tier === 'budgetary' ? '3-5 weeks' : '5-7 weeks';
            } else {
                return leadTimes[tier] || '6-8 weeks';
            }
        }

        // Select Budget Tier
        function selectBudgetTier(tier) {
            currentBudgetTier = tier;

            // Update tab UI
            document.querySelectorAll('.ve-tier-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tier === tier) {
                    tab.classList.add('active');
                }
            });

            // Reload data
            if (currentVEFileId) {
                loadValueEngineeringData(currentVEFileId);
            }
        }

        // Render VE Items
        function renderVEItems() {
            const stitchedTable = document.querySelector('table[border="1"]') ||
                document.querySelector('table') ||
                document.querySelector('.editable-table');

            if (!stitchedTable) {
                showAlert('Stitched table not found', 'error');
                return;
            }

            // Get or create thead
            let thead = stitchedTable.querySelector('thead');
            if (!thead) {
                thead = document.createElement('thead');
                stitchedTable.insertBefore(thead, stitchedTable.firstChild);
            }

            // Get the header row
            let headerRow = thead.querySelector('tr');
            if (!headerRow) {
                headerRow = document.createElement('tr');
                thead.appendChild(headerRow);
            }

            // Check if alternative columns already exist
            const existingAltHeader = Array.from(headerRow.querySelectorAll('th')).find(th =>
                th.textContent.trim() === 'Alternative Selection'
            );

            if (!existingAltHeader) {
                // Add new column headers for alternatives
                const alternativeHeaders = [
                    'Alternative Selection',
                    'Alt. Brand',
                    'Alt. Model',
                    'Alt. Unit Rate (AED)',
                    'Alt. Total (AED)',
                    'Difference (AED)',
                    '% Savings'
                ];

                alternativeHeaders.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    th.style.cssText = 'background: #d4af37; color: #1a365d; font-weight: bold; padding: 12px; border: 1px solid #b8942f; white-space: nowrap;';
                    headerRow.appendChild(th);
                });
            }

            // Get tbody
            const tbody = stitchedTable.querySelector('tbody');
            if (!tbody) {
                showAlert('Table body not found', 'error');
                console.error('No tbody found in table');
                return;
            }

            console.log('Processing table with', tbody.querySelectorAll('tr').length, 'rows');
            console.log('veItems count:', veItems.length);

            // Process each row that has matching veItems
            const rows = tbody.querySelectorAll('tr');
            let veItemIndex = 0;
            let rowsProcessed = 0;

            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                // Check if this row corresponds to a veItem
                if (veItemIndex >= veItems.length) return;

                const item = veItems[veItemIndex];

                console.log(`Row ${rowIndex}: ${cells.length} cells, veItem ${veItemIndex}:`, item.description.substring(0, 50));

                // Check if row already has alternative columns
                const existingAltCell = Array.from(cells).find((cell, idx) =>
                    idx >= cells.length - 7
                );

                if (cells.length < headerRow.querySelectorAll('th').length) {
                    // Add alternative columns to this row

                    // Alternative Selection Dropdown
                    const selectCell = document.createElement('td');
                    selectCell.contentEditable = 'false';
                    selectCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; background: white;';

                    if (item.alternatives && item.alternatives.length > 0) {
                        const select = document.createElement('select');
                        select.className = 've-alternative-select';
                        select.style.cssText = 'width: 100%; padding: 6px; border: 1px solid #d4af37; border-radius: 4px; background: white; color: #1a365d;';
                        select.dataset.itemIndex = veItemIndex;

                        // Default option
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Select alternative...';
                        select.appendChild(defaultOption);

                        // Add alternatives
                        item.alternatives.forEach((alt, altIndex) => {
                            const option = document.createElement('option');
                            option.value = altIndex;
                            option.textContent = `${alt.brand} - ${alt.model} (${alt.price_range} AED)`;
                            select.appendChild(option);
                        });

                        select.addEventListener('change', (e) => {
                            const itemIdx = parseInt(e.target.dataset.itemIndex);
                            const altIdx = parseInt(e.target.value);
                            updateAlternativeSelection(itemIdx, altIdx, row);
                        });

                        selectCell.appendChild(select);
                    } else {
                        selectCell.textContent = 'No alternatives';
                        selectCell.style.color = '#999';
                        selectCell.style.fontStyle = 'italic';
                    }

                    row.appendChild(selectCell);

                    // Brand Cell
                    const brandCell = document.createElement('td');
                    brandCell.contentEditable = 'true';
                    brandCell.className = 've-brand-cell';
                    brandCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; background: white;';
                    brandCell.textContent = '-';
                    row.appendChild(brandCell);

                    // Model Cell
                    const modelCell = document.createElement('td');
                    modelCell.contentEditable = 'true';
                    modelCell.className = 've-model-cell';
                    modelCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; background: white;';
                    modelCell.textContent = '-';
                    row.appendChild(modelCell);

                    // Alternative Unit Rate Cell
                    const altRateCell = document.createElement('td');
                    altRateCell.contentEditable = 'true';
                    altRateCell.className = 've-rate-cell';
                    altRateCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; text-align: right; background: white;';
                    altRateCell.textContent = '0.00';
                    row.appendChild(altRateCell);

                    // Alternative Total Cell
                    const altTotalCell = document.createElement('td');
                    altTotalCell.contentEditable = 'true';
                    altTotalCell.className = 've-total-cell';
                    altTotalCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; text-align: right; background: white;';
                    altTotalCell.textContent = '0.00';
                    row.appendChild(altTotalCell);

                    // Difference Cell
                    const diffCell = document.createElement('td');
                    diffCell.contentEditable = 'false';
                    diffCell.className = 've-diff-cell';
                    diffCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; background: white;';
                    diffCell.textContent = '0.00';
                    row.appendChild(diffCell);

                    // Savings Percentage Cell
                    const savingsCell = document.createElement('td');
                    savingsCell.contentEditable = 'false';
                    savingsCell.className = 've-savings-cell';
                    savingsCell.style.cssText = 'padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold; background: white;';
                    savingsCell.textContent = '0%';
                    row.appendChild(savingsCell);
                    rowsProcessed++;
                }

                veItemIndex++;
            });

            console.log(`Finished: Processed ${rowsProcessed} rows, ${veItemIndex} items`);

            // Add event listeners for manual edits
            addVECellEditListeners();

            // Force table to reflow/repaint
            stitchedTable.style.display = 'none';
            stitchedTable.offsetHeight; // Trigger reflow
            stitchedTable.style.display = '';

            console.log('Table updated and refreshed');
        }

        // Add listeners for manual edits in VE cells
        function addVECellEditListeners() {
            const table = document.querySelector('table[border="1"]') ||
                document.querySelector('table') ||
                document.querySelector('.editable-table');

            if (!table) return;

            // Listen for changes in rate and total cells
            table.addEventListener('input', (e) => {
                const target = e.target;
                if (target.classList.contains('ve-rate-cell') || target.classList.contains('ve-total-cell')) {
                    const row = target.closest('tr');
                    recalculateDifference(row);
                }
            });
        }

        // Update alternative selection in row
        function updateAlternativeSelection(itemIndex, altIndex, row) {
            const item = veItems[itemIndex];
            if (!item || !item.alternatives || altIndex < 0 || altIndex >= item.alternatives.length) {
                return;
            }

            const alternative = item.alternatives[altIndex];

            // Update cells
            const brandCell = row.querySelector('.ve-brand-cell');
            const modelCell = row.querySelector('.ve-model-cell');
            const rateCell = row.querySelector('.ve-rate-cell');
            const totalCell = row.querySelector('.ve-total-cell');

            if (brandCell) brandCell.textContent = alternative.brand;
            if (modelCell) modelCell.textContent = alternative.model;
            if (rateCell) rateCell.textContent = alternative.unit_rate.toFixed(2);
            if (totalCell) totalCell.textContent = alternative.total.toFixed(2);

            // Recalculate difference
            recalculateDifference(row);

            // Store selection
            veSelections[itemIndex] = {
                alternative: alternative,
                altIndex: altIndex
            };

            updateVESummary();
        }

        // Recalculate difference for a row
        function recalculateDifference(row) {
            const cells = row.querySelectorAll('td');
            if (cells.length === 0) return;

            // Find original total (look for total column in original columns)
            let originalTotal = 0;
            const table = document.querySelector('table[border="1"]') ||
                document.querySelector('table') ||
                document.querySelector('.editable-table');

            const headerCells = table ? table.querySelectorAll('thead th') : [];
            const headers = Array.from(headerCells).map(th => th.textContent.trim().toLowerCase());

            const totalIndex = headers.findIndex(h => h.includes('total') || h.includes('amount'));
            if (totalIndex >= 0 && totalIndex < cells.length) {
                originalTotal = parseNumber(cells[totalIndex].textContent);
            }

            // Get alternative total
            const altTotalCell = row.querySelector('.ve-total-cell');
            const altTotal = altTotalCell ? parseNumber(altTotalCell.textContent) : 0;

            // Calculate difference and savings
            const difference = originalTotal - altTotal;
            const savingsPercent = originalTotal > 0 ? (difference / originalTotal * 100) : 0;

            // Update cells
            const diffCell = row.querySelector('.ve-diff-cell');
            const savingsCell = row.querySelector('.ve-savings-cell');

            if (diffCell) {
                diffCell.textContent = difference.toFixed(2);
                if (difference > 0) {
                    diffCell.style.color = '#10b981'; // Green for savings
                } else if (difference < 0) {
                    diffCell.style.color = '#ef4444'; // Red for increase
                } else {
                    diffCell.style.color = '#6b7280'; // Gray for no change
                }
            }

            if (savingsCell) {
                savingsCell.textContent = savingsPercent.toFixed(1) + '%';
                if (savingsPercent > 0) {
                    savingsCell.style.color = '#10b981';
                } else if (savingsPercent < 0) {
                    savingsCell.style.color = '#ef4444';
                } else {
                    savingsCell.style.color = '#6b7280';
                }
            }

            updateVESummary();
        }

        // Update VE Summary
        function updateVESummary() {
            let originalTotal = 0;
            let newTotal = 0;
            let selectedCount = 0;

            veItems.forEach((item, index) => {
                originalTotal += item.total || 0;

                if (veSelections[index]) {
                    newTotal += veSelections[index].alternative.total;
                    selectedCount++;
                } else {
                    newTotal += item.total || 0;
                }
            });

            const totalSavings = originalTotal - newTotal;
            const percentageSavings = originalTotal > 0 ? (totalSavings / originalTotal * 100) : 0;

            // Update summary display
            document.getElementById('veSummaryItems').textContent = veItems.length;
            document.getElementById('veSummarySelected').textContent = selectedCount;
            document.getElementById('veSummaryOriginal').textContent = originalTotal.toFixed(2) + ' AED';
            document.getElementById('veSummaryNew').textContent = newTotal.toFixed(2) + ' AED';
            document.getElementById('veSummarySavings').textContent = totalSavings.toFixed(2) + ' AED (' + percentageSavings.toFixed(1) + '%)';

            const savingsElement = document.getElementById('veSummarySavings');
            if (totalSavings > 0) {
                savingsElement.style.color = '#10b981';
            } else if (totalSavings < 0) {
                savingsElement.style.color = '#ef4444';
            } else {
                savingsElement.style.color = '#6b7280';
            }
        }

        // Export Alternative Quote
        async function exportAlternativeQuote() {
            if (Object.keys(veSelections).length === 0) {
                showAlert('Please select at least one alternative', 'warning');
                return;
            }

            showAlert('Export functionality coming soon!', 'info');
        }

        // Initialize costing sliders on page load
        function initializeCostingSliders() {
            const sliders = {
                netMargin: document.getElementById('netMarginSlider'),
                freight: document.getElementById('freightSlider'),
                customs: document.getElementById('customsSlider'),
                installation: document.getElementById('installationSlider'),
                exchangeRate: document.getElementById('exchangeRateSlider'),
                additional: document.getElementById('additionalSlider')
            };

            if (!sliders.netMargin) {
                console.log('Sliders not found yet');
                return; // Sliders not loaded yet
            }

            // Set initial values
            document.getElementById('netMarginValue').textContent = sliders.netMargin.value + '%';
            document.getElementById('freightValue').textContent = sliders.freight.value + '%';
            document.getElementById('customsValue').textContent = sliders.customs.value + '%';
            document.getElementById('installationValue').textContent = sliders.installation.value + '%';
            document.getElementById('exchangeRateValue').textContent = parseFloat(sliders.exchangeRate.value).toFixed(2);
            document.getElementById('additionalValue').textContent = sliders.additional.value + '%';

            // Add event listeners
            sliders.netMargin.addEventListener('input', (e) => {
                document.getElementById('netMarginValue').textContent = e.target.value + '%';
            });

            sliders.freight.addEventListener('input', (e) => {
                document.getElementById('freightValue').textContent = e.target.value + '%';
            });

            sliders.customs.addEventListener('input', (e) => {
                document.getElementById('customsValue').textContent = e.target.value + '%';
            });

            sliders.installation.addEventListener('input', (e) => {
                document.getElementById('installationValue').textContent = e.target.value + '%';
            });

            sliders.exchangeRate.addEventListener('input', (e) => {
                document.getElementById('exchangeRateValue').textContent = parseFloat(e.target.value).toFixed(2);
            });

            sliders.additional.addEventListener('input', (e) => {
                document.getElementById('additionalValue').textContent = e.target.value + '%';
            });

            console.log('Costing sliders initialized successfully');
        }

        // Initialize sliders when DOM is ready and when costing card is shown
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing sliders...');
            setTimeout(initializeCostingSliders, 100);
            setTimeout(initializeCostingSliders, 500);
            setTimeout(initializeCostingSliders, 1000);

            // Check URL params to determine what to show
            const urlParams = new URLSearchParams(window.location.search);
            const showHero = urlParams.get('showHero') === 'true';

            const heroSection = document.getElementById('heroSection');
            const mainAppContainer = document.getElementById('mainAppContainer');
            const cardsContainer = document.getElementById('cardsContainer');

            // Only show hero section if coming from landing page with showHero=true
            if (showHero && heroSection) {
                heroSection.style.display = 'flex';
                heroSection.style.opacity = '1';
                heroSection.style.transform = 'translateY(0)';
            } else if (heroSection) {
                // Hide hero section by default
                heroSection.style.display = 'none';
            }

            // Ensure main app sections are hidden on load (unless workflow is triggered)
            if (mainAppContainer && !sessionStorage.getItem('workflowType')) {
                mainAppContainer.style.display = 'none';
            }
            if (cardsContainer) {
                cardsContainer.style.display = 'none';
            }

            // Initialize Hero Image Carousel
            function initHeroImageCarousel() {
                const carousels = document.querySelectorAll('.hero-image-carousel');
                if (carousels.length === 0) return;

                carousels.forEach(carousel => {
                    const slides = carousel.querySelectorAll('.hero-image-slide');
                    if (slides.length === 0) return;

                    let currentSlide = 0;
                    const totalSlides = slides.length;

                    function showSlide(index) {
                        slides.forEach((slide, i) => {
                            slide.classList.remove('active');
                            if (i === index) {
                                slide.classList.add('active');
                            }
                        });
                    }

                    function nextSlide() {
                        currentSlide = (currentSlide + 1) % totalSlides;
                        showSlide(currentSlide);
                    }

                    // Start carousel - change image every 5 seconds
                    showSlide(0);
                    setInterval(nextSlide, 5000);
                });
            }

            // Initialize carousel when hero section is visible
            if (heroSection && heroSection.style.display !== 'none') {
                initHeroImageCarousel();
            }

            // Trigger cleanup of old sessions on page load
            fetch('/api/cleanup-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
                .then(data => {
                    if (data.success && data.cleaned && (data.cleaned.uploads > 0 || data.cleaned.outputs > 0)) {
                        console.log('Cleaned old sessions:', data.cleaned);
                    }
                })
                .catch(err => console.error('Cleanup error:', err));

            // Handle navigation bar scroll effect
            let lastScrollTop = 0;
            const navBar = document.querySelector('.app-nav-bar');

            window.addEventListener('scroll', () => {
                if (!navBar) return;

                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;

                // Calculate scroll percentage (0 to 1)
                const scrollPercent = Math.min(scrollTop / docHeight, 1);

                // Add 'scrolled' class when scrolled down more than 100px
                if (scrollTop > 100) {
                    navBar.classList.add('scrolled');

                    // Gradually fade out as we scroll - from 0.7 at start to 0.05 at bottom
                    const opacity = Math.max(0.7 - (scrollPercent * 0.65), 0.05);
                    navBar.style.opacity = opacity;
                } else {
                    navBar.classList.remove('scrolled');
                    navBar.style.opacity = '1';
                }

                lastScrollTop = scrollTop;
            });

            // Cleanup on page unload (when user navigates away or closes tab)
            window.addEventListener('beforeunload', () => {
                // Use sendBeacon for reliable cleanup even when page is closing
                const blob = new Blob([JSON.stringify({})], { type: 'application/json' });
                navigator.sendBeacon('/api/cleanup-session', blob);
            });

            // Also cleanup on visibility change (when user switches tabs)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Optionally cleanup when user switches away
                    // Uncomment if you want to cleanup on tab switch
                    // fetch('/api/cleanup-session', { method: 'POST' }).catch(() => {});
                }
            });
        });
    </script>

    <!-- Progress Modal for Alternative Generation -->
    <div id="progressModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div
            style="background: linear-gradient(135deg, #1a365d 0%, #2d5a8f 100%); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 500px; width: 90%; border: 2px solid #d4af37;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 3em; margin-bottom: 15px;">ðŸ’¡</div>
                <h2 id="progressTitle" style="color: #d4af37; margin: 0; font-size: 1.5em;">Generating Alternatives</h2>
            </div>

            <div style="margin-bottom: 25px;">
                <div
                    style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 30px; overflow: hidden; border: 1px solid #d4af37;">
                    <div id="progressBar"
                        style="background: linear-gradient(90deg, #d4af37 0%, #f4d47d 100%); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;">
                        <span id="progressPercent" style="color: #1a365d; font-weight: bold; font-size: 0.9em;"></span>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <div id="progressMessage"
                    style="color: #ffffff; font-size: 1em; margin-bottom: 15px; min-height: 24px;">Initializing...</div>
                <div class="spinner"
                    style="margin: 20px auto; width: 50px; height: 50px; border: 4px solid rgba(212, 175, 55, 0.3); border-top: 4px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite;">
                </div>
            </div>
        </div>

        <!-- Footer with Home Button -->
        <div class="main-app-footer" style="text-align: center; padding: 40px 20px; margin-top: 60px;">
            <button class="nav-home-btn" onclick="goToLandingPage()"
                style="background: #3b82f6; color: white; font-size: 1.1em; padding: 14px 32px;">
                ðŸ  Home
            </button>
        </div>
    </div>

    <!-- Add Brand Modal -->
    <div id="addBrandModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div
            style="background: linear-gradient(135deg, #1a365d 0%, #2d5a8e 100%); padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 3px solid #d4af37;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #d4af37; margin: 0; font-size: 2em;">âž• Add New Brand</h2>
                <button onclick="closeAddBrandModal()"
                    style="background: transparent; border: none; color: #d4af37; font-size: 2em; cursor: pointer; line-height: 1; padding: 0; width: 40px; height: 40px;">&times;</button>
            </div>

            <div style="margin-bottom: 30px;">
                <p style="color: white; font-size: 1.1em; margin-bottom: 20px;">Enter a brand's website URL and we'll
                    automatically scrape and add their products to the database.</p>

                <form id="addBrandForm" onsubmit="handleAddBrand(event)">
                    <!-- Brand Name -->
                    <div style="margin-bottom: 20px;">
                        <label style="color: #d4af37; font-weight: bold; display: block; margin-bottom: 8px;">Brand Name
                            *</label>
                        <input type="text" id="brandName" required placeholder="e.g., Herman Miller"
                            style="width: 100%; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 1em; background: rgba(255,255,255,0.95);">
                    </div>

                    <!-- Website URL -->
                    <div style="margin-bottom: 20px;">
                        <label style="color: #d4af37; font-weight: bold; display: block; margin-bottom: 8px;">Website
                            URL *</label>
                        <input type="url" id="brandWebsite" required placeholder="https://www.example.com"
                            style="width: 100%; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 1em; background: rgba(255,255,255,0.95);">
                        <small style="color: #ddd; display: block; margin-top: 5px;">Enter the main website URL</small>
                    </div>

                    <!-- Country -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="color: #d4af37; font-weight: bold; display: block; margin-bottom: 8px;">Country</label>
                        <input type="text" id="brandCountry" placeholder="e.g., USA"
                            style="width: 100%; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 1em; background: rgba(255,255,255,0.95);">
                    </div>

                    <!-- Budget Tier -->
                    <div style="margin-bottom: 20px;">
                        <label style="color: #d4af37; font-weight: bold; display: block; margin-bottom: 8px;">Budget
                            Tier *</label>
                        <select id="brandTier" required
                            style="width: 100%; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 1em; background: rgba(255,255,255,0.95);">
                            <option value="budgetary">ðŸ’° Budgetary</option>
                            <option value="mid_range" selected>â­ Mid-Range</option>
                            <option value="high_end">ðŸ‘‘ High-End</option>
                        </select>
                    </div>

                    <!-- Scraping Method -->
                    <div style="margin-bottom: 20px;">
                        <label style="color: #d4af37; font-weight: bold; display: block; margin-bottom: 8px;">Scraping
                            Method *</label>
                        <select id="scrapingMethod" required onchange="toggleFirecrawlOptions()"
                            style="width: 100%; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 1em; background: rgba(255,255,255,0.95);">
                            <option value="requests">ðŸš€ Requests Scraper (Recommended - No API Limits)</option>
                            <option value="firecrawl">ðŸ”¥ Firecrawl API (AI-Powered - Has API Limits)</option>
                            <option value="universal">âš¡ Universal Scraper (Legacy)</option>
                        </select>
                        <small style="color: #ddd; display: block; margin-top: 5px;">Universal is faster but may miss
                            some products. Firecrawl is more thorough.</small>
                    </div>

                    <!-- Firecrawl Options (shown only when Firecrawl is selected) -->
                    <div id="firecrawlOptions" style="margin-bottom: 20px; display: none;">
                        <label style="color: #d4af37; font-weight: bold; display: block; margin-bottom: 8px;">Max Pages
                            to Crawl</label>
                        <input type="number" id="crawlLimit" value="50" min="1" max="200"
                            style="width: 100%; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 1em; background: rgba(255,255,255,0.95);">
                        <small style="color: #ddd; display: block; margin-top: 5px;">Limit the number of pages to crawl
                            (default: 50)</small>
                    </div>

                    <!-- Scrape Status -->
                    <div id="scrapeStatus"
                        style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                        <div id="scrapeMessage" style="color: white; margin-bottom: 10px;"></div>
                        <div
                            style="width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden;">
                            <div id="scrapeProgress"
                                style="width: 0%; height: 100%; background: #d4af37; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div id="brandPreview"
                        style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">Preview:</h4>
                        <div id="previewContent" style="color: white; font-size: 0.9em;"></div>
                    </div>

                    <!-- Buttons -->
                    <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" onclick="closeAddBrandModal()"
                            style="padding: 12px 30px; border: 2px solid #d4af37; border-radius: 8px; background: transparent; color: #d4af37; font-weight: 600; cursor: pointer; font-size: 1em;">Cancel</button>
                        <button type="submit" id="addBrandSubmit"
                            style="padding: 12px 30px; border: none; border-radius: 8px; background: #d4af37; color: #1a365d; font-weight: 600; cursor: pointer; font-size: 1em; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">ðŸ”
                            Scrape & Add Brand</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        // Progress modal functions
        function showProgressModal(title = 'Processing') {
            const modal = document.getElementById('progressModal');
            const titleElem = document.getElementById('progressTitle');
            if (modal && titleElem) {
                titleElem.textContent = title;
                modal.style.display = 'flex';
            }
        }

        function hideProgressModal() {
            const modal = document.getElementById('progressModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateProgress(message, percent) {
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressMessage = document.getElementById('progressMessage');

            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            if (progressPercent && percent > 15) {
                progressPercent.textContent = Math.round(percent) + '%';
            } else if (progressPercent) {
                progressPercent.textContent = '';
            }
            if (progressMessage) {
                progressMessage.textContent = message;
            }

            console.log(`Progress: ${percent}% - ${message}`);
        }

        // Background Scraping Jobs Tracker
        let backgroundScrapingJobs = {};

        // Toggle Firecrawl Options
        function toggleFirecrawlOptions() {
            // Check for active modal inputs first
            const scrapingMethodInput = document.getElementById('scrapingMethodInput');
            const firecrawlOptionsInput = document.getElementById('firecrawlOptionsInput');

            if (scrapingMethodInput && firecrawlOptionsInput) {
                firecrawlOptionsInput.style.display = scrapingMethodInput.value === 'firecrawl' ? 'block' : 'none';
            }

            // Check for hidden modal inputs (fallback)
            const scrapingMethod = document.getElementById('scrapingMethod');
            const firecrawlOptions = document.getElementById('firecrawlOptions');

            if (scrapingMethod && firecrawlOptions) {
                firecrawlOptions.style.display = scrapingMethod.value === 'firecrawl' ? 'block' : 'none';
            }
        }

        // Add Brand Modal Functions
        function openAddBrandModal() {
            const modal = document.getElementById('addBrandModal');
            const tray = document.getElementById('backgroundJobsTray');
            if (modal) {
                modal.style.display = 'flex';
                // Reset form
                const form = document.getElementById('addBrandForm');
                if (form) form.reset();
                const scrapeStatus = document.getElementById('scrapeStatus');
                if (scrapeStatus) scrapeStatus.style.display = 'none';
                const brandPreview = document.getElementById('brandPreview');
                if (brandPreview) brandPreview.style.display = 'none';
            }
            // Hide tray when modal is open
            if (tray) tray.style.display = 'none';
        }

        function minimizeAddBrandModal() {
            const modal = document.getElementById('addBrandModal');
            const tray = document.getElementById('backgroundJobsTray');
            if (modal) {
                modal.style.display = 'none';
            }
            // Always show tray when minimized (it will hide itself if no jobs)
            if (tray) {
                if (Object.keys(backgroundScrapingJobs).length > 0) {
                    tray.style.display = 'block';
                } else {
                    tray.style.display = 'none';
                }
            }
        }

        function restoreAddBrandModal() {
            const modal = document.getElementById('addBrandModal');
            const tray = document.getElementById('backgroundJobsTray');
            if (modal) {
                modal.style.display = 'flex';
            }
            if (tray) {
                tray.style.display = 'none';
            }
        }

        function handleModalClick(event) {
            // If clicking on the backdrop (not the modal content), minimize instead of close
            // This keeps scraping running in the background
            if (event.target.id === 'addBrandModal') {
                minimizeAddBrandModal();
            }
        }

        function closeAddBrandModal() {
            const modal = document.getElementById('addBrandModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Only close if no jobs are running
            if (Object.keys(backgroundScrapingJobs).length === 0) {
                const tray = document.getElementById('backgroundJobsTray');
                if (tray) tray.style.display = 'none';
            } else {
                // Show tray if jobs are running
                minimizeAddBrandModal();
            }
        }

        function addBackgroundJob(jobId, brandName, website) {
            backgroundScrapingJobs[jobId] = {
                brandName: brandName,
                website: website,
                status: 'running',
                startTime: Date.now(),
                progress: 0
            };
            updateBackgroundJobsTray();
            // Show tray
            const tray = document.getElementById('backgroundJobsTray');
            if (tray) tray.style.display = 'block';
        }

        function updateBackgroundJob(jobId, updates) {
            if (backgroundScrapingJobs[jobId]) {
                Object.assign(backgroundScrapingJobs[jobId], updates);
                updateBackgroundJobsTray();
            }
        }

        function removeBackgroundJob(jobId) {
            delete backgroundScrapingJobs[jobId];
            updateBackgroundJobsTray();
            // Hide tray if no jobs
            if (Object.keys(backgroundScrapingJobs).length === 0) {
                const tray = document.getElementById('backgroundJobsTray');
                if (tray) tray.style.display = 'none';
            }
        }

        function updateBackgroundJobsTray() {
            const jobsList = document.getElementById('backgroundJobsList');
            const tray = document.getElementById('backgroundJobsTray');

            if (!jobsList) return;

            const jobs = Object.values(backgroundScrapingJobs);
            if (jobs.length === 0) {
                jobsList.innerHTML = '<p style="color: #94a3b8; margin: 0; font-size: 0.9em;">No active scraping jobs</p>';
                // Hide tray if no jobs and modal is closed
                const modal = document.getElementById('addBrandModal');
                if (tray && (!modal || modal.style.display === 'none')) {
                    tray.style.display = 'none';
                }
                return;
            }

            // Show tray if there are jobs
            if (tray) {
                tray.style.display = 'block';
            }

            jobsList.innerHTML = jobs.map((job, index) => {
                const elapsed = Math.floor((Date.now() - job.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const statusIcon = job.status === 'completed' ? 'âœ…' : job.status === 'failed' ? 'âŒ' : 'ðŸ”„';
                const statusColor = job.status === 'completed' ? '#10b981' : job.status === 'failed' ? '#ef4444' : '#d4af37';

                return `
                    <div style="background: rgba(15, 23, 42, 0.8); padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="color: #e0e0e0; font-weight: bold; font-size: 0.95em;">${statusIcon} ${job.brandName}</span>
                            ${job.status === 'running' ? `<span style="color: #94a3b8; font-size: 0.8em;">${minutes}m ${seconds}s</span>` : ''}
                        </div>
                        ${job.status === 'running' ? `
                            <div style="background: #475569; border-radius: 4px; height: 6px; overflow: hidden; margin-bottom: 5px;">
                                <div style="background: linear-gradient(90deg, #d4af37, #ffd700); height: 100%; width: ${job.progress}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="color: #94a3b8; font-size: 0.8em;">${job.progressText || 'Scraping...'}</div>
                        ` : job.status === 'completed' ? `
                            <div style="color: #94a3b8; font-size: 0.8em;">${job.productsCount ? job.productsCount + ' products scraped' : 'Completed'}</div>
                        ` : `
                            <div style="color: #ef4444; font-size: 0.8em;">${job.error || 'Failed'}</div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function handleAddBrand(event) {
            console.log('handleAddBrand called');
            // alert('Starting scrape process...'); // Uncomment for debugging if needed
            event.preventDefault();

            // Try to get values from active modal (Input suffix) or fallback to hidden modal
            let brandName = document.getElementById('brandNameInput') ? document.getElementById('brandNameInput').value.trim() : '';
            if (!brandName) brandName = document.getElementById('brandName') ? document.getElementById('brandName').value.trim() : '';

            let website = document.getElementById('brandWebsiteInput') ? document.getElementById('brandWebsiteInput').value.trim() : '';
            if (!website) website = document.getElementById('brandWebsite') ? document.getElementById('brandWebsite').value.trim() : '';

            let country = document.getElementById('brandCountryInput') ? document.getElementById('brandCountryInput').value.trim() : '';
            if (!country) country = document.getElementById('brandCountry') ? document.getElementById('brandCountry').value.trim() : 'Unknown';
            if (!country) country = 'Unknown';

            let tier = document.getElementById('brandTierInput') ? document.getElementById('brandTierInput').value : '';
            if (!tier) tier = document.getElementById('brandTier') ? document.getElementById('brandTier').value : 'mid_range';

            // Scraping method might be in either modal
            let scrapingMethod = 'requests';  // Default to requests
            if (document.getElementById('scrapingMethodInput')) {
                scrapingMethod = document.getElementById('scrapingMethodInput').value;
            } else if (document.getElementById('scrapingMethod')) {
                scrapingMethod = document.getElementById('scrapingMethod').value;
            }
            console.log('Selected scraping method:', scrapingMethod);

            let crawlLimit = 50;
            if (document.getElementById('crawlLimitInput')) {
                crawlLimit = parseInt(document.getElementById('crawlLimitInput').value);
            } else if (document.getElementById('crawlLimit')) {
                crawlLimit = parseInt(document.getElementById('crawlLimit').value);
            }

            if (!brandName || !website) {
                if (typeof showAlert === 'function') {
                    showAlert('Please enter brand name and website', 'error');
                } else {
                    alert('Please enter brand name and website');
                }
                return;
            }

            // Validate URL
            try {
                new URL(website);
            } catch (e) {
                if (typeof showAlert === 'function') {
                    showAlert('Please enter a valid website URL', 'error');
                } else {
                    alert('Please enter a valid website URL');
                }
                return;
            }

            // Create unique job ID
            const jobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // Add to background jobs
            if (typeof addBackgroundJob === 'function') {
                addBackgroundJob(jobId, brandName, website);
            } else {
                console.warn('addBackgroundJob function not found');
            }

            // Get UI elements for both modals (Active / Hidden)
            const statusDiv = document.getElementById('addBrandProgress') || document.getElementById('scrapeStatus');
            const messageDiv = document.getElementById('progressText') || document.getElementById('scrapeMessage');
            const progressBar = document.getElementById('progressBar') || document.getElementById('scrapeProgress');
            const submitBtn = document.getElementById('scrapeBrandBtn') || document.getElementById('addBrandSubmit');
            const previewDiv = document.getElementById('addBrandResult') || document.getElementById('brandPreview');
            const previewContent = document.getElementById('addBrandResult') || document.getElementById('previewContent'); // Active modal uses result div for content too

            // Show status
            if (statusDiv) statusDiv.style.display = 'block';
            if (previewDiv) previewDiv.style.display = 'none';

            // Reset progress
            if (progressBar) progressBar.style.width = '0%';
            if (messageDiv) messageDiv.textContent = 'Starting scrape...';
            if (messageDiv) messageDiv.style.color = '#e0e0e0'; // Reset color

            // Disable button
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scraping...';
            }

            try {
                const response = await fetch('/api/brands/scrape-and-add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        brand_name: brandName,
                        website: website,
                        country: country,
                        tier: tier,
                        scraping_method: scrapingMethod,
                        crawl_limit: crawlLimit,
                        job_id: jobId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (progressBar) progressBar.style.width = '100%';
                    if (messageDiv) {
                        messageDiv.textContent = 'Success! ' + data.message;
                        messageDiv.style.color = '#10b981';
                    }

                    // Show preview/result
                    if (previewDiv) {
                        previewDiv.style.display = 'block';
                        let html = `<div style="color: #10b981; font-weight: bold; margin-bottom: 10px;">âœ… ${data.message}</div>`;

                        if (data.categories && data.categories.length > 0) {
                            html += `<div style="margin-top: 10px; color: #e0e0e0;">Found categories: ${data.categories.join(', ')}</div>`;
                        }

                        if (data.products_count) {
                            html += `<div style="margin-top: 5px; color: #d4af37;">Total products: ${data.products_count}</div>`;
                        }

                        if (previewContent) previewContent.innerHTML = html;
                    }

                    // Refresh brands list if available
                    if (typeof loadBrands === 'function') {
                        setTimeout(loadBrands, 1500);
                    }

                    // Close modal after delay
                    setTimeout(() => {
                        if (typeof closeAddBrandModal === 'function') closeAddBrandModal();
                        // Reset form
                        const form = document.getElementById('addBrandFormActive') || document.getElementById('addBrandForm');
                        if (form) form.reset();
                        if (statusDiv) statusDiv.style.display = 'none';
                        if (previewDiv) previewDiv.style.display = 'none';
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'ðŸ” Get Products';
                        }
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            } catch (error) {
                console.error('Error:', error);
                if (messageDiv) {
                    messageDiv.textContent = 'Error: ' + error.message;
                    messageDiv.style.color = '#ef4444';
                }
                if (progressBar) progressBar.style.background = '#ef4444';
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'ðŸ” Get Products';
                }
            }
        }



    </script>

    <script>
        // Multi-Budget Offer Section JavaScript Functions
        // IMPORTANT: Define these functions IMMEDIATELY so they're available for event listeners

        let currentBudgetTier = 'budgetary';
        let multiBudgetTables = {
            budgetary: null,
            mid_range: null,
            high_end: null
        };

        // Switch between budget tier tabs - Define IMMEDIATELY
        window.switchBudgetTab = function switchBudgetTab(tier) {
            currentBudgetTier = tier;

            // Update tab buttons
            document.querySelectorAll('.budget-tab').forEach(btn => {
                if (btn.dataset.tier === tier) {
                    btn.classList.add('active');
                    btn.style.background = '#1a365d';
                    btn.style.color = '#d4af37';
                    btn.style.borderBottom = '3px solid #d4af37';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = '#2d4a6b';
                    btn.style.color = '#e0e0e0';
                    btn.style.borderBottom = '3px solid transparent';
                }
            });

            // Show/hide table containers
            document.getElementById('budgetaryTableContainer').style.display = tier === 'budgetary' ? 'block' : 'none';
            document.getElementById('mid_rangeTableContainer').style.display = tier === 'mid_range' ? 'block' : 'none';
            document.getElementById('high_endTableContainer').style.display = tier === 'high_end' ? 'block' : 'none';

            // Update dropdowns in active table
            if (typeof window.updateBrandDropdownsForTier === 'function') {
                window.updateBrandDropdownsForTier(tier);
            }
        };

        // Add Brand Modal Functions - Replace stub with full implementation
        window.openAddBrandModal = async function openAddBrandModal() {
            const modal = document.getElementById('addBrandModal');
            const scrapeBtn = document.getElementById('scrapeBrandBtn');

            if (modal) {
                modal.style.display = 'block';
            }

            // Ensure button is enabled and visible
            if (scrapeBtn) {
                scrapeBtn.disabled = false;
                scrapeBtn.style.opacity = '1';
                scrapeBtn.style.cursor = 'pointer';
            }

            // Reset form
            const form = document.getElementById('addBrandForm');
            if (form) form.reset();

            // Reset progress and result displays
            const progressDiv = document.getElementById('addBrandProgress');
            const resultDiv = document.getElementById('addBrandResult');
            if (progressDiv) {
                progressDiv.style.display = 'none';
                const progressBar = document.getElementById('progressBar');
                if (progressBar) progressBar.style.width = '0%';
            }
            if (resultDiv) {
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';
            }

            // Load brands for database dropdown
            await loadBrandsForDatabase();
        };

        // Load brands for database download/upload dropdown
        async function loadBrandsForDatabase() {
            const brandSelect = document.getElementById('dbBrandSelect');
            const tierSelect = document.getElementById('dbTierSelect');

            if (!brandSelect || !tierSelect) return;

            const tier = tierSelect.value || 'mid_range';

            try {
                // Fetch all brands for this tier
                const response = await fetch(`/api/brands/list?tier=${tier}`);
                const data = await response.json();

                // Clear existing options (except first)
                brandSelect.innerHTML = '<option value="">-- Select Brand --</option>';

                if (data.success && data.brands && data.brands.length > 0) {
                    // Add brand options
                    data.brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.name;
                        option.textContent = `${brand.name} (${brand.country || 'Unknown'})`;
                        brandSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading brands for database:', error);
            }
        }

        // Download brand database as Excel
        async function downloadBrandDatabase() {
            const brandSelect = document.getElementById('dbBrandSelect');
            const tierSelect = document.getElementById('dbTierSelect');

            if (!brandSelect || !tierSelect) {
                alert('Brand selection not found');
                return;
            }

            const brand = brandSelect.value;
            const tier = tierSelect.value;

            if (!brand) {
                alert('Please select a brand to download');
                return;
            }

            try {
                // Download Excel file
                const url = `/api/brands/download-excel?brand=${encodeURIComponent(brand)}&tier=${encodeURIComponent(tier)}`;
                const response = await fetch(url);

                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${brand.replace(/\s+/g, '_')}_${tier}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);

                    // Show success message
                    const resultDiv = document.getElementById('dbUploadResult');
                    if (resultDiv) {
                        resultDiv.style.display = 'block';
                        resultDiv.style.background = '#0f4d3c';
                        resultDiv.style.color = '#4ade80';
                        resultDiv.innerHTML = `<strong>âœ… Success!</strong> Database downloaded successfully.`;
                        setTimeout(() => {
                            resultDiv.style.display = 'none';
                        }, 3000);
                    }
                } else {
                    const error = await response.json();
                    alert('Error downloading database: ' + (error.error || 'Failed to download'));
                }
            } catch (error) {
                console.error('Error downloading database:', error);
                alert('Error downloading database: ' + error.message);
            }
        }

        // Upload brand database from Excel
        async function uploadBrandDatabase() {
            const fileInput = document.getElementById('dbFileUpload');
            const brandSelect = document.getElementById('dbBrandSelect');
            const tierSelect = document.getElementById('dbTierSelect');

            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('Please select an Excel file to upload');
                return;
            }

            const file = fileInput.files[0];
            const tier = tierSelect.value || 'mid_range';

            // Show progress
            const progressDiv = document.getElementById('dbUploadProgress');
            const progressBar = document.getElementById('dbUploadBar');
            const progressText = document.getElementById('dbUploadText');
            const resultDiv = document.getElementById('dbUploadResult');

            if (progressDiv) progressDiv.style.display = 'block';
            if (progressBar) progressBar.style.width = '20%';
            if (progressText) progressText.textContent = 'Uploading file...';
            if (resultDiv) resultDiv.style.display = 'none';

            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('tier', tier);

                // Add brand from dropdown if selected, otherwise it will be extracted from Excel
                if (brandSelect && brandSelect.value) {
                    formData.append('brand', brandSelect.value);
                }

                // Add website and country if available from form
                const websiteInput = document.getElementById('brandWebsiteInput');
                const countryInput = document.getElementById('brandCountryInput');
                if (websiteInput && websiteInput.value) {
                    formData.append('website', websiteInput.value);
                }
                if (countryInput && countryInput.value) {
                    formData.append('country', countryInput.value);
                }

                if (progressBar) progressBar.style.width = '50%';
                if (progressText) progressText.textContent = 'Processing file...';

                const response = await fetch('/api/brands/upload-excel', {
                    method: 'POST',
                    body: formData
                });

                if (progressBar) progressBar.style.width = '80%';
                if (progressText) progressText.textContent = 'Saving database...';

                const result = await response.json();

                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Complete!';

                setTimeout(() => {
                    if (progressDiv) progressDiv.style.display = 'none';
                    if (progressBar) progressBar.style.width = '0%';

                    if (result.success) {
                        if (resultDiv) {
                            resultDiv.style.display = 'block';
                            resultDiv.style.background = '#0f4d3c';
                            resultDiv.style.color = '#4ade80';
                            resultDiv.innerHTML = `
                                <strong>âœ… Success!</strong><br>
                                ${result.message}<br>
                                <small>Categories: ${result.categories ? result.categories.join(', ') : 'General'}</small>
                            `;
                        }

                        // Update brand dropdowns for the active tier
                        if (typeof updateBrandDropdownsForTier === 'function') {
                            updateBrandDropdownsForTier(currentBudgetTier || 'budgetary');
                        }

                        // Reload brands list
                        loadBrandsForDatabase();

                        // Reset file input
                        if (fileInput) fileInput.value = '';
                    } else {
                        if (resultDiv) {
                            resultDiv.style.display = 'block';
                            resultDiv.style.background = '#7f1d1d';
                            resultDiv.style.color = '#f87171';
                            resultDiv.innerHTML = `<strong>âŒ Error:</strong> ${result.error || 'Failed to upload database'}`;
                        }
                    }
                }, 1000);

            } catch (error) {
                if (progressDiv) progressDiv.style.display = 'none';
                if (resultDiv) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#7f1d1d';
                    resultDiv.style.color = '#f87171';
                    resultDiv.innerHTML = `<strong>âŒ Error:</strong> ${error.message}`;
                }
                console.error('Error uploading database:', error);
            }
        }

        // Update brand dropdown when tier changes (set up on DOM ready)
        document.addEventListener('DOMContentLoaded', () => {
            const dbTierSelect = document.getElementById('dbTierSelect');
            if (dbTierSelect) {
                dbTierSelect.addEventListener('change', () => {
                    loadBrandsForDatabase();
                });
            }

            // Update background jobs tray every 1 second while there are active jobs
            setInterval(() => {
                if (Object.keys(backgroundScrapingJobs).length > 0) {
                    updateBackgroundJobsTray();
                }
            }, 1000);
        });

        function closeAddBrandModal() {
            const modal = document.getElementById('addBrandModal');
            const scrapeBtn = document.getElementById('scrapeBrandBtn');

            if (modal) {
                modal.style.display = 'none';
            }

            // Re-enable button when closing
            if (scrapeBtn) {
                scrapeBtn.disabled = false;
                scrapeBtn.style.opacity = '1';
                scrapeBtn.style.cursor = 'pointer';
            }

            // Reset form
            const form = document.getElementById('addBrandForm');
            if (form) form.reset();

            // Reset progress and result
            const progressDiv = document.getElementById('addBrandProgress');
            const resultDiv = document.getElementById('addBrandResult');
            if (progressDiv) {
                progressDiv.style.display = 'none';
                const progressBar = document.getElementById('progressBar');
                if (progressBar) progressBar.style.width = '0%';
            }
            if (resultDiv) {
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';
            }
        }

        // Handle Add Brand form submission
        async function handleAddBrand(event) {
            event.preventDefault();

            const brandName = document.getElementById('brandNameInput').value.trim();
            const website = document.getElementById('brandWebsiteInput').value.trim();
            const country = document.getElementById('brandCountryInput').value.trim() || 'Unknown';
            const tier = document.getElementById('brandTierInput').value;

            // Get scraping method and crawl limit
            const scrapingMethod = document.getElementById('scrapingMethodInput') ?
                document.getElementById('scrapingMethodInput').value : 'requests';
            const crawlLimit = document.getElementById('crawlLimitInput') ?
                parseInt(document.getElementById('crawlLimitInput').value) : 50;

            console.log('ðŸ” Scraping Method Selected:', scrapingMethod);
            console.log('ðŸ“Š Crawl Limit:', crawlLimit);

            if (!brandName || !website) {
                alert('Brand name and website are required');
                return;
            }

            // Create unique job ID
            const jobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // Add to background jobs
            addBackgroundJob(jobId, brandName, website);

            // Show progress in modal
            const progressDiv = document.getElementById('addBrandProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const resultDiv = document.getElementById('addBrandResult');
            const scrapeBtn = document.getElementById('scrapeBrandBtn');
            const scrapingEvents = document.getElementById('scrapingEvents');
            const eventsList = document.getElementById('eventsList');
            const eventCount = document.getElementById('eventCount');

            // Ensure button is enabled and visible
            if (scrapeBtn) {
                scrapeBtn.disabled = false;
                scrapeBtn.style.opacity = '1';
                scrapeBtn.style.cursor = 'pointer';
            }

            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';

            // Show events preview
            if (scrapingEvents) {
                scrapingEvents.style.display = 'block';
            }
            if (eventsList) {
                eventsList.innerHTML = '<div style="color: #94a3b8; font-style: italic;">Waiting for events...</div>';
            }

            // Re-enable button immediately so user can start another scrape
            if (scrapeBtn) {
                scrapeBtn.disabled = false;
                scrapeBtn.style.opacity = '1';
                scrapeBtn.style.cursor = 'pointer';
                scrapeBtn.textContent = 'ðŸ” Get Products';
            }

            // Start polling for real-time events
            let eventPollInterval = null;

            // Declare pollScrapeStatus function
            const pollScrapeStatus = async () => {
                try {
                    const response = await fetch(`/api/brands/scrape-status/${jobId}`);
                    if (response.ok) {
                        const statusData = await response.json();

                        // Update progress bar
                        if (statusData.progress !== undefined && progressBar) {
                            progressBar.style.width = statusData.progress + '%';
                        }

                        // Update progress text
                        if (statusData.message && progressText) {
                            progressText.textContent = statusData.message;
                        }

                        // Update events list
                        if (statusData.events && eventsList) {
                            if (statusData.events.length === 0) {
                                eventsList.innerHTML = '<div style="color: #94a3b8; font-style: italic;">Waiting for events...</div>';
                            } else {
                                // Show last 10 events (most recent at bottom)
                                const recentEvents = statusData.events.slice(-10);
                                eventsList.innerHTML = recentEvents.map(event => {
                                    const time = new Date(event.timestamp).toLocaleTimeString();
                                    const statusColor = event.status === 'completed' ? '#10b981' :
                                        event.status === 'failed' ? '#ef4444' :
                                            event.status === 'error' ? '#ef4444' : '#d4af37';
                                    return `<div style="color: ${statusColor}; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                        <span>${event.message}</span>
                                        <span style="color: #94a3b8; font-size: 0.85em; margin-left: 10px;">${time}</span>
                                    </div>`;
                                }).join('');
                                // Auto-scroll to bottom
                                eventsList.scrollTop = eventsList.scrollHeight;
                            }

                            // Update event count
                            if (eventCount) {
                                eventCount.textContent = `${statusData.events.length} events`;
                            }
                        }

                        // Stop polling if completed or failed
                        if (statusData.status === 'completed' || statusData.status === 'failed') {
                            if (eventPollInterval) {
                                clearInterval(eventPollInterval);
                                eventPollInterval = null;
                            }
                            // Hide events after 3 seconds
                            setTimeout(() => {
                                if (scrapingEvents) {
                                    scrapingEvents.style.display = 'none';
                                }
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('Error polling scrape status:', error);
                }
            };

            // Poll every 500ms for responsive updates
            eventPollInterval = setInterval(pollScrapeStatus, 500);
            pollScrapeStatus(); // Initial call

            // Reset form so user can enter a new brand
            const form = document.getElementById('addBrandForm');
            if (form) {
                // Clear form fields but keep tier selection
                const brandNameInput = document.getElementById('brandNameInput');
                const websiteInput = document.getElementById('brandWebsiteInput');
                const countryInput = document.getElementById('brandCountryInput');
                if (brandNameInput) brandNameInput.value = '';
                if (websiteInput) websiteInput.value = '';
                if (countryInput) countryInput.value = '';
            }

            // Show tray if minimized
            const tray = document.getElementById('backgroundJobsTray');
            if (tray) {
                tray.style.display = 'block';
            }

            // Simulate progress updates (for modal) - only while modal is open
            let progress = 0;
            const progressInterval = setInterval(() => {
                const modal = document.getElementById('addBrandModal');
                if (modal && modal.style.display === 'none') {
                    clearInterval(progressInterval);
                    return;
                }

                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                if (progressBar) progressBar.style.width = progress + '%';

                let progressTextValue = 'Scraping...';
                if (progress < 30) {
                    progressTextValue = 'Analyzing website structure...';
                } else if (progress < 60) {
                    progressTextValue = 'Fetching product data...';
                } else if (progress < 90) {
                    progressTextValue = 'Processing results...';
                }
                if (progressText) progressText.textContent = progressTextValue;

                // Update background job progress
                updateBackgroundJob(jobId, {
                    progress: progress,
                    progressText: progressTextValue
                });
                // Tray updates automatically via setInterval
            }, 500);

            // Start scraping in background (doesn't block UI)
            scrapeBrandInBackground(jobId, brandName, website, country, tier, scrapingMethod, crawlLimit, progressInterval, eventPollInterval, progressDiv, progressBar, progressText, resultDiv, scrapeBtn, scrapingEvents);
        }

        async function scrapeBrandInBackground(jobId, brandName, website, country, tier, scrapingMethod, crawlLimit, progressInterval, eventPollInterval, progressDiv, progressBar, progressText, resultDiv, scrapeBtn, scrapingEvents) {
            try {
                const response = await fetch('/api/brands/scrape-and-add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        brand_name: brandName,
                        website: website,
                        country: country,
                        tier: tier,
                        scraping_method: scrapingMethod,
                        crawl_limit: crawlLimit,
                        job_id: jobId  // Send job ID for status tracking
                    })
                });

                const result = await response.json();

                // Stop simulated progress interval
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                // Stop event polling if still running
                if (eventPollInterval) {
                    clearInterval(eventPollInterval);
                }

                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Complete!';

                if (result.success) {
                    // Update background job as completed
                    updateBackgroundJob(jobId, {
                        status: 'completed',
                        progress: 100,
                        productsCount: result.products_count || 0,
                        progressText: 'Completed'
                    });
                    updateBackgroundJobsTray();

                    // Show result in modal if still open
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#0f4d3c';
                    resultDiv.style.color = '#4ade80';
                    resultDiv.innerHTML = `
                        <strong>âœ… Success!</strong><br>
                        ${result.message}<br>
                        <small>Categories: ${result.categories ? result.categories.join(', ') : 'General'}</small><br>
                        <small style="color: #94a3b8; margin-top: 10px; display: block;">Note: Existing brand data has been replaced with new results.</small>
                    `;

                    // Re-enable button
                    if (scrapeBtn) {
                        scrapeBtn.disabled = false;
                        scrapeBtn.style.opacity = '1';
                        scrapeBtn.style.cursor = 'pointer';
                    }

                    // Update brand dropdowns for the active tier
                    if (typeof updateBrandDropdownsForTier === 'function') {
                        updateBrandDropdownsForTier(currentBudgetTier || 'budgetary');
                    }

                    // Remove job after 5 seconds
                    setTimeout(() => {
                        removeBackgroundJob(jobId);
                    }, 5000);

                } else {
                    // Update background job as failed
                    updateBackgroundJob(jobId, {
                        status: 'failed',
                        error: result.error || 'Failed to scrape brand',
                        progressText: 'Failed'
                    });
                    updateBackgroundJobsTray();

                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#7f1d1d';
                    resultDiv.style.color = '#f87171';
                    resultDiv.innerHTML = `<strong>âŒ Error:</strong> ${result.error || 'Failed to scrape brand'}<br><small style="color: #fca5a5;">You can try again by clicking the button.</small>`;
                    if (scrapeBtn) {
                        scrapeBtn.disabled = false;
                        scrapeBtn.style.opacity = '1';
                        scrapeBtn.style.cursor = 'pointer';
                    }

                    // Remove job after 10 seconds
                    setTimeout(() => {
                        removeBackgroundJob(jobId);
                    }, 10000);
                }

            } catch (error) {
                // Stop intervals
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                // Stop event polling if still running
                if (eventPollInterval) {
                    clearInterval(eventPollInterval);
                }

                // Update background job as failed
                updateBackgroundJob(jobId, {
                    status: 'failed',
                    error: error.message,
                    progressText: 'Error'
                });

                if (progressDiv) progressDiv.style.display = 'none';
                if (scrapingEvents) {
                    scrapingEvents.style.display = 'none';
                }
                if (resultDiv) resultDiv.style.display = 'block';
                resultDiv.style.background = '#7f1d1d';
                resultDiv.style.color = '#f87171';
                resultDiv.innerHTML = `<strong>âŒ Error:</strong> ${error.message}<br><small style="color: #fca5a5;">You can try again by clicking the button.</small>`;
                if (scrapeBtn) {
                    scrapeBtn.disabled = false;
                    scrapeBtn.style.opacity = '1';
                    scrapeBtn.style.cursor = 'pointer';
                }

                // Remove job after 10 seconds
                setTimeout(() => {
                    removeBackgroundJob(jobId);
                }, 10000);
            }
        }

        // Generate from BOQ - copies extracted or costed table
        // Prefers costed tables if they exist, otherwise uses stitched tables
        // Make generateFromBOQ globally accessible - Replace stub with full implementation
        window.generateFromBOQ = async function generateFromBOQ() {
            try {
                // Show loading indicator
                const button = document.querySelector('button[onclick*="generateFromBOQ"]');
                const originalText = button ? button.textContent : '';
                if (button) {
                    button.disabled = true;
                    button.textContent = 'â³ Generating...';
                }

                // First, try to get table from DOM (preview area)
                let tableHTML = '';
                let latestFile = null;

                // Look for costed table first, then stitched table in preview area
                const previewTables = document.querySelectorAll('.preview-container table, #preview-quote-pricelist table, #preview-multi-budget table, #costedTableContent table');

                if (previewTables.length > 0) {
                    // Get the first/last visible table
                    const visibleTable = Array.from(previewTables).find(t => {
                        const parent = t.closest('.preview-container, .card');
                        return parent && (parent.style.display !== 'none' || !parent.style.display);
                    }) || previewTables[previewTables.length - 1];

                    if (visibleTable) {
                        tableHTML = visibleTable.outerHTML;
                        // Try to get file ID from data attributes
                        const fileIdAttr = visibleTable.closest('[data-file-id]');
                        if (fileIdAttr) {
                            latestFile = { id: fileIdAttr.dataset.fileId };
                        }
                    }
                }

                // If no table in DOM, try to fetch from server
                if (!tableHTML) {
                    try {
                        // Fetch uploaded files from server with timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                        const response = await fetch('/api/files/list', { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && result.files && result.files.length > 0) {
                                // Prefer costed tables if they exist, otherwise use stitched tables
                                let foundCosted = false;

                                // First, look for costed tables
                                for (let file of result.files.reverse()) {
                                    if (file.costed_table && file.costed_table.html) {
                                        tableHTML = file.costed_table.html;
                                        latestFile = file;
                                        foundCosted = true;
                                        break;
                                    }
                                }

                                // If no costed table found, look for stitched tables
                                if (!foundCosted) {
                                    for (let file of result.files.reverse()) {
                                        if (file.stitched_table && file.stitched_table.html) {
                                            tableHTML = file.stitched_table.html;
                                            latestFile = file;
                                            break;
                                        } else if (file.extraction_result) {
                                            // Try to extract table from extraction result
                                            // This is a fallback
                                            latestFile = file;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    } catch (fetchError) {
                        console.warn('Could not fetch files from server:', fetchError);
                        if (fetchError.name === 'AbortError') {
                            alert('Request timed out. Please try again.');
                            if (button) {
                                button.disabled = false;
                                button.textContent = originalText;
                            }
                            return;
                        }
                    }
                }

                if (!tableHTML || !tableHTML.trim()) {
                    alert('No extracted or costed table found. Please extract BOQ files first and optionally apply costing, then try again.');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                    return;
                }

                // Ensure latestFile has at least an id
                if (!latestFile) {
                    latestFile = { id: 'unknown' };
                }

                // Create table with Product Selection column for current tier
                // Use setTimeout to allow UI to update
                setTimeout(() => {
                    try {
                        createMultiBudgetTable(currentBudgetTier, tableHTML, latestFile);

                        // Initialize brand dropdowns after table is created
                        setTimeout(() => {
                            updateBrandDropdownsForTier(currentBudgetTier);
                        }, 100);

                        if (button) {
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    } catch (tableError) {
                        console.error('Error creating table:', tableError);
                        alert('Error creating table: ' + (tableError.message || 'Unknown error occurred'));
                        if (button) {
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    }
                }, 50);

            } catch (error) {
                console.error('Error generating from BOQ:', error);
                alert('Error generating from BOQ: ' + (error.message || 'Unknown error occurred'));
                const button = document.querySelector('button[onclick*="generateFromBOQ"]');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'ðŸ“‹ Generate from BOQ';
                }
            }
        };

        // Create New BOQ - generates empty table - Replace stub with full implementation
        window.createNewBOQ = function createNewBOQ() {
            const headers = ['SI.No', 'Image', 'Description', 'Unit', 'Qty', 'Price', 'Total'];
            const emptyTableHTML = createEmptyTableHTML(headers, 5);
            createMultiBudgetTable(currentBudgetTier, emptyTableHTML, null);
        };

        // Create empty table HTML
        function createEmptyTableHTML(headers, numRows) {
            let html = '<table border="1" style="width: 100%; border-collapse: collapse; background: white;">';
            html += '<thead><tr>';

            // Add original headers only (no Brand Image/Brand Description for CREATE NEW BOQ)
            headers.forEach(h => {
                html += `<th style="background: #1a365d; color: #d4af37; padding: 12px; border: 1px solid #d4af37; text-align: center;">${h}</th>`;
            });

            // Add Product Selection and Actions headers
            html += '<th style="background: #1a365d; color: #d4af37; padding: 12px; border: 1px solid #d4af37; text-align: center;">Product Selection</th>';
            html += '<th style="background: #1a365d; color: #d4af37; padding: 12px; border: 1px solid #d4af37; text-align: center;">Actions</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i <= numRows; i++) {
                const rowId = `row_${currentBudgetTier}_${Date.now()}_${i}`;
                html += '<tr>';

                // Add original columns (including Image and Description which are fillable)
                headers.forEach(h => {
                    const hLower = h.toLowerCase();
                    if (hLower.includes('si.no') || hLower.includes('s.')) {
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;" contenteditable="true">${i}</td>`;
                    } else if (hLower.includes('image') || hLower.includes('img')) {
                        // Image column - editable for user to paste/upload image
                        html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: center;" contenteditable="true"></td>';
                    } else if (hLower.includes('description') || hLower.includes('desc')) {
                        // Description column - editable for user to enter description
                        html += '<td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true"></td>';
                    } else if (hLower.includes('price') || hLower.includes('total')) {
                        html += '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;" contenteditable="true"></td>';
                    } else {
                        // Other columns (Unit, Qty, etc.) - also editable
                        html += '<td style="padding: 8px; border: 1px solid #ddd;" contenteditable="true"></td>';
                    }
                });

                // Add Product Selection cell (no Brand Image/Brand Description cells for CREATE NEW BOQ)
                html += `<td class="product-selection-cell" data-row-id="${rowId}" style="padding: 8px 6px; border: 1px solid #e2e8f0; vertical-align: middle; background: #fff; width: 14%; min-width: 160px; max-width: 180px;">`;
                html += createProductSelectionDropdowns(rowId, currentBudgetTier);
                html += '</td>';

                // Add Actions cell
                html += `<td class="actions-cell" style="padding: 8px 4px; border: 1px solid #e2e8f0; text-align: center; vertical-align: middle; background: #fff; width: 6%; min-width: 85px; max-width: 100px;">`;
                html += `<div style="display: flex; gap: 4px; justify-content: center; align-items: center; flex-wrap: nowrap;">`;
                html += `<button onclick="addRow('${rowId}', '${currentBudgetTier}')" title="Add row below" style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 2px 4px rgba(34,197,94,0.3); transition: all 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(34,197,94,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(34,197,94,0.3)'">+</button>`;
                html += `<button onclick="deleteRow('${rowId}', '${currentBudgetTier}')" title="Delete this row" style="background: linear-gradient(135deg, #f87171, #ef4444); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 2px 4px rgba(239,68,68,0.3); transition: all 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(239,68,68,0.3)'">Ã—</button>`;
                html += `</div>`;
                html += '</td>';
                html += '</tr>';
            }

            html += '</tbody></table>';
            return html;
        }

        // Create multi-budget table with Product Selection column
        function createMultiBudgetTable(tier, tableHTML, fileInfo) {
            try {
                // Ensure fileInfo is properly initialized
                if (!fileInfo) {
                    fileInfo = null;
                }

                // Parse existing table or create new
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = tableHTML;
                let table = tempDiv.querySelector('table');

                if (!table) {
                    alert('Could not parse table');
                    console.error('Table not found in HTML:', tableHTML.substring(0, 200));
                    return;
                }

                // Apply improved table styling with fixed layout for better performance
                table.style.cssText = 'width: 100%; border-collapse: separate; border-spacing: 0; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; table-layout: fixed;';

                // Process header row
                const thead = table.querySelector('thead');
                let headerRow = thead ? thead.querySelector('tr') : table.querySelector('tbody tr');

                if (!headerRow) {
                    console.error('Header row not found in table');
                    alert('Could not find header row in table');
                    return;
                }

                // Find Image and Description column indices
                let imageColIndex = -1;
                let descColIndex = -1;
                Array.from(headerRow.children).forEach((th, idx) => {
                    const text = th.textContent.toLowerCase().trim();
                    if (imageColIndex === -1 && (text.includes('image') || text.includes('img') || text.includes('img.ref'))) {
                        imageColIndex = idx;
                    }
                    if (descColIndex === -1 && (text.includes('description') || text.includes('item description') || text.includes('desc'))) {
                        descColIndex = idx;
                    }
                });

                // Style header cells with compact padding
                Array.from(headerRow.children).forEach((th, idx) => {
                    th.style.cssText = 'background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #d4af37; padding: 10px 8px; border: 1px solid #3a6fa5; text-align: center; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
                    if (idx === 0) th.style.borderTopLeftRadius = '8px';
                    if (idx === headerRow.children.length - 1) th.style.borderTopRightRadius = '8px';
                });

                // Add Brand Image and Brand Description headers after original columns
                // Only for GENERATE FROM BOQ (fileInfo is not null), not for CREATE NEW BOQ
                if (fileInfo !== null && (imageColIndex >= 0 || descColIndex >= 0)) {
                    const maxIndex = Math.max(imageColIndex, descColIndex);
                    const insertIndex = maxIndex + 1;

                    // Add Brand Image header
                    if (!Array.from(headerRow.children).some(th => th.textContent.toLowerCase().includes('brand image'))) {
                        const brandImageHeader = document.createElement(thead && thead.querySelector('tr') === headerRow ? 'th' : 'td');
                        brandImageHeader.textContent = 'Brand Image';
                        brandImageHeader.style.cssText = 'background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #d4af37; padding: 14px 12px; border: 1px solid #3a6fa5; text-align: center; font-weight: 600; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;';
                        if (headerRow.children.length === insertIndex) {
                            headerRow.appendChild(brandImageHeader);
                        } else {
                            headerRow.insertBefore(brandImageHeader, headerRow.children[insertIndex]);
                        }
                    }

                    // Add Brand Description header
                    if (!Array.from(headerRow.children).some(th => th.textContent.toLowerCase().includes('brand description'))) {
                        const brandDescHeader = document.createElement(thead && thead.querySelector('tr') === headerRow ? 'th' : 'td');
                        brandDescHeader.textContent = 'Brand Description';
                        brandDescHeader.style.cssText = 'background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #d4af37; padding: 14px 12px; border: 1px solid #3a6fa5; text-align: center; font-weight: 600; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;';
                        const newImageIndex = Array.from(headerRow.children).findIndex(th => th.textContent.toLowerCase().includes('brand image'));
                        if (newImageIndex >= 0) {
                            headerRow.insertBefore(brandDescHeader, headerRow.children[newImageIndex + 1]);
                        } else {
                            headerRow.appendChild(brandDescHeader);
                        }
                    }
                }

                // Find Product Selection and Actions headers
                const hasProductSelection = Array.from(headerRow.children).some(th =>
                    th.textContent.toLowerCase().includes('product selection'));
                const hasActions = Array.from(headerRow.children).some(th =>
                    th.textContent.toLowerCase().includes('actions'));

                // Find and remove empty headers between Product Selection and Actions
                let productSelectionHeaderIndex = -1;
                let actionsHeaderIndex = -1;
                Array.from(headerRow.children).forEach((th, idx) => {
                    const text = th.textContent.toLowerCase().trim();
                    if (text.includes('product selection')) {
                        productSelectionHeaderIndex = idx;
                    }
                    if (text.includes('actions')) {
                        actionsHeaderIndex = idx;
                    }
                });

                // Remove empty headers between Product Selection and Actions
                if (productSelectionHeaderIndex >= 0 && actionsHeaderIndex >= 0) {
                    const headersToRemove = [];
                    for (let i = productSelectionHeaderIndex + 1; i < actionsHeaderIndex; i++) {
                        const header = headerRow.children[i];
                        if (header && (!header.textContent.trim() || header.textContent.trim().length === 0)) {
                            headersToRemove.push(header);
                        }
                    }
                    headersToRemove.forEach(header => header.remove());

                    // Update indices after removal
                    productSelectionHeaderIndex = Array.from(headerRow.children).findIndex(th =>
                        th.textContent.toLowerCase().includes('product selection'));
                    actionsHeaderIndex = Array.from(headerRow.children).findIndex(th =>
                        th.textContent.toLowerCase().includes('actions'));
                }

                // Add Product Selection and Actions headers if not present
                if (!hasProductSelection) {
                    const productSelectionHeader = document.createElement(thead && thead.querySelector('tr') === headerRow ? 'th' : 'td');
                    productSelectionHeader.textContent = 'Product Selection';
                    productSelectionHeader.style.cssText = 'background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #d4af37; padding: 14px 12px; border: 1px solid #3a6fa5; text-align: center; font-weight: 600; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;';
                    headerRow.appendChild(productSelectionHeader);
                }

                if (!hasActions) {
                    const actionsHeader = document.createElement(thead && thead.querySelector('tr') === headerRow ? 'th' : 'td');
                    actionsHeader.textContent = 'Actions';
                    actionsHeader.style.cssText = 'background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #d4af37; padding: 14px 12px; border: 1px solid #3a6fa5; text-align: center; font-weight: 600; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;';

                    // Insert Actions header right after Product Selection
                    const currentProductSelectionIndex = Array.from(headerRow.children).findIndex(th =>
                        th.textContent.toLowerCase().includes('product selection'));
                    if (currentProductSelectionIndex >= 0 && currentProductSelectionIndex < headerRow.children.length - 1) {
                        headerRow.insertBefore(actionsHeader, headerRow.children[currentProductSelectionIndex + 1]);
                    } else {
                        headerRow.appendChild(actionsHeader);
                    }
                }

                // Process data rows
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    const rows = tbody.querySelectorAll('tr');
                    let validRowIndex = 0; // Track index for valid rows only
                    rows.forEach((row, index) => {
                        // Check if row is empty - skip empty rows
                        const cells = Array.from(row.children);
                        let hasContent = false;

                        // Get header row to identify column types
                        const headerCells = headerRow ? Array.from(headerRow.children) : [];

                        // Check if row has any meaningful content
                        for (let i = 0; i < cells.length && i < headerCells.length; i++) {
                            const cell = cells[i];
                            const headerText = headerCells[i] ? headerCells[i].textContent.toLowerCase().trim() : '';

                            // Skip Product Selection and Actions cells
                            if (cell.classList.contains('product-selection-cell') ||
                                cell.classList.contains('actions-cell')) {
                                continue;
                            }

                            const cellText = cell.textContent.trim();
                            const hasImage = cell.querySelector('img');

                            // Row has content if:
                            // 1. Cell has an image
                            if (hasImage) {
                                hasContent = true;
                                break;
                            }

                            // 2. Description/Item Description column has meaningful text (more than 3 chars)
                            if ((headerText.includes('description') || headerText.includes('item')) && cellText.length > 3) {
                                hasContent = true;
                                break;
                            }

                            // 3. Quantity column has numeric value
                            if ((headerText.includes('qty') || headerText.includes('quantity')) && /[\d.,]+/.test(cellText)) {
                                hasContent = true;
                                break;
                            }

                            // 4. Amount/Total/Price column has numeric value
                            if ((headerText.includes('amount') || headerText.includes('total') || headerText.includes('price') || headerText.includes('rate')) && /[\d.,]+/.test(cellText)) {
                                hasContent = true;
                                break;
                            }

                            // 5. Serial number column has value (but only if other columns also have content)
                            if ((headerText.includes('si.no') || headerText.includes('s.')) && cellText.length > 0) {
                                // Check if other cells in this row have content
                                let otherContent = false;
                                for (let j = 0; j < cells.length; j++) {
                                    if (j !== i && cells[j].textContent.trim().length > 2) {
                                        otherContent = true;
                                        break;
                                    }
                                }
                                if (otherContent) {
                                    hasContent = true;
                                    break;
                                }
                            }
                        }

                        // Also check if row has any non-empty cell (fallback check)
                        if (!hasContent) {
                            for (let cell of cells) {
                                if (cell.classList.contains('product-selection-cell') ||
                                    cell.classList.contains('actions-cell')) {
                                    continue;
                                }
                                const cellText = cell.textContent.trim();
                                if (cellText.length > 2 || cell.querySelector('img')) {
                                    hasContent = true;
                                    break;
                                }
                            }
                        }

                        // Skip empty rows
                        if (!hasContent) {
                            row.remove(); // Remove empty row from DOM
                            return; // Skip processing this row
                        }

                        const rowId = `row_${tier}_${Date.now()}_${validRowIndex}`;
                        validRowIndex++;

                        // Style row cells with compact padding
                        Array.from(row.children).forEach((cell, idx) => {
                            // Skip if this is Product Selection or Actions cell (will be styled separately)
                            if (cell.classList.contains('product-selection-cell') || cell.classList.contains('actions-cell')) {
                                return;
                            }

                            cell.style.cssText = 'padding: 8px 6px; border: 1px solid #e2e8f0; vertical-align: middle; font-size: 0.9em;';
                            if (validRowIndex % 2 === 0) {
                                cell.style.backgroundColor = '#f8fafc';
                            } else {
                                cell.style.backgroundColor = '#ffffff';
                            }

                            // Style description cells - wrap long text
                            const cellText = cell.textContent.toLowerCase().trim();
                            const headerText = headerRow ? (headerRow.children[idx]?.textContent || '').toLowerCase() : '';
                            // Apply text wrapping to description columns (including Brand Description)
                            if (headerText.includes('description') || headerText.includes('desc') ||
                                cell.classList.contains('brand-description-cell') ||
                                (cellText.length > 50 && !cell.querySelector('img'))) {
                                cell.style.wordWrap = 'break-word';
                                cell.style.wordBreak = 'break-word';
                                cell.style.overflowWrap = 'break-word';
                                cell.style.whiteSpace = 'normal';
                                cell.style.maxWidth = '300px';
                                cell.style.minWidth = '150px';
                                cell.style.lineHeight = '1.4';
                            }

                            // Style image cells
                            if (cell.querySelector('img')) {
                                cell.style.textAlign = 'center';
                                cell.querySelectorAll('img').forEach(img => {
                                    img.style.cssText = 'max-width: 80px; max-height: 80px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;';
                                    img.onclick = function () {
                                        if (typeof showImage === 'function') {
                                            showImage(this.src);
                                        }
                                    };
                                });
                            }
                        });

                        // Find Image and Description column indices in current row
                        let imageColIndex = -1;
                        let descColIndex = -1;
                        Array.from(row.children).forEach((cell, idx) => {
                            const text = cell.textContent.toLowerCase().trim();
                            if (imageColIndex === -1 && cell.querySelector('img')) {
                                imageColIndex = idx;
                            }
                            if (descColIndex === -1 && (text.length > 20 || cell.textContent.trim().length > 50)) {
                                // Heuristic: description cells usually have more text
                                const prevHeader = headerRow ? headerRow.children[idx] : null;
                                if (prevHeader && prevHeader.textContent.toLowerCase().includes('description')) {
                                    descColIndex = idx;
                                }
                            }
                        });

                        // Add Brand Image and Brand Description cells
                        // Only for GENERATE FROM BOQ (fileInfo is not null), not for CREATE NEW BOQ
                        const hasBrandImage = Array.from(row.children).some(cell =>
                            cell.classList.contains('brand-image-cell'));
                        const hasBrandDesc = Array.from(row.children).some(cell =>
                            cell.classList.contains('brand-description-cell'));

                        // Check if Brand Image/Brand Description headers exist (only in GENERATE FROM BOQ)
                        const hasBrandImageHeader = headerRow && Array.from(headerRow.children).some(th =>
                            th.textContent.toLowerCase().includes('brand image'));
                        const hasBrandDescHeader = headerRow && Array.from(headerRow.children).some(th =>
                            th.textContent.toLowerCase().includes('brand description'));

                        // Only add Brand Image/Brand Description cells if headers exist (GENERATE FROM BOQ)
                        if (fileInfo !== null && (hasBrandImageHeader || hasBrandDescHeader) && (!hasBrandImage || !hasBrandDesc)) {
                            let insertIndex = Math.max(imageColIndex, descColIndex);
                            if (insertIndex < 0) insertIndex = row.children.length;
                            insertIndex = insertIndex + 1;

                            // Add Brand Image cell
                            if (!hasBrandImage && hasBrandImageHeader) {
                                const brandImageCell = document.createElement('td');
                                brandImageCell.className = 'brand-image-cell';
                                brandImageCell.dataset.rowId = rowId;
                                brandImageCell.style.cssText = 'padding: 8px 6px; border: 1px solid #e2e8f0; text-align: center; vertical-align: middle; background: #fff; width: 8%; min-width: 80px; max-width: 100px;';
                                if (row.children.length === insertIndex) {
                                    row.appendChild(brandImageCell);
                                } else {
                                    row.insertBefore(brandImageCell, row.children[insertIndex]);
                                }
                            } else if (hasBrandImage) {
                                // Ensure class is set even if cell exists
                                const existingCell = Array.from(row.children).find(cell =>
                                    cell.classList.contains('brand-image-cell'));
                                if (existingCell && !existingCell.classList.contains('brand-image-cell')) {
                                    existingCell.classList.add('brand-image-cell');
                                }
                            }

                            // Add Brand Description cell
                            if (!hasBrandDesc && hasBrandDescHeader) {
                                const brandDescCell = document.createElement('td');
                                brandDescCell.className = 'brand-description-cell';
                                brandDescCell.dataset.rowId = rowId;
                                brandDescCell.style.cssText = 'padding: 8px 6px; border: 1px solid #e2e8f0; vertical-align: middle; background: #fff; width: 15%; min-width: 150px; max-width: 300px; font-size: 0.85em; line-height: 1.4; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; white-space: normal;';
                                const newImageIndex = Array.from(row.children).findIndex(cell => cell.classList.contains('brand-image-cell'));
                                if (newImageIndex >= 0) {
                                    row.insertBefore(brandDescCell, row.children[newImageIndex + 1]);
                                } else {
                                    row.appendChild(brandDescCell);
                                }
                            } else if (hasBrandDesc) {
                                // Ensure class is set even if cell exists and apply text wrapping
                                const existingCell = Array.from(row.children).find(cell =>
                                    cell.classList.contains('brand-description-cell'));
                                if (existingCell) {
                                    if (!existingCell.classList.contains('brand-description-cell')) {
                                        existingCell.classList.add('brand-description-cell');
                                    }
                                    // Apply text wrapping to existing Brand Description cells
                                    existingCell.style.wordWrap = 'break-word';
                                    existingCell.style.wordBreak = 'break-word';
                                    existingCell.style.overflowWrap = 'break-word';
                                    existingCell.style.whiteSpace = 'normal';
                                    existingCell.style.maxWidth = '300px';
                                    existingCell.style.minWidth = '150px';
                                    existingCell.style.lineHeight = '1.4';
                                }
                            }
                        }

                        // Ensure column alignment: match row cells to header columns
                        // Reuse headerRow from above scope, or find it if not available
                        if (!headerRow) {
                            headerRow = table.querySelector('thead tr') || table.querySelector('tbody tr:first-child');
                        }
                        if (headerRow) {
                            const headerCells = Array.from(headerRow.children);

                            // Find Product Selection and Actions column indices from header
                            let productSelectionHeaderIndex = -1;
                            let actionsHeaderIndex = -1;
                            headerCells.forEach((th, idx) => {
                                const text = th.textContent.toLowerCase().trim();
                                if (text.includes('product selection') && productSelectionHeaderIndex === -1) {
                                    productSelectionHeaderIndex = idx;
                                }
                                if (text.includes('actions') && actionsHeaderIndex === -1) {
                                    actionsHeaderIndex = idx;
                                }
                            });

                            // Remove existing Product Selection and Actions cells to reposition them correctly
                            const existingProductSelection = row.querySelector('.product-selection-cell');
                            const existingActions = row.querySelector('.actions-cell');

                            if (existingProductSelection) {
                                existingProductSelection.remove();
                            }
                            if (existingActions) {
                                existingActions.remove();
                            }

                            // Remove any empty cells that might be between Product Selection and Actions
                            // Keep only cells up to Product Selection index (excluding Product Selection and Actions)
                            const cellsToKeep = [];
                            Array.from(row.children).forEach((cell, idx) => {
                                // Skip Product Selection and Actions cells
                                if (!cell.classList.contains('product-selection-cell') &&
                                    !cell.classList.contains('actions-cell')) {
                                    // Only keep cells before Product Selection header index
                                    if (productSelectionHeaderIndex >= 0 && idx < productSelectionHeaderIndex) {
                                        cellsToKeep.push(cell);
                                    } else if (productSelectionHeaderIndex < 0) {
                                        // If no Product Selection header, keep all non-action cells
                                        cellsToKeep.push(cell);
                                    }
                                }
                            });

                            // Clear row and rebuild with correct order
                            row.innerHTML = '';
                            cellsToKeep.forEach(cell => row.appendChild(cell));

                            // Add Product Selection cell
                            const productSelectionCell = document.createElement('td');
                            productSelectionCell.className = 'product-selection-cell';
                            productSelectionCell.dataset.rowId = rowId;
                            productSelectionCell.innerHTML = createProductSelectionDropdowns(rowId, tier);
                            productSelectionCell.style.cssText = 'padding: 8px 6px; border: 1px solid #e2e8f0; vertical-align: middle; background: #fff; width: 14%; min-width: 160px; max-width: 180px;';
                            row.appendChild(productSelectionCell);

                            // Add Actions cell immediately after Product Selection
                            const actionsCell = document.createElement('td');
                            actionsCell.className = 'actions-cell';
                            actionsCell.style.cssText = 'padding: 8px 4px; border: 1px solid #e2e8f0; text-align: center; vertical-align: middle; background: #fff; width: 6%; min-width: 85px; max-width: 100px;';
                            actionsCell.innerHTML = `
                            <div style="display: flex; gap: 4px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                                <button onclick="addRow('${rowId}', '${tier}')" title="Add row below" style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 2px 4px rgba(34,197,94,0.3); transition: all 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(34,197,94,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(34,197,94,0.3)'">+</button>
                                <button onclick="deleteRow('${rowId}', '${tier}')" title="Delete this row" style="background: linear-gradient(135deg, #f87171, #ef4444); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 2px 4px rgba(239,68,68,0.3); transition: all 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(239,68,68,0.3)'">Ã—</button>
                            </div>
                        `;
                            row.appendChild(actionsCell);
                        }

                        // Apply alternating row colors (already done in cell styling above)
                        // Ensure row height is compact
                        row.style.height = 'auto';
                        row.style.minHeight = '60px';
                    });

                    // Final pass: Apply text wrapping to ALL description cells (including Brand Description) in the table
                    // Reuse existing headerRow variable (already declared at the start of the function)
                    if (headerRow) {
                        const headerCells = Array.from(headerRow.children);

                        // Find description column indices
                        const descriptionIndices = [];
                        headerCells.forEach((th, idx) => {
                            const text = th.textContent.toLowerCase().trim();
                            if (text.includes('description') || text.includes('desc')) {
                                descriptionIndices.push(idx);
                            }
                        });

                        // Apply text wrapping to all rows
                        const allRows = tbody.querySelectorAll('tr');
                        allRows.forEach(row => {
                            const cells = Array.from(row.children);
                            cells.forEach((cell, idx) => {
                                // Apply to Brand Description cells
                                if (cell.classList.contains('brand-description-cell')) {
                                    cell.style.wordWrap = 'break-word';
                                    cell.style.wordBreak = 'break-word';
                                    cell.style.overflowWrap = 'break-word';
                                    cell.style.whiteSpace = 'normal';
                                    if (!cell.style.maxWidth || cell.style.maxWidth === '') {
                                        cell.style.maxWidth = '300px';
                                    }
                                    if (!cell.style.minWidth || cell.style.minWidth === '') {
                                        cell.style.minWidth = '150px';
                                    }
                                    cell.style.lineHeight = '1.4';
                                }
                                // Apply to regular description columns
                                else if (descriptionIndices.includes(idx)) {
                                    cell.style.wordWrap = 'break-word';
                                    cell.style.wordBreak = 'break-word';
                                    cell.style.overflowWrap = 'break-word';
                                    cell.style.whiteSpace = 'normal';
                                    if (!cell.style.maxWidth || cell.style.maxWidth === '') {
                                        cell.style.maxWidth = '300px';
                                    }
                                    if (!cell.style.minWidth || cell.style.minWidth === '') {
                                        cell.style.minWidth = '150px';
                                    }
                                    cell.style.lineHeight = '1.4';
                                }
                            });
                        });
                    }
                }

                // Store table and display
                multiBudgetTables[tier] = {
                    table: table,
                    fileInfo: fileInfo,
                    html: table.outerHTML
                };

                // Add event listeners to Qty and Price cells for automatic calculation
                // Reuse headerRow from above scope, or find it if not available
                if (!headerRow) {
                    headerRow = table.querySelector('thead tr') || table.querySelector('tbody tr:first-child');
                }
                if (headerRow) {
                    const headers = Array.from(headerRow.children);
                    const qtyIndex = headers.findIndex(th => {
                        const text = th.textContent.toLowerCase().trim();
                        return (text.includes('qty') || text.includes('quantity')) && !text.includes('unit');
                    });
                    const priceIndex = headers.findIndex(th => {
                        const text = th.textContent.toLowerCase().trim();
                        return (text.includes('price') || text.includes('rate')) &&
                            !text.includes('total') && !text.includes('unit');
                    });

                    if (qtyIndex >= 0 || priceIndex >= 0) {
                        const tbody = table.querySelector('tbody');
                        if (tbody) {
                            tbody.addEventListener('input', function (e) {
                                const cell = e.target;
                                if (cell.tagName === 'TD' && cell.contentEditable === 'true') {
                                    const row = cell.closest('tr');
                                    const cellIndex = Array.from(row.children).indexOf(cell);

                                    // Check if this is Qty or Price cell
                                    if (cellIndex === qtyIndex || cellIndex === priceIndex) {
                                        calculateRowTotal(row, headers, Array.from(row.children));
                                    }
                                }
                            });

                            tbody.addEventListener('blur', function (e) {
                                const cell = e.target;
                                if (cell.tagName === 'TD' && cell.contentEditable === 'true') {
                                    const row = cell.closest('tr');
                                    const cellIndex = Array.from(row.children).indexOf(cell);

                                    // Check if this is Qty or Price cell
                                    if (cellIndex === qtyIndex || cellIndex === priceIndex) {
                                        calculateRowTotal(row, headers, Array.from(row.children));
                                    }
                                }
                            }, true);
                        }
                    }
                }

                // Optimize column widths to fit viewport
                const optimizeColumnWidths = () => {
                    const headerRow = table.querySelector('thead tr') || table.querySelector('tbody tr');
                    if (!headerRow) return;

                    const headers = Array.from(headerRow.children);
                    const totalCols = headers.length;

                    // Define optimal column widths (percentage-based for responsiveness)
                    const colWidths = {
                        'sl.no': '3%',
                        'si.no': '3%',
                        'image': '7%',
                        'img.ref': '7%',
                        'description': '15%',
                        'item description': '15%',
                        'brand image': '7%',
                        'brand description': '12%',
                        'qty': '4%',
                        'quantity': '4%',
                        'unit': '4%',
                        'unit rate': '7%',
                        'price': '7%',
                        'amount': '7%',
                        'total': '7%',
                        'product selection': '14%',
                        'actions': '6%'
                    };

                    headers.forEach((th, idx) => {
                        const headerText = th.textContent.toLowerCase().trim();
                        let width = 'auto';

                        // Find matching width
                        for (const [key, val] of Object.entries(colWidths)) {
                            if (headerText.includes(key)) {
                                width = val;
                                break;
                            }
                        }

                        // Apply width to header and all corresponding cells
                        th.style.width = width;
                        th.style.minWidth = width;
                        th.style.maxWidth = width;

                        // Apply to all cells in this column
                        const tbody = table.querySelector('tbody');
                        if (tbody) {
                            tbody.querySelectorAll('tr').forEach(row => {
                                const cell = row.children[idx];
                                if (cell) {
                                    cell.style.width = width;
                                    cell.style.minWidth = width;
                                    cell.style.maxWidth = width;
                                    cell.style.overflow = 'hidden';
                                    cell.style.textOverflow = 'ellipsis';
                                    cell.style.whiteSpace = 'nowrap';
                                }
                            });
                        }
                    });

                    // Special handling for description columns - allow wrapping
                    headers.forEach((th, idx) => {
                        const headerText = th.textContent.toLowerCase().trim();
                        if (headerText.includes('description') && !headerText.includes('brand')) {
                            const tbody = table.querySelector('tbody');
                            if (tbody) {
                                tbody.querySelectorAll('tr').forEach(row => {
                                    const cell = row.children[idx];
                                    if (cell) {
                                        cell.style.whiteSpace = 'normal';
                                        cell.style.wordWrap = 'break-word';
                                        cell.style.maxHeight = '100px';
                                        cell.style.overflowY = 'auto';
                                    }
                                });
                            }
                        }
                    });
                };

                // Display in container
                const containerId = `${tier}TableWrapper`;
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    container.style.cssText = 'overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 400px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%;';
                    container.appendChild(table);

                    // Optimize column widths after table is added
                    setTimeout(optimizeColumnWidths, 100);
                }

                // Initialize brand dropdowns for this tier
                setTimeout(() => {
                    updateBrandDropdownsForTier(tier);
                }, 100);
            } catch (error) {
                console.error('Error in createMultiBudgetTable:', error);
                alert('Error creating multi-budget table: ' + (error.message || 'Unknown error occurred'));
            }
        }

        // Create Product Selection dropdowns (Brand â†’ Category â†’ Sub-Category â†’ Model)
        function createProductSelectionDropdowns(rowId, tier) {
            return `
                <div class="product-selection-dropdowns" data-row-id="${rowId}" style="display: flex; flex-direction: column; gap: 4px; width: 100%;">
                    <select class="brand-dropdown" data-row-id="${rowId}" data-tier="${tier}" onchange="updateCategoryDropdown('${rowId}', this.value, '${tier}')" style="width: 100%; padding: 6px 8px; border: 1.5px solid #cbd5e1; border-radius: 4px; background: white; font-size: 0.85em; color: #1a365d; font-weight: 500; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none'">
                        <option value="">ðŸ” Brand</option>
                    </select>
                    <select class="category-dropdown" data-row-id="${rowId}" style="width: 100%; padding: 6px 8px; border: 1.5px solid #cbd5e1; border-radius: 4px; background: white; font-size: 0.85em; color: #1a365d; font-weight: 500; cursor: pointer; transition: all 0.2s; display: none;" onchange="updateSubCategoryDropdown('${rowId}', this.value, '${tier}')" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none'">
                        <option value="">ðŸ“ Category</option>
                    </select>
                    <select class="subcategory-dropdown" data-row-id="${rowId}" style="width: 100%; padding: 6px 8px; border: 1.5px solid #cbd5e1; border-radius: 4px; background: white; font-size: 0.85em; color: #1a365d; font-weight: 500; cursor: pointer; transition: all 0.2s; display: none;" onchange="updateModelDropdown('${rowId}', this.value, '${tier}')" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none'">
                        <option value="">ðŸ“‚ Sub-Cat</option>
                    </select>
                    <select class="model-dropdown" data-row-id="${rowId}" style="width: 100%; padding: 6px 8px; border: 1.5px solid #cbd5e1; border-radius: 4px; background: white; font-size: 0.85em; color: #1a365d; font-weight: 500; cursor: pointer; transition: all 0.2s; display: none;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 2px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none'">
                        <option value="">ðŸŽ¯ Model</option>
                    </select>
                </div>
            `;
        }

        // Update brand dropdowns for all rows in a tier
        async function updateBrandDropdownsForTier(tier) {
            try {
                const response = await fetch(`/api/brands/list?tier=${tier}`);
                const result = await response.json();

                if (result.success) {
                    const brandOptions = result.brands.map(b =>
                        `<option value="${b.name}">${b.name}</option>`
                    ).join('');

                    // Update all brand dropdowns for this tier
                    const brandDropdowns = document.querySelectorAll(`.brand-dropdown[data-tier="${tier}"]`);
                    console.log(`Found ${brandDropdowns.length} brand dropdowns for tier ${tier}`);
                    brandDropdowns.forEach(dropdown => {
                        dropdown.innerHTML = '<option value="">ðŸ” Brand</option>' + brandOptions;
                    });

                    if (brandDropdowns.length === 0) {
                        console.warn(`No brand dropdowns found for tier ${tier}. Table may not be initialized yet.`);
                    }
                }
            } catch (error) {
                console.error('Error updating brand dropdowns:', error);
            }
        }

        // Update category dropdown when brand is selected
        async function updateCategoryDropdown(rowId, brandName, tier) {
            // Find dropdowns using the closest product-selection-dropdowns container
            const dropdownContainer = document.querySelector(`.product-selection-dropdowns[data-row-id="${rowId}"]`);
            if (!dropdownContainer) {
                console.error('Dropdown container not found for rowId:', rowId);
                return;
            }

            const categoryDropdown = dropdownContainer.querySelector('.category-dropdown');
            const subcategoryDropdown = dropdownContainer.querySelector('.subcategory-dropdown');
            const modelDropdown = dropdownContainer.querySelector('.model-dropdown');

            // Clear Image and Description when brand changes (Brand Image/Brand Description for GENERATE FROM BOQ, regular Image/Description for CREATE NEW BOQ)
            const row = dropdownContainer.closest('tr');
            if (row) {
                const table = row.closest('table');
                const headerRow = table?.querySelector('thead tr') || table?.querySelector('tbody tr:first-child');

                if (headerRow) {
                    const headers = Array.from(headerRow.children);
                    const hasBrandImageHeader = headers.some(th => th.textContent.toLowerCase().includes('brand image'));
                    const hasBrandDescHeader = headers.some(th => th.textContent.toLowerCase().includes('brand description'));

                    if (hasBrandImageHeader || hasBrandDescHeader) {
                        // GENERATE FROM BOQ: Clear Brand Image and Brand Description
                        const brandImageCell = row.querySelector('.brand-image-cell');
                        const brandDescCell = row.querySelector('.brand-description-cell');
                        if (brandImageCell) brandImageCell.innerHTML = '';
                        if (brandDescCell) brandDescCell.innerHTML = '';
                    } else {
                        // CREATE NEW BOQ: Clear regular Image and Description
                        const imageIndex = headers.findIndex(th => {
                            const text = th.textContent.toLowerCase().trim();
                            return (text.includes('image') || text.includes('img')) && !text.includes('brand');
                        });
                        const descIndex = headers.findIndex(th => {
                            const text = th.textContent.toLowerCase().trim();
                            return (text.includes('description') || text.includes('desc')) && !text.includes('brand');
                        });
                        const cells = Array.from(row.children);
                        if (imageIndex >= 0 && imageIndex < cells.length) {
                            cells[imageIndex].innerHTML = '';
                        }
                        if (descIndex >= 0 && descIndex < cells.length) {
                            cells[descIndex].innerHTML = '';
                        }
                    }
                }
            }

            if (!brandName) {
                if (categoryDropdown) {
                    categoryDropdown.innerHTML = '<option value="">Select Category</option>';
                    categoryDropdown.style.display = 'none';
                }
                if (subcategoryDropdown) {
                    subcategoryDropdown.innerHTML = '<option value="">Select Sub-Category</option>';
                    subcategoryDropdown.style.display = 'none';
                }
                if (modelDropdown) {
                    modelDropdown.innerHTML = '<option value="">Select Model</option>';
                    modelDropdown.style.display = 'none';
                }
                return;
            }

            try {
                // Clear dropdown first to remove any old/cached options
                if (categoryDropdown) {
                    categoryDropdown.innerHTML = '<option value="">Select Category</option>';
                    categoryDropdown.style.display = 'block';
                }

                // Fetch categories dynamically from API - NO hardcoded categories
                const response = await fetch(`/api/brands/categories?tier=${tier}&brand=${encodeURIComponent(brandName)}`);
                const result = await response.json();

                if (result.success && result.categories && Array.isArray(result.categories) && result.categories.length > 0) {
                    if (categoryDropdown) {
                        // Clear and populate with all API categories
                        categoryDropdown.innerHTML = '<option value="">ðŸ“ Category</option>';
                        result.categories.forEach(cat => {
                            if (cat && typeof cat === 'string') {
                                const option = document.createElement('option');
                                option.value = cat;
                                option.textContent = cat;
                                categoryDropdown.appendChild(option);
                            }
                        });
                        categoryDropdown.style.display = 'block';
                    }
                } else {
                    // No categories found - show empty dropdown
                    if (categoryDropdown) {
                        categoryDropdown.innerHTML = '<option value="">No categories available</option>';
                        categoryDropdown.style.display = 'block';
                    }
                }

                // Hide and reset subcategory and model dropdowns
                if (subcategoryDropdown) {
                    subcategoryDropdown.innerHTML = '<option value="">Select Sub-Category</option>';
                    subcategoryDropdown.style.display = 'none';
                }
                if (modelDropdown) {
                    modelDropdown.innerHTML = '<option value="">Select Model</option>';
                    modelDropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating category dropdown:', error);
                if (categoryDropdown) {
                    categoryDropdown.innerHTML = '<option value="">Error loading categories</option>';
                    categoryDropdown.style.display = 'block';
                }
            }
        }

        // Update subcategory dropdown when category is selected
        async function updateSubCategoryDropdown(rowId, category, tier) {
            // Find dropdowns using the closest product-selection-dropdowns container
            const dropdownContainer = document.querySelector(`.product-selection-dropdowns[data-row-id="${rowId}"]`);
            if (!dropdownContainer) {
                console.error('Dropdown container not found for rowId:', rowId);
                return;
            }

            const brandDropdown = dropdownContainer.querySelector('.brand-dropdown');
            const subcategoryDropdown = dropdownContainer.querySelector('.subcategory-dropdown');
            const modelDropdown = dropdownContainer.querySelector('.model-dropdown');

            // Clear Image and Description when category changes (Brand Image/Brand Description for GENERATE FROM BOQ, regular Image/Description for CREATE NEW BOQ)
            const row = dropdownContainer.closest('tr');
            if (row) {
                const table = row.closest('table');
                const headerRow = table?.querySelector('thead tr') || table?.querySelector('tbody tr:first-child');

                if (headerRow) {
                    const headers = Array.from(headerRow.children);
                    const hasBrandImageHeader = headers.some(th => th.textContent.toLowerCase().includes('brand image'));
                    const hasBrandDescHeader = headers.some(th => th.textContent.toLowerCase().includes('brand description'));

                    if (hasBrandImageHeader || hasBrandDescHeader) {
                        // GENERATE FROM BOQ: Clear Brand Image and Brand Description
                        const brandImageCell = row.querySelector('.brand-image-cell');
                        const brandDescCell = row.querySelector('.brand-description-cell');
                        if (brandImageCell) brandImageCell.innerHTML = '';
                        if (brandDescCell) brandDescCell.innerHTML = '';
                    } else {
                        // CREATE NEW BOQ: Clear regular Image and Description
                        const imageIndex = headers.findIndex(th => {
                            const text = th.textContent.toLowerCase().trim();
                            return (text.includes('image') || text.includes('img')) && !text.includes('brand');
                        });
                        const descIndex = headers.findIndex(th => {
                            const text = th.textContent.toLowerCase().trim();
                            return (text.includes('description') || text.includes('desc')) && !text.includes('brand');
                        });
                        const cells = Array.from(row.children);
                        if (imageIndex >= 0 && imageIndex < cells.length) {
                            cells[imageIndex].innerHTML = '';
                        }
                        if (descIndex >= 0 && descIndex < cells.length) {
                            cells[descIndex].innerHTML = '';
                        }
                    }
                }
            }

            if (!category) {
                if (subcategoryDropdown) {
                    subcategoryDropdown.style.display = 'none';
                }
                if (modelDropdown) {
                    modelDropdown.style.display = 'none';
                }
                return;
            }

            const brandName = brandDropdown ? brandDropdown.value : '';
            if (!brandName) {
                console.warn('Brand not selected for rowId:', rowId);
                return;
            }

            try {
                const response = await fetch(`/api/brands/subcategories?tier=${tier}&brand=${encodeURIComponent(brandName)}&category=${encodeURIComponent(category)}`);
                const result = await response.json();

                if (result.success && result.subcategories && result.subcategories.length > 0) {
                    if (subcategoryDropdown) {
                        subcategoryDropdown.innerHTML = '<option value="">Select Sub-Category</option>' +
                            result.subcategories.map(s => `<option value="${s}">${s}</option>`).join('');
                        subcategoryDropdown.style.display = 'block';
                    }

                    // Hide model dropdown
                    if (modelDropdown) {
                        modelDropdown.style.display = 'none';
                    }
                } else {
                    // No subcategories, show model dropdown directly
                    if (subcategoryDropdown) {
                        subcategoryDropdown.style.display = 'none';
                    }
                    updateModelDropdown(rowId, '', tier);
                }
            } catch (error) {
                console.error('Error updating subcategory dropdown:', error);
            }
        }

        // Update model dropdown when subcategory is selected
        async function updateModelDropdown(rowId, subcategory, tier) {
            // Find dropdowns using the closest product-selection-dropdowns container
            const dropdownContainer = document.querySelector(`.product-selection-dropdowns[data-row-id="${rowId}"]`);
            if (!dropdownContainer) {
                console.error('Dropdown container not found for rowId:', rowId);
                return;
            }

            const brandDropdown = dropdownContainer.querySelector('.brand-dropdown');
            const categoryDropdown = dropdownContainer.querySelector('.category-dropdown');
            const subcategoryDropdown = dropdownContainer.querySelector('.subcategory-dropdown');

            const brandName = brandDropdown ? brandDropdown.value : '';
            const category = categoryDropdown ? categoryDropdown.value : '';
            const finalSubcategory = subcategory || (subcategoryDropdown ? subcategoryDropdown.value : '');

            if (!brandName || !category) {
                console.warn('Brand or category not selected for rowId:', rowId);
                return;
            }

            try {
                const url = `/api/brands/models?tier=${tier}&brand=${encodeURIComponent(brandName)}&category=${encodeURIComponent(category)}${finalSubcategory ? '&subcategory=' + encodeURIComponent(finalSubcategory) : ''}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const modelDropdown = dropdownContainer.querySelector('.model-dropdown');
                    if (modelDropdown) {
                        modelDropdown.innerHTML = '<option value="">Select Model</option>' +
                            result.models.map(m => {
                                const imageUrl = m.image_url || '';
                                const description = m.description || '';
                                const price = m.price || '';
                                return `<option value="${m.model}" data-price="${price}" data-image="${imageUrl}" data-description="${description}">${m.model} ${m.price_range ? '(' + m.price_range + ')' : ''}</option>`;
                            }).join('');
                        modelDropdown.style.display = 'block';

                        // Add change handler to populate Image and Description columns
                        // For GENERATE FROM BOQ: populates Brand Image and Brand Description
                        // For CREATE NEW BOQ: populates regular Image and Description
                        modelDropdown.onchange = function () {
                            const selectedOption = this.options[this.selectedIndex];

                            // Find the row containing this dropdown - try multiple methods
                            let row = dropdownContainer.closest('tr');
                            if (!row) {
                                // Fallback: find by row ID
                                const rowIdAttr = dropdownContainer.getAttribute('data-row-id');
                                if (rowIdAttr) {
                                    row = document.querySelector(`tr:has([data-row-id="${rowIdAttr}"])`) ||
                                        document.querySelector(`tr [data-row-id="${rowIdAttr}"]`)?.closest('tr');
                                }
                            }

                            if (!row) {
                                console.error('Row not found for dropdown container:', dropdownContainer);
                                console.error('RowId:', rowId);
                                return;
                            }

                            // Get header row to determine table type
                            const table = row.closest('table');
                            const headerRow = table?.querySelector('thead tr') ||
                                table?.querySelector('tbody tr:first-child');

                            if (!headerRow) {
                                console.error('Header row not found');
                                return;
                            }

                            const headers = Array.from(headerRow.children);
                            const cells = Array.from(row.children);

                            // Check if this is GENERATE FROM BOQ (has Brand Image/Brand Description headers)
                            const hasBrandImageHeader = headers.some(th =>
                                th.textContent.toLowerCase().includes('brand image'));
                            const hasBrandDescHeader = headers.some(th =>
                                th.textContent.toLowerCase().includes('brand description'));

                            // Determine which cells to populate
                            let imageCell = null;
                            let descCell = null;

                            if (hasBrandImageHeader || hasBrandDescHeader) {
                                // GENERATE FROM BOQ: Use Brand Image and Brand Description
                                let brandImageCell = row.querySelector('.brand-image-cell');
                                let brandDescCell = row.querySelector('.brand-description-cell');

                                // Find by header index if not found by class
                                if (!brandImageCell && hasBrandImageHeader) {
                                    const brandImageIndex = headers.findIndex(th =>
                                        th.textContent.toLowerCase().includes('brand image'));
                                    if (brandImageIndex >= 0 && brandImageIndex < cells.length) {
                                        brandImageCell = cells[brandImageIndex];
                                    }
                                }

                                if (!brandDescCell && hasBrandDescHeader) {
                                    const brandDescIndex = headers.findIndex(th =>
                                        th.textContent.toLowerCase().includes('brand description'));
                                    if (brandDescIndex >= 0 && brandDescIndex < cells.length) {
                                        brandDescCell = cells[brandDescIndex];
                                    }
                                }

                                imageCell = brandImageCell;
                                descCell = brandDescCell;
                            } else {
                                // CREATE NEW BOQ: Use regular Image and Description columns
                                const imageIndex = headers.findIndex(th => {
                                    const text = th.textContent.toLowerCase().trim();
                                    return (text.includes('image') || text.includes('img')) &&
                                        !text.includes('brand');
                                });

                                const descIndex = headers.findIndex(th => {
                                    const text = th.textContent.toLowerCase().trim();
                                    return (text.includes('description') || text.includes('desc')) &&
                                        !text.includes('brand');
                                });

                                if (imageIndex >= 0 && imageIndex < cells.length) {
                                    imageCell = cells[imageIndex];
                                }

                                if (descIndex >= 0 && descIndex < cells.length) {
                                    descCell = cells[descIndex];
                                }
                            }

                            if (selectedOption && selectedOption.value) {
                                const price = selectedOption.dataset.price || '';
                                const imageUrl = selectedOption.dataset.image || '';
                                const description = selectedOption.dataset.description || '';

                                // Update Image cell (Brand Image for GENERATE FROM BOQ, regular Image for CREATE NEW BOQ)
                                if (imageCell) {
                                    if (imageUrl) {
                                        // Escape imageUrl for use in onclick
                                        const escapedImageUrl = imageUrl.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                        imageCell.innerHTML = `<img src="${escapedImageUrl}" alt="${selectedOption.value.replace(/"/g, '&quot;')}" style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;" onclick="if(typeof showImage==='function')showImage('${escapedImageUrl.replace(/'/g, "\\'")}')" />`;
                                    } else {
                                        if (hasBrandImageHeader) {
                                            imageCell.innerHTML = '<span style="color: #999; font-size: 0.85em;">No image</span>';
                                        } else {
                                            imageCell.innerHTML = '';
                                        }
                                    }
                                    // Add class if missing (for Brand Image only)
                                    if (hasBrandImageHeader && !imageCell.classList.contains('brand-image-cell')) {
                                        imageCell.classList.add('brand-image-cell');
                                    }
                                }

                                // Update Description cell (Brand Description for GENERATE FROM BOQ, regular Description for CREATE NEW BOQ)
                                if (descCell) {
                                    if (description) {
                                        // Escape description for HTML
                                        const escapedDesc = description.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                        descCell.innerHTML = escapedDesc;
                                        // Make sure it's editable for CREATE NEW BOQ
                                        if (!hasBrandDescHeader) {
                                            descCell.contentEditable = 'true';
                                        }
                                    } else {
                                        if (hasBrandDescHeader) {
                                            descCell.innerHTML = '<span style="color: #999; font-size: 0.85em;">No description</span>';
                                        } else {
                                            descCell.innerHTML = '';
                                        }
                                    }
                                    // Add class if missing (for Brand Description only)
                                    if (hasBrandDescHeader && !descCell.classList.contains('brand-description-cell')) {
                                        descCell.classList.add('brand-description-cell');
                                    }
                                }

                                // Find and update Price cell
                                const priceIndex = headers.findIndex(th => {
                                    const text = th.textContent.toLowerCase().trim();
                                    return (text.includes('price') || text.includes('rate')) &&
                                        !text.includes('total') && !text.includes('unit');
                                });

                                if (priceIndex >= 0 && priceIndex < cells.length) {
                                    const priceCell = cells[priceIndex];
                                    if (price && price !== 'null' && price !== '') {
                                        const priceValue = parseFloat(price);
                                        if (!isNaN(priceValue)) {
                                            priceCell.textContent = priceValue.toFixed(2);
                                            priceCell.contentEditable = 'true';
                                        } else {
                                            priceCell.textContent = '';
                                        }
                                    } else {
                                        priceCell.textContent = '';
                                    }
                                    // Trigger calculation
                                    calculateRowTotal(row, headers, cells);
                                }

                            } else {
                                // Clear Image and Description if no model selected
                                if (imageCell) {
                                    // For CREATE NEW BOQ, just clear (don't add "No image" placeholder)
                                    if (!hasBrandImageHeader) {
                                        imageCell.innerHTML = '';
                                    } else {
                                        imageCell.innerHTML = '';
                                    }
                                }
                                if (descCell) {
                                    // For CREATE NEW BOQ, just clear (don't add "No description" placeholder)
                                    if (!hasBrandDescHeader) {
                                        descCell.innerHTML = '';
                                    } else {
                                        descCell.innerHTML = '';
                                    }
                                }

                                // Clear Price cell if no model selected
                                const priceIndex = headers.findIndex(th => {
                                    const text = th.textContent.toLowerCase().trim();
                                    return (text.includes('price') || text.includes('rate')) &&
                                        !text.includes('total') && !text.includes('unit');
                                });

                                if (priceIndex >= 0 && priceIndex < cells.length) {
                                    const priceCell = cells[priceIndex];
                                    priceCell.textContent = '';
                                    // Trigger calculation to clear total
                                    calculateRowTotal(row, headers, cells);
                                }
                            }
                        };
                    }
                } else {
                    console.error('Failed to fetch models:', result.error);
                }
            } catch (error) {
                console.error('Error updating model dropdown:', error);
            }
        }

        // Calculate row total: Qty * Price = Total
        function calculateRowTotal(row, headers, cells) {
            if (!row || !headers || !cells) {
                // Try to get from row if not provided
                if (row) {
                    const table = row.closest('table');
                    const headerRow = table?.querySelector('thead tr') || table?.querySelector('tbody tr:first-child');
                    if (headerRow) {
                        headers = Array.from(headerRow.children);
                        cells = Array.from(row.children);
                    } else {
                        return;
                    }
                } else {
                    return;
                }
            }

            // Find Qty, Price, and Total column indices
            const qtyIndex = headers.findIndex(th => {
                const text = th.textContent.toLowerCase().trim();
                return (text.includes('qty') || text.includes('quantity')) && !text.includes('unit');
            });

            const priceIndex = headers.findIndex(th => {
                const text = th.textContent.toLowerCase().trim();
                return (text.includes('price') || text.includes('rate')) &&
                    !text.includes('total') && !text.includes('unit');
            });

            const totalIndex = headers.findIndex(th => {
                const text = th.textContent.toLowerCase().trim();
                return text.includes('total') || text.includes('amount');
            });

            // Get values
            let qty = 0;
            let price = 0;

            if (qtyIndex >= 0 && qtyIndex < cells.length) {
                const qtyText = cells[qtyIndex].textContent.trim().replace(/[^0-9.-]/g, '');
                qty = parseFloat(qtyText) || 0;
            }

            if (priceIndex >= 0 && priceIndex < cells.length) {
                const priceText = cells[priceIndex].textContent.trim().replace(/[^0-9.-]/g, '');
                price = parseFloat(priceText) || 0;
            }

            // Calculate and update Total
            if (totalIndex >= 0 && totalIndex < cells.length) {
                const totalCell = cells[totalIndex];
                const total = qty * price;
                totalCell.textContent = total.toFixed(2);
                totalCell.contentEditable = 'true';
            }
        }

        // Make calculateRowTotal globally accessible
        window.calculateRowTotal = calculateRowTotal;

        // Add row function - Simply clone existing row structure and clear content
        function addRow(rowId, tier) {
            const table = multiBudgetTables[tier]?.table;
            if (!table) return;

            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            const row = document.querySelector(`tr:has([data-row-id="${rowId}"])`) ||
                document.querySelector(`[data-row-id="${rowId}"]`)?.closest('tr');

            if (!row) return;

            const newRowId = `row_${tier}_${Date.now()}_${Math.random()}`;

            // Clone the entire row structure
            const newRow = row.cloneNode(true);

            // Update all rowId references
            newRow.querySelectorAll('[data-row-id]').forEach(el => {
                el.dataset.rowId = newRowId;
            });

            // Get header row for column matching
            const headerRow = table.querySelector('thead tr') || table.querySelector('tbody tr:first-child');

            // Clear all cells and reset dropdowns
            Array.from(newRow.children).forEach((cell, idx) => {
                // Check if this is a description column (to preserve text wrapping)
                const isDescriptionColumn = headerRow && headerRow.children[idx] &&
                    (headerRow.children[idx].textContent.toLowerCase().includes('description') ||
                        headerRow.children[idx].textContent.toLowerCase().includes('desc'));

                // Handle Product Selection cell
                if (cell.classList.contains('product-selection-cell')) {
                    // Reset Product Selection dropdowns with new rowId
                    cell.innerHTML = createProductSelectionDropdowns(newRowId, tier);
                    return;
                }

                // Handle Actions cell
                if (cell.classList.contains('actions-cell')) {
                    // Update Actions buttons with new rowId
                    cell.innerHTML = `
                        <div style="display: flex; gap: 4px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                            <button onclick="addRow('${newRowId}', '${tier}')" title="Add row below" style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 2px 4px rgba(34,197,94,0.3); transition: all 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(34,197,94,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(34,197,94,0.3)'">+</button>
                            <button onclick="deleteRow('${newRowId}', '${tier}')" title="Delete this row" style="background: linear-gradient(135deg, #f87171, #ef4444); color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 0 2px 4px rgba(239,68,68,0.3); transition: all 0.2s; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(239,68,68,0.3)'">Ã—</button>
                        </div>
                    `;
                    return;
                }

                // Handle Brand Image cell - clear content
                if (cell.classList.contains('brand-image-cell')) {
                    cell.innerHTML = '';
                    return;
                }

                // Handle Brand Description cell - clear and apply text wrapping
                if (cell.classList.contains('brand-description-cell')) {
                    cell.innerHTML = '';
                    cell.style.wordWrap = 'break-word';
                    cell.style.wordBreak = 'break-word';
                    cell.style.overflowWrap = 'break-word';
                    cell.style.whiteSpace = 'normal';
                    cell.style.maxWidth = '300px';
                    cell.style.minWidth = '150px';
                    cell.style.lineHeight = '1.4';
                    return;
                }

                // Clear regular data cells - preserve structure and styles
                // Remove images if present
                if (cell.querySelector('img')) {
                    cell.innerHTML = '';
                } else {
                    // Clear text content only (preserves cell structure)
                    cell.textContent = '';
                }

                // Apply text wrapping to description columns (Item Description, etc.)
                if (isDescriptionColumn) {
                    cell.style.wordWrap = 'break-word';
                    cell.style.wordBreak = 'break-word';
                    cell.style.overflowWrap = 'break-word';
                    cell.style.whiteSpace = 'normal';
                    if (!cell.style.maxWidth || cell.style.maxWidth === '') {
                        cell.style.maxWidth = '300px';
                    }
                    if (!cell.style.minWidth || cell.style.minWidth === '') {
                        cell.style.minWidth = '150px';
                    }
                    cell.style.lineHeight = '1.4';
                }
            });

            // Clear SI.No - will be set by updateSiNos
            const siNoCell = newRow.cells[0];
            if (siNoCell) {
                siNoCell.textContent = '';
            }

            // Insert after current row
            row.parentNode.insertBefore(newRow, row.nextSibling);

            // Reinitialize brand dropdowns for the new row
            setTimeout(() => {
                updateBrandDropdownsForTier(tier);
            }, 50);

            // Update all SI.Nos
            updateSiNos(tbody);
        }

        // Delete row function
        function deleteRow(rowId, tier) {
            if (!confirm('Are you sure you want to delete this row?')) return;

            const table = multiBudgetTables[tier]?.table;
            if (!table) return;

            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            const row = document.querySelector(`tr:has([data-row-id="${rowId}"])`) ||
                document.querySelector(`[data-row-id="${rowId}"]`)?.closest('tr');

            if (row) {
                row.remove();
                updateSiNos(tbody);
            }
        }

        // Update SI.No sequence
        function updateSiNos(tbody) {
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const siNoCell = row.cells[0];
                if (siNoCell) {
                    siNoCell.textContent = index + 1;
                }
            });
        }

        // Export multi-budget tables (excludes Product Selection and Actions columns)
        async function exportMultiBudget(type, format) {
            const table = multiBudgetTables[currentBudgetTier]?.table;
            if (!table) {
                alert('No table data to export. Please generate a table first.');
                return;
            }

            try {
                // Clone table HTML and send to backend for filtering
                const tableHTML = table.outerHTML;

                // Store table in backend (backend will filter out Product Selection and Actions columns)
                const storeResponse = await fetch('/api/multibudget/store-table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tier: currentBudgetTier,
                        table_html: tableHTML
                    })
                });

                const storeResult = await storeResponse.json();

                if (!storeResult.success) {
                    alert('Error preparing export: ' + storeResult.error);
                    return;
                }

                // Export using filtered table
                const exportResponse = await fetch(`/api/multibudget/export/${currentBudgetTier}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        format: format
                    })
                });

                if (exportResponse.ok) {
                    // Download file
                    const blob = await exportResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${type}_${currentBudgetTier}.${format === 'excel' ? 'xlsx' : format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await exportResponse.json();
                    alert('Export error: ' + (error.error || 'Failed to export'));
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting: ' + error.message);
            }
        }

        // Make dropdown functions globally accessible
        window.updateCategoryDropdown = updateCategoryDropdown;
        window.updateSubCategoryDropdown = updateSubCategoryDropdown;
        window.updateModelDropdown = updateModelDropdown;

        // Initialize brand dropdowns when multi-budget card is shown
        const originalShowMainApp = window.showMainApp;
        if (originalShowMainApp) {
            window.showMainApp = function (workflowType) {
                originalShowMainApp(workflowType);
                if (workflowType === 'multi-budget') {
                    // Initialize brand dropdowns for current tier
                    setTimeout(() => {
                        updateBrandDropdownsForTier(currentBudgetTier);
                    }, 500);
                }
            };
        }
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.padding = '15px 20px';
            alertDiv.style.borderRadius = '8px';
            alertDiv.style.color = 'white';
            alertDiv.style.fontWeight = 'bold';
            alertDiv.style.zIndex = '10001';
            alertDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';
            alertDiv.style.transition = 'opacity 0.5s';

            if (type === 'error') {
                alertDiv.style.backgroundColor = '#ef4444';
            } else if (type === 'success') {
                alertDiv.style.backgroundColor = '#10b981';
            } else {
                alertDiv.style.backgroundColor = '#3b82f6';
            }

            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 500);
            }, 3000);
        }

        // Image modal functionality for click-to-enlarge
        function openImageModal(imageSrc) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.className = 'image-modal';
                modal.innerHTML = `
                    <div class="image-modal-content">
                        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
                        <img id="modalImage" class="image-modal-img" src="" alt="Full size image">
                        <div class="image-modal-caption">
                            <button class="btn btn-sm btn-primary" onclick="downloadModalImage()">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Set image source and show modal
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageSrc;
            modal.style.display = 'flex';
            
            // Close on click outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeImageModal();
                }
            };
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function downloadModalImage() {
            const modalImg = document.getElementById('modalImage');
            if (modalImg && modalImg.src) {
                const link = document.createElement('a');
                link.href = modalImg.src;
                link.download = modalImg.src.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });

        // ============================================
        // Zero-Costing Document Generation Functions
        // ============================================

        /**
         * Apply zero costing and execute callback with progress tracking
         */
        async function applyZeroCostingAndExecute(fileId, actionName, callback) {
            let popup = null;
            try {
                // Show progress popup
                popup = showProgressPopup(`Preparing ${actionName}...`);
                updateProgressPopup(10, `Preparing ${actionName}...`);
                
                // Get table data from DOM
                const table = document.getElementById(`table-${fileId}`);
                if (!table) {
                    throw new Error('Table not found');
                }
                
                updateProgressPopup(20, 'Extracting table data...');
                const tableData = extractTableData(table);
                
                // Apply zero costing factors
                updateProgressPopup(40, 'Applying costing factors...');
                const response = await fetch(`/apply-zero-costing/${fileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_data: tableData })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to apply zero costing');
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to apply zero costing');
                }
                
                // Execute the callback function
                updateProgressPopup(60, `Generating ${actionName}...`);
                await callback(fileId);
                
                updateProgressPopup(100, `${actionName} completed!`);
                setTimeout(() => {
                    closeProgressPopup();
                    showAlert(`âœ… ${actionName} generated successfully!`, 'success');
                }, 800);
                
            } catch (error) {
                console.error(`Error in ${actionName}:`, error);
                closeProgressPopup();
                showAlert(`âŒ Failed to generate ${actionName}: ${error.message}`, 'error');
            }
        }

        /**
         * Extract table data from DOM for costing
         */
        function extractTableData(table) {
            const headers = [];
            const rows = [];
            
            // Extract headers
            const headerRow = table.rows[0];
            for (let i = 0; i < headerRow.cells.length; i++) {
                const cell = headerRow.cells[i];
                if (!cell.classList.contains('action-column-header')) {
                    headers.push(cell.textContent.trim());
                }
            }
            
            // Extract rows
            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = {};
                let colIndex = 0;
                
                for (let j = 0; j < row.cells.length; j++) {
                    const cell = row.cells[j];
                    if (!cell.classList.contains('action-column-cell')) {
                        // Check if cell contains an image
                        const img = cell.querySelector('img');
                        if (img && img.src) {
                            // Store cell HTML with image tag so presentation generator can extract it
                            rowData[headers[colIndex]] = cell.innerHTML;
                        } else {
                            // Just store text for non-image cells
                            rowData[headers[colIndex]] = cell.textContent.trim();
                        }
                        
                        colIndex++;
                    }
                }
                rows.push(rowData);
            }
            
            return { headers, rows };
        }

        /**
         * Generate and download Offer PDF
         */
        async function generateOfferPDF(fileId) {
            await applyZeroCostingAndExecute(fileId, 'Offer PDF', async (fId) => {
                const response = await fetch(`/generate-offer/${fId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate offer PDF');
                }
                
                const result = await response.json();
                if (result.success && result.file_path) {
                    showAlert('âœ… Offer PDF generated successfully!', 'success');
                    // Trigger download instead of opening in browser
                    const link = document.createElement('a');
                    link.href = result.file_path;
                    link.download = result.file_path.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    throw new Error(result.error || 'Failed to generate offer PDF');
                }
            });
        }

        /**
         * Generate and download Offer Excel
         */
        async function generateOfferExcel(fileId) {
            await applyZeroCostingAndExecute(fileId, 'Offer Excel', async (fId) => {
                // Download costed table as Excel
                window.open(`/download/costed/${fId}`, '_blank');
                showAlert('âœ… Offer Excel downloaded successfully!', 'success');
            });
        }

        /**
         * Generate Presentation (PPTX)
         */
        async function generatePresentationPPTX(fileId) {
            await applyZeroCostingAndExecute(fileId, 'Presentation', async (fId) => {
                const response = await fetch(`/generate-presentation/${fId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ format: 'pptx' })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate presentation');
                }
                
                const result = await response.json();
                if (result.success && result.file_path) {
                    showAlert('âœ… Presentation generated successfully!', 'success');
                    // Trigger download
                    const link = document.createElement('a');
                    link.href = result.file_path;
                    link.download = result.file_path.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    throw new Error(result.error || 'Failed to generate presentation');
                }
            });
        }

        /**
         * Generate Presentation PDF
         */
        async function generatePresentationPDF(fileId) {
            await applyZeroCostingAndExecute(fileId, 'Presentation PDF', async (fId) => {
                const response = await fetch(`/generate-presentation/${fId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ format: 'pdf' })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate presentation PDF');
                }
                
                const result = await response.json();
                if (result.success && result.file_path) {
                    showAlert('âœ… Presentation PDF generated successfully!', 'success');
                    // Trigger download
                    const link = document.createElement('a');
                    link.href = result.file_path;
                    link.download = result.file_path.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    throw new Error(result.error || 'Failed to generate presentation PDF');
                }
            });
        }

        /**
         * Generate MAS document
         */
        async function generateMAS(fileId) {
            await applyZeroCostingAndExecute(fileId, 'MAS', async (fId) => {
                const response = await fetch(`/generate-mas/${fId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate MAS');
                }
                
                const result = await response.json();
                if (result.success && result.file_path) {
                    showAlert('âœ… MAS generated successfully!', 'success');
                    // Trigger download
                    const link = document.createElement('a');
                    link.href = result.file_path;
                    link.download = result.file_path.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    throw new Error(result.error || 'Failed to generate MAS');
                }
            });
        }
    </script>
</body>

</html>